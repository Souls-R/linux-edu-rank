<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by University of Virginia, Charlottesville</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by University of Virginia, Charlottesville</h1>
    <div class="pagination">
        <a href='3_45.html'>&lt;&lt;Prev</a><a href='3.html'>1</a><a href='3_2.html'>2</a><a href='3_3.html'>3</a><a href='3_4.html'>4</a><a href='3_5.html'>5</a><a href='3_6.html'>6</a><a href='3_7.html'>7</a><a href='3_8.html'>8</a><a href='3_9.html'>9</a><a href='3_10.html'>10</a><a href='3_11.html'>11</a><a href='3_12.html'>12</a><a href='3_13.html'>13</a><a href='3_14.html'>14</a><a href='3_15.html'>15</a><a href='3_16.html'>16</a><a href='3_17.html'>17</a><a href='3_18.html'>18</a><a href='3_19.html'>19</a><a href='3_20.html'>20</a><a href='3_21.html'>21</a><a href='3_22.html'>22</a><a href='3_23.html'>23</a><a href='3_24.html'>24</a><a href='3_25.html'>25</a><a href='3_26.html'>26</a><a href='3_27.html'>27</a><a href='3_28.html'>28</a><a href='3_29.html'>29</a><a href='3_30.html'>30</a><a href='3_31.html'>31</a><a href='3_32.html'>32</a><a href='3_33.html'>33</a><a href='3_34.html'>34</a><a href='3_35.html'>35</a><a href='3_36.html'>36</a><a href='3_37.html'>37</a><a href='3_38.html'>38</a><a href='3_39.html'>39</a><a href='3_40.html'>40</a><a href='3_41.html'>41</a><a href='3_42.html'>42</a><a href='3_43.html'>43</a><a href='3_44.html'>44</a><a href='3_45.html'>45</a><span>[46]</span><a href='3_47.html'>47</a><a href='3_48.html'>48</a><a href='3_49.html'>49</a><a href='3_50.html'>50</a><a href='3_51.html'>51</a><a href='3_52.html'>52</a><a href='3_53.html'>53</a><a href='3_54.html'>54</a><a href='3_55.html'>55</a><a href='3_56.html'>56</a><a href='3_57.html'>57</a><a href='3_58.html'>58</a><a href='3_59.html'>59</a><a href='3_60.html'>60</a><a href='3_61.html'>61</a><a href='3_62.html'>62</a><a href='3_63.html'>63</a><a href='3_64.html'>64</a><a href='3_65.html'>65</a><a href='3_66.html'>66</a><a href='3_67.html'>67</a><a href='3_68.html'>68</a><a href='3_69.html'>69</a><a href='3_70.html'>70</a><a href='3_71.html'>71</a><a href='3_72.html'>72</a><a href='3_73.html'>73</a><a href='3_74.html'>74</a><a href='3_75.html'>75</a><a href='3_76.html'>76</a><a href='3_77.html'>77</a><a href='3_78.html'>78</a><a href='3_79.html'>79</a><a href='3_80.html'>80</a><a href='3_81.html'>81</a><a href='3_82.html'>82</a><a href='3_83.html'>83</a><a href='3_47.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 5afd06ccd6b309f6a47d7e8fa4ea349b25738d97
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:43 2010 -0400

    staging: hv: make the block driver depend on LBDAF
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Kconfig b/drivers/staging/hv/Kconfig
index 79afb1e96c33..97480f5c6599 100644
--- a/drivers/staging/hv/Kconfig
+++ b/drivers/staging/hv/Kconfig
@@ -17,7 +17,7 @@ config HYPERV_STORAGE
 
 config HYPERV_BLOCK
 	tristate "Microsoft Hyper-V virtual block driver"
-	depends on BLOCK &amp;&amp; SCSI
+	depends on BLOCK &amp;&amp; SCSI &amp;&amp; LBDAF
 	default HYPERV
 	help
 	  Select this option to enable the Hyper-V virtual block driver.
diff --git a/drivers/staging/hv/blkvsc_drv.c b/drivers/staging/hv/blkvsc_drv.c
index b6a2cb8752d3..8a25154c06f5 100644
--- a/drivers/staging/hv/blkvsc_drv.c
+++ b/drivers/staging/hv/blkvsc_drv.c
@@ -1489,7 +1489,7 @@ static int __init blkvsc_init(void)
 {
 	int ret;
 
-	ASSERT(sizeof(sector_t) == 8); /* Make sure CONFIG_LBD is set */
+	BUILD_BUG_ON(sizeof(sector_t) != 8);
 
 	DPRINT_ENTER(BLKVSC_DRV);
 </pre><hr><pre>commit ee3503762d86c13bb94ed1db200d4601517b1b9b
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:42 2010 -0400

    staging: hv: return error instead calling ASSERT in blkvsc_drv.c
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/blkvsc_drv.c b/drivers/staging/hv/blkvsc_drv.c
index 8f8637e51d9e..b6a2cb8752d3 100644
--- a/drivers/staging/hv/blkvsc_drv.c
+++ b/drivers/staging/hv/blkvsc_drv.c
@@ -1213,7 +1213,10 @@ static int blkvsc_cancel_pending_reqs(struct block_device_context *blkdev)
 					(!comp_req-&gt;request.Status ? 0 : -EIO),
 					comp_req-&gt;sector_count *
 					blkdev-&gt;sector_size);
-				ASSERT(ret != 0);
+
+				/* FIXME: shouldn't this do more than return? */
+				if (ret)
+					goto out;
 			}
 
 			kmem_cache_free(blkdev-&gt;request_pool, comp_req);
@@ -1245,6 +1248,7 @@ static int blkvsc_cancel_pending_reqs(struct block_device_context *blkdev)
 		kmem_cache_free(blkdev-&gt;request_pool, pend_req);
 	}
 
+out:
 	return ret;
 }
 </pre><hr><pre>commit b856e7382f7d1b184a3dac200275e23a27488ce1
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:41 2010 -0400

    staging: hv: remove ASSERT()s in storvsc_drv.c
    
    These ASSERT()s serve no purpose other than for debugging.
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/storvsc_drv.c b/drivers/staging/hv/storvsc_drv.c
index 26b35a6c679a..d9649e37e11c 100644
--- a/drivers/staging/hv/storvsc_drv.c
+++ b/drivers/staging/hv/storvsc_drv.c
@@ -385,11 +385,11 @@ static void storvsc_commmand_completion(struct hv_storvsc_request *request)
 	void (*scsi_done_fn)(struct scsi_cmnd *);
 	struct scsi_sense_hdr sense_hdr;
 
-	ASSERT(request == &amp;cmd_request-&gt;request);
-	ASSERT(scmnd);
-	ASSERT((unsigned long)scmnd-&gt;host_scribble ==
-		(unsigned long)cmd_request);
-	ASSERT(scmnd-&gt;scsi_done);
+	/* ASSERT(request == &amp;cmd_request-&gt;request); */
+	/* ASSERT(scmnd); */
+	/* ASSERT((unsigned long)scmnd-&gt;host_scribble == */
+	/*        (unsigned long)cmd_request); */
+	/* ASSERT(scmnd-&gt;scsi_done); */
 
 	DPRINT_ENTER(STORVSC_DRV);
 
@@ -413,7 +413,7 @@ static void storvsc_commmand_completion(struct hv_storvsc_request *request)
 			scsi_print_sense_hdr("storvsc", &amp;sense_hdr);
 	}
 
-	ASSERT(request-&gt;BytesXfer &lt;= request-&gt;DataBuffer.Length);
+	/* ASSERT(request-&gt;BytesXfer &lt;= request-&gt;DataBuffer.Length); */
 	scsi_set_resid(scmnd, request-&gt;DataBuffer.Length - request-&gt;BytesXfer);
 
 	scsi_done_fn = scmnd-&gt;scsi_done;
@@ -522,7 +522,7 @@ static unsigned int copy_to_bounce_buffer(struct scatterlist *orig_sgl,
 		src = src_addr;
 		srclen = orig_sgl[i].length;
 
-		ASSERT(orig_sgl[i].offset + orig_sgl[i].length &lt;= PAGE_SIZE);
+		/* ASSERT(orig_sgl[i].offset + orig_sgl[i].length &lt;= PAGE_SIZE); */
 
 		if (j == 0)
 			bounce_addr = (unsigned long)kmap_atomic(sg_page((&amp;bounce_sgl[j])), KM_IRQ0);
@@ -583,7 +583,7 @@ static unsigned int copy_from_bounce_buffer(struct scatterlist *orig_sgl,
 					KM_IRQ0) + orig_sgl[i].offset;
 		dest = dest_addr;
 		destlen = orig_sgl[i].length;
-		ASSERT(orig_sgl[i].offset + orig_sgl[i].length &lt;= PAGE_SIZE);
+		/* ASSERT(orig_sgl[i].offset + orig_sgl[i].length &lt;= PAGE_SIZE); */
 
 		if (j == 0)
 			bounce_addr = (unsigned long)kmap_atomic(sg_page((&amp;bounce_sgl[j])), KM_IRQ0);
@@ -655,7 +655,7 @@ static int storvsc_queuecommand(struct scsi_cmnd *scmnd,
 
 	/* If retrying, no need to prep the cmd */
 	if (scmnd-&gt;host_scribble) {
-		ASSERT(scmnd-&gt;scsi_done != NULL);
+		/* ASSERT(scmnd-&gt;scsi_done != NULL); */
 
 		cmd_request =
 			(struct storvsc_cmd_request *)scmnd-&gt;host_scribble;
@@ -665,8 +665,8 @@ static int storvsc_queuecommand(struct scsi_cmnd *scmnd,
 		goto retry_request;
 	}
 
-	ASSERT(scmnd-&gt;scsi_done == NULL);
-	ASSERT(scmnd-&gt;host_scribble == NULL);
+	/* ASSERT(scmnd-&gt;scsi_done == NULL); */
+	/* ASSERT(scmnd-&gt;host_scribble == NULL); */
 
 	scmnd-&gt;scsi_done = done;
 
@@ -717,7 +717,7 @@ static int storvsc_queuecommand(struct scsi_cmnd *scmnd,
 	request-&gt;TargetId = scmnd-&gt;device-&gt;id;
 	request-&gt;LunId = scmnd-&gt;device-&gt;lun;
 
-	ASSERT(scmnd-&gt;cmd_len &lt;= 16);
+	/* ASSERT(scmnd-&gt;cmd_len &lt;= 16); */
 	request-&gt;CdbLen = scmnd-&gt;cmd_len;
 	request-&gt;Cdb = scmnd-&gt;cmnd;
 
@@ -773,13 +773,11 @@ static int storvsc_queuecommand(struct scsi_cmnd *scmnd,
 					page_to_pfn(sg_page((&amp;sgl[i])));
 		}
 	} else if (scsi_sglist(scmnd)) {
-		ASSERT(scsi_bufflen(scmnd) &lt;= PAGE_SIZE);
+		/* ASSERT(scsi_bufflen(scmnd) &lt;= PAGE_SIZE); */
 		request-&gt;DataBuffer.Offset =
 			virt_to_phys(scsi_sglist(scmnd)) &amp; (PAGE_SIZE-1);
 		request-&gt;DataBuffer.PfnArray[0] =
 			virt_to_phys(scsi_sglist(scmnd)) &gt;&gt; PAGE_SHIFT;
-	} else {
-		ASSERT(scsi_bufflen(scmnd) == 0);
 	}
 
 retry_request:</pre><hr><pre>commit 0ace247ead760a6a56a7bb3b5926c28fef1d4c6c
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:40 2010 -0400

    staging: hv: remove ASSERT()s in Channel.c
    
    These ASSERT()s serve no purpose other than for debugging.
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index 0a9ca336ede9..a1431e4ac8be 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -183,8 +183,8 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	DPRINT_ENTER(VMBUS);
 
 	/* Aligned to page size */
-	ASSERT(!(SendRingBufferSize &amp; (PAGE_SIZE - 1)));
-	ASSERT(!(RecvRingBufferSize &amp; (PAGE_SIZE - 1)));
+	/* ASSERT(!(SendRingBufferSize &amp; (PAGE_SIZE - 1))); */
+	/* ASSERT(!(RecvRingBufferSize &amp; (PAGE_SIZE - 1))); */
 
 	NewChannel-&gt;OnChannelCallback = OnChannelCallback;
 	NewChannel-&gt;ChannelCallbackContext = Context;
@@ -195,7 +195,7 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	if (!out)
 		return -ENOMEM;
 
-	ASSERT(((unsigned long)out &amp; (PAGE_SIZE-1)) == 0);
+	/* ASSERT(((unsigned long)out &amp; (PAGE_SIZE-1)) == 0); */
 
 	in = (void *)((unsigned long)out + SendRingBufferSize);
 
@@ -373,7 +373,7 @@ static int VmbusChannelCreateGpadlHeader(void *Kbuffer, u32 Size,
 	int pfnSum, pfnCount, pfnLeft, pfnCurr, pfnSize;
 
 	/* ASSERT((kbuffer &amp; (PAGE_SIZE-1)) == 0); */
-	ASSERT((Size &amp; (PAGE_SIZE-1)) == 0);
+	/* ASSERT((Size &amp; (PAGE_SIZE-1)) == 0); */
 
 	pageCount = Size &gt;&gt; PAGE_SHIFT;
 	pfn = virt_to_phys(Kbuffer) &gt;&gt; PAGE_SHIFT;
@@ -601,7 +601,7 @@ int VmbusChannelTeardownGpadl(struct vmbus_channel *Channel, u32 GpadlHandle)
 
 	DPRINT_ENTER(VMBUS);
 
-	ASSERT(GpadlHandle != 0);
+	/* ASSERT(GpadlHandle != 0); */
 
 	info = kmalloc(sizeof(*info) +
 		       sizeof(struct vmbus_channel_gpadl_teardown), GFP_KERNEL);
@@ -746,7 +746,7 @@ int VmbusChannelSendPacket(struct vmbus_channel *Channel, const void *Buffer,
 
 	DumpVmbusChannel(Channel);
 
-	ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64));
+	/* ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64)); */
 
 	/* Setup the descriptor */
 	desc.Type = Type; /* VmbusPacketTypeDataInBand; */
@@ -808,7 +808,7 @@ int VmbusChannelSendPacketPageBuffer(struct vmbus_channel *Channel,
 	packetLen = descSize + BufferLen;
 	packetLenAligned = ALIGN_UP(packetLen, sizeof(u64));
 
-	ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64));
+	/* ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64)); */
 
 	/* Setup the descriptor */
 	desc.Type = VmbusPacketTypeDataUsingGpaDirect;
@@ -878,7 +878,7 @@ int VmbusChannelSendPacketMultiPageBuffer(struct vmbus_channel *Channel,
 	packetLen = descSize + BufferLen;
 	packetLenAligned = ALIGN_UP(packetLen, sizeof(u64));
 
-	ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64));
+	/* ASSERT((packetLenAligned - packetLen) &lt; sizeof(u64)); */
 
 	/* Setup the descriptor */
 	desc.Type = VmbusPacketTypeDataUsingGpaDirect;
@@ -1056,7 +1056,7 @@ int VmbusChannelRecvPacketRaw(struct vmbus_channel *Channel, void *Buffer,
 void VmbusChannelOnChannelEvent(struct vmbus_channel *Channel)
 {
 	DumpVmbusChannel(Channel);
-	ASSERT(Channel-&gt;OnChannelCallback);
+	/* ASSERT(Channel-&gt;OnChannelCallback); */
 
 	Channel-&gt;OnChannelCallback(Channel-&gt;ChannelCallbackContext);
 </pre><hr><pre>commit 002b53ea5713910daf215037b72c5820413e2f95
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:39 2010 -0400

    Staging: hv: return -EINVAL instead of calling ASSERT()
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index bd1a33608fcf..0a9ca336ede9 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -793,7 +793,8 @@ int VmbusChannelSendPacketPageBuffer(struct vmbus_channel *Channel,
 
 	DPRINT_ENTER(VMBUS);
 
-	ASSERT(PageCount &lt;= MAX_PAGE_BUFFER_COUNT);
+	if (PageCount &gt; MAX_PAGE_BUFFER_COUNT)
+		return -EINVAL;
 
 	DumpVmbusChannel(Channel);
 
@@ -864,8 +865,8 @@ int VmbusChannelSendPacketMultiPageBuffer(struct vmbus_channel *Channel,
 	DPRINT_DBG(VMBUS, "data buffer - offset %u len %u pfn count %u",
 		   MultiPageBuffer-&gt;Offset, MultiPageBuffer-&gt;Length, PfnCount);
 
-	ASSERT(PfnCount &gt; 0);
-	ASSERT(PfnCount &lt;= MAX_MULTIPAGE_BUFFER_COUNT);
+	if ((PfnCount &lt; 0) || (PfnCount &gt; MAX_MULTIPAGE_BUFFER_COUNT))
+		return -EINVAL;
 
 	/*
 	 * Adjust the size down since VMBUS_CHANNEL_PACKET_MULITPAGE_BUFFER is</pre><hr><pre>commit c827f944f51e02894d68f036da843783e622ec2a
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:38 2010 -0400

    Staging: hv: remove ASSERT() in Channel.c
    
    VmbusChannelOpen() will now return -EINVAL if UserDataLen is too big.
    Previously this was handled by an assert.
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index fdd441174f23..bd1a33608fcf 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -258,7 +258,11 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 						  PAGE_SHIFT;
 	openMsg-&gt;ServerContextAreaGpadlHandle = 0; /* TODO */
 
-	ASSERT(UserDataLen &lt;= MAX_USER_DEFINED_BYTES);
+	if (UserDataLen &gt; MAX_USER_DEFINED_BYTES) {
+		err = -EINVAL;
+		goto errorout;
+	}
+
 	if (UserDataLen)
 		memcpy(openMsg-&gt;UserData, UserData, UserDataLen);
 </pre><hr><pre>commit b94ef345b26b4d75e5028617e43fb51d7dd0162b
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:37 2010 -0400

    Staging: hv: test return value of VmbusChannelEstablishGpadl()
    
    The return value of VmbusChannelEstablishGpadl() was not examined in
    Channel.c
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index 8c30540b725d..fdd441174f23 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -175,7 +175,7 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 		     void (*OnChannelCallback)(void *context), void *Context)
 {
 	struct vmbus_channel_open_channel *openMsg;
-	struct vmbus_channel_msginfo *openInfo;
+	struct vmbus_channel_msginfo *openInfo = NULL;
 	void *in, *out;
 	unsigned long flags;
 	int ret, err = 0;
@@ -218,7 +218,11 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 					 SendRingBufferSize +
 					 RecvRingBufferSize,
 					 &amp;NewChannel-&gt;RingBufferGpadlHandle);
-/* FIXME: the value of ret is not checked */
+
+	if (!ret) {
+		err = ret;
+		goto errorout;
+	}
 
 	DPRINT_DBG(VMBUS, "channel %p &lt;relid %d gpadl 0x%x send ring %p "
 		   "size %d recv ring %p size %d, downstreamoffset %d&gt;",
@@ -250,7 +254,6 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	openMsg-&gt;OpenId = NewChannel-&gt;OfferMsg.ChildRelId; /* FIXME */
 	openMsg-&gt;ChildRelId = NewChannel-&gt;OfferMsg.ChildRelId;
 	openMsg-&gt;RingBufferGpadlHandle = NewChannel-&gt;RingBufferGpadlHandle;
-	ASSERT(openMsg-&gt;RingBufferGpadlHandle);
 	openMsg-&gt;DownstreamRingBufferPageOffset = SendRingBufferSize &gt;&gt;
 						  PAGE_SHIFT;
 	openMsg-&gt;ServerContextAreaGpadlHandle = 0; /* TODO */
@@ -295,6 +298,8 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	return 0;
 
 errorout:
+	RingBufferCleanup(&amp;NewChannel-&gt;Outbound);
+	RingBufferCleanup(&amp;NewChannel-&gt;Inbound);
 	osd_PageFree(out, (SendRingBufferSize + RecvRingBufferSize)
 		     &gt;&gt; PAGE_SHIFT);
 	kfree(openInfo);</pre><hr><pre>commit 99259159c0eb58a539ed399677c8294e3792722b
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:36 2010 -0400

    Staging: hv: remove ASSERT() in Channel.c
    
    return an error instead of calling ASSERT() if VmbusPostMessage()
    fails.
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index 2d8c086228cc..8c30540b725d 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -551,7 +551,9 @@ int VmbusChannelEstablishGpadl(struct vmbus_channel *Channel, void *Kbuffer,
 			ret = VmbusPostMessage(gpadlBody,
 					       subMsgInfo-&gt;MessageSize -
 					       sizeof(*subMsgInfo));
-			ASSERT(ret == 0);
+			if (!ret)
+				goto Cleanup;
+
 		}
 	}
 	osd_WaitEventWait(msgInfo-&gt;WaitEvent);</pre><hr><pre>commit d1c250bb5df9afb5af3f290d1006dfe601a51e2e
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:35 2010 -0400

    Staging: hv: remove ASSERT() in Channel.c
    
    check memory allocation in VmbusChannelCreateGpadlHeader() and
    return -ENOMEM if it fails
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index 79c013b48170..2d8c086228cc 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -382,6 +382,8 @@ static int VmbusChannelCreateGpadlHeader(void *Kbuffer, u32 Size,
 			  sizeof(struct vmbus_channel_gpadl_header) +
 			  sizeof(struct gpa_range) + pfnCount * sizeof(u64);
 		msgHeader =  kzalloc(msgSize, GFP_KERNEL);
+		if (!msgHeader)
+			goto nomem;
 
 		INIT_LIST_HEAD(&amp;msgHeader-&gt;SubMsgList);
 		msgHeader-&gt;MessageSize = msgSize;
@@ -416,7 +418,9 @@ static int VmbusChannelCreateGpadlHeader(void *Kbuffer, u32 Size,
 				  sizeof(struct vmbus_channel_gpadl_body) +
 				  pfnCurr * sizeof(u64);
 			msgBody = kzalloc(msgSize, GFP_KERNEL);
-			ASSERT(msgBody);
+			/* FIXME: we probably need to more if this fails */
+			if (!msgBody)
+				goto nomem;
 			msgBody-&gt;MessageSize = msgSize;
 			(*MessageCount)++;
 			gpadlBody =
@@ -459,6 +463,10 @@ static int VmbusChannelCreateGpadlHeader(void *Kbuffer, u32 Size,
 	}
 
 	return 0;
+nomem:
+	kfree(msgHeader);
+	kfree(msgBody);
+	return -ENOMEM;
 }
 
 /*</pre><hr><pre>commit c3bf2e26b30f4ea54f3825e8ebda7cb10ec204de
Author: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
Date:   Wed May 5 15:27:34 2010 -0400

    Staging: hv: remove ASSERT()s in Channel.c
    
    Signed-off-by: Bill Pemberton &lt;wfp5p@virginia.edu&gt;
    Cc: Hank Janssen &lt;hjanssen@microsoft.com&gt;
    Cc: Haiyang Zhang &lt;haiyangz@microsoft.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@suse.de&gt;

diff --git a/drivers/staging/hv/Channel.c b/drivers/staging/hv/Channel.c
index d939723db335..79c013b48170 100644
--- a/drivers/staging/hv/Channel.c
+++ b/drivers/staging/hv/Channel.c
@@ -178,7 +178,7 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	struct vmbus_channel_msginfo *openInfo;
 	void *in, *out;
 	unsigned long flags;
-	int ret;
+	int ret, err = 0;
 
 	DPRINT_ENTER(VMBUS);
 
@@ -218,6 +218,7 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 					 SendRingBufferSize +
 					 RecvRingBufferSize,
 					 &amp;NewChannel-&gt;RingBufferGpadlHandle);
+/* FIXME: the value of ret is not checked */
 
 	DPRINT_DBG(VMBUS, "channel %p &lt;relid %d gpadl 0x%x send ring %p "
 		   "size %d recv ring %p size %d, downstreamoffset %d&gt;",
@@ -233,9 +234,16 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	openInfo = kmalloc(sizeof(*openInfo) +
 			   sizeof(struct vmbus_channel_open_channel),
 			   GFP_KERNEL);
-	ASSERT(openInfo != NULL);
+	if (!openInfo) {
+		err = -ENOMEM;
+		goto errorout;
+	}
 
 	openInfo-&gt;WaitEvent = osd_WaitEventCreate();
+	if (!openInfo-&gt;WaitEvent) {
+		err = -ENOMEM;
+		goto errorout;
+	}
 
 	openMsg = (struct vmbus_channel_open_channel *)openInfo-&gt;Msg;
 	openMsg-&gt;Header.MessageType = ChannelMessageOpenChannel;
@@ -285,6 +293,12 @@ int VmbusChannelOpen(struct vmbus_channel *NewChannel, u32 SendRingBufferSize,
 	DPRINT_EXIT(VMBUS);
 
 	return 0;
+
+errorout:
+	osd_PageFree(out, (SendRingBufferSize + RecvRingBufferSize)
+		     &gt;&gt; PAGE_SHIFT);
+	kfree(openInfo);
+	return err;
 }
 
 /*
@@ -461,24 +475,29 @@ int VmbusChannelEstablishGpadl(struct vmbus_channel *Channel, void *Kbuffer,
 	struct vmbus_channel_gpadl_header *gpadlMsg;
 	struct vmbus_channel_gpadl_body *gpadlBody;
 	/* struct vmbus_channel_gpadl_created *gpadlCreated; */
-	struct vmbus_channel_msginfo *msgInfo;
+	struct vmbus_channel_msginfo *msgInfo = NULL;
 	struct vmbus_channel_msginfo *subMsgInfo;
 	u32 msgCount;
 	struct list_head *curr;
 	u32 nextGpadlHandle;
 	unsigned long flags;
-	int ret;
+	int ret = 0;
 
 	DPRINT_ENTER(VMBUS);
 
 	nextGpadlHandle = atomic_read(&amp;gVmbusConnection.NextGpadlHandle);
 	atomic_inc(&amp;gVmbusConnection.NextGpadlHandle);
 
-	VmbusChannelCreateGpadlHeader(Kbuffer, Size, &amp;msgInfo, &amp;msgCount);
-	ASSERT(msgInfo != NULL);
-	ASSERT(msgCount &gt; 0);
+	ret = VmbusChannelCreateGpadlHeader(Kbuffer, Size, &amp;msgInfo, &amp;msgCount);
+	if (ret)
+		return ret;
 
 	msgInfo-&gt;WaitEvent = osd_WaitEventCreate();
+	if (!msgInfo-&gt;WaitEvent) {
+		ret = -ENOMEM;
+		goto Cleanup;
+	}
+
 	gpadlMsg = (struct vmbus_channel_gpadl_header *)msgInfo-&gt;Msg;
 	gpadlMsg-&gt;Header.MessageType = ChannelMessageGpadlHeader;
 	gpadlMsg-&gt;ChildRelId = Channel-&gt;OfferMsg.ChildRelId;
@@ -567,9 +586,14 @@ int VmbusChannelTeardownGpadl(struct vmbus_channel *Channel, u32 GpadlHandle)
 
 	info = kmalloc(sizeof(*info) +
 		       sizeof(struct vmbus_channel_gpadl_teardown), GFP_KERNEL);
-	ASSERT(info != NULL);
+	if (!info)
+		return -ENOMEM;
 
 	info-&gt;WaitEvent = osd_WaitEventCreate();
+	if (!info-&gt;WaitEvent) {
+		kfree(info);
+		return -ENOMEM;
+	}
 
 	msg = (struct vmbus_channel_gpadl_teardown *)info-&gt;Msg;
 
@@ -623,7 +647,10 @@ void VmbusChannelClose(struct vmbus_channel *Channel)
 	/* Send a closing message */
 	info = kmalloc(sizeof(*info) +
 		       sizeof(struct vmbus_channel_close_channel), GFP_KERNEL);
-	ASSERT(info != NULL);
+        /* FIXME: can't do anything other than return here because the
+	 *        function is void */
+	if (!info)
+		return;
 
 	/* info-&gt;waitEvent = osd_WaitEventCreate(); */
 </pre>
    <div class="pagination">
        <a href='3_45.html'>&lt;&lt;Prev</a><a href='3.html'>1</a><a href='3_2.html'>2</a><a href='3_3.html'>3</a><a href='3_4.html'>4</a><a href='3_5.html'>5</a><a href='3_6.html'>6</a><a href='3_7.html'>7</a><a href='3_8.html'>8</a><a href='3_9.html'>9</a><a href='3_10.html'>10</a><a href='3_11.html'>11</a><a href='3_12.html'>12</a><a href='3_13.html'>13</a><a href='3_14.html'>14</a><a href='3_15.html'>15</a><a href='3_16.html'>16</a><a href='3_17.html'>17</a><a href='3_18.html'>18</a><a href='3_19.html'>19</a><a href='3_20.html'>20</a><a href='3_21.html'>21</a><a href='3_22.html'>22</a><a href='3_23.html'>23</a><a href='3_24.html'>24</a><a href='3_25.html'>25</a><a href='3_26.html'>26</a><a href='3_27.html'>27</a><a href='3_28.html'>28</a><a href='3_29.html'>29</a><a href='3_30.html'>30</a><a href='3_31.html'>31</a><a href='3_32.html'>32</a><a href='3_33.html'>33</a><a href='3_34.html'>34</a><a href='3_35.html'>35</a><a href='3_36.html'>36</a><a href='3_37.html'>37</a><a href='3_38.html'>38</a><a href='3_39.html'>39</a><a href='3_40.html'>40</a><a href='3_41.html'>41</a><a href='3_42.html'>42</a><a href='3_43.html'>43</a><a href='3_44.html'>44</a><a href='3_45.html'>45</a><span>[46]</span><a href='3_47.html'>47</a><a href='3_48.html'>48</a><a href='3_49.html'>49</a><a href='3_50.html'>50</a><a href='3_51.html'>51</a><a href='3_52.html'>52</a><a href='3_53.html'>53</a><a href='3_54.html'>54</a><a href='3_55.html'>55</a><a href='3_56.html'>56</a><a href='3_57.html'>57</a><a href='3_58.html'>58</a><a href='3_59.html'>59</a><a href='3_60.html'>60</a><a href='3_61.html'>61</a><a href='3_62.html'>62</a><a href='3_63.html'>63</a><a href='3_64.html'>64</a><a href='3_65.html'>65</a><a href='3_66.html'>66</a><a href='3_67.html'>67</a><a href='3_68.html'>68</a><a href='3_69.html'>69</a><a href='3_70.html'>70</a><a href='3_71.html'>71</a><a href='3_72.html'>72</a><a href='3_73.html'>73</a><a href='3_74.html'>74</a><a href='3_75.html'>75</a><a href='3_76.html'>76</a><a href='3_77.html'>77</a><a href='3_78.html'>78</a><a href='3_79.html'>79</a><a href='3_80.html'>80</a><a href='3_81.html'>81</a><a href='3_82.html'>82</a><a href='3_83.html'>83</a><a href='3_47.html'>Next&gt;&gt;</a>
    <div>
</body>
