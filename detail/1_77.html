<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Massachusetts Institute of Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Massachusetts Institute of Technology</h1>
    <div class="pagination">
        <a href='1_76.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><a href='1_43.html'>43</a><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><span>[77]</span><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><a href='1_144.html'>144</a><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_78.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit cad3f00763dcf9dfc62cbddf4bd714ab5a71a0eb
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sun Dec 19 22:07:02 2010 -0500

    ext4: optimize ext4_check_dir_entry() with unlikely() annotations
    
    This function gets called a lot for large directories, and the answer
    is almost always "no, no, there's no problem".  This means using
    unlikely() is a good thing.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/dir.c b/fs/ext4/dir.c
index ece76fb6a40c..bd5d74d06399 100644
--- a/fs/ext4/dir.c
+++ b/fs/ext4/dir.c
@@ -60,7 +60,11 @@ static unsigned char get_dtype(struct super_block *sb, int filetype)
 	return (ext4_filetype_table[filetype]);
 }
 
-
+/*
+ * Return 0 if the directory entry is OK, and 1 if there is a problem
+ *
+ * Note: this is the opposite of what ext2 and ext3 historically returned...
+ */
 int __ext4_check_dir_entry(const char *function, unsigned int line,
 			   struct inode *dir,
 			   struct ext4_dir_entry_2 *de,
@@ -71,26 +75,28 @@ int __ext4_check_dir_entry(const char *function, unsigned int line,
 	const int rlen = ext4_rec_len_from_disk(de-&gt;rec_len,
 						dir-&gt;i_sb-&gt;s_blocksize);
 
-	if (rlen &lt; EXT4_DIR_REC_LEN(1))
+	if (unlikely(rlen &lt; EXT4_DIR_REC_LEN(1)))
 		error_msg = "rec_len is smaller than minimal";
-	else if (rlen % 4 != 0)
+	else if (unlikely(rlen % 4 != 0))
 		error_msg = "rec_len % 4 != 0";
-	else if (rlen &lt; EXT4_DIR_REC_LEN(de-&gt;name_len))
+	else if (unlikely(rlen &lt; EXT4_DIR_REC_LEN(de-&gt;name_len)))
 		error_msg = "rec_len is too small for name_len";
-	else if (((char *) de - bh-&gt;b_data) + rlen &gt; dir-&gt;i_sb-&gt;s_blocksize)
+	else if (unlikely(((char *) de - bh-&gt;b_data) + rlen &gt;
+			  dir-&gt;i_sb-&gt;s_blocksize))
 		error_msg = "directory entry across blocks";
-	else if (le32_to_cpu(de-&gt;inode) &gt;
-			le32_to_cpu(EXT4_SB(dir-&gt;i_sb)-&gt;s_es-&gt;s_inodes_count))
+	else if (unlikely(le32_to_cpu(de-&gt;inode) &gt;
+			le32_to_cpu(EXT4_SB(dir-&gt;i_sb)-&gt;s_es-&gt;s_inodes_count)))
 		error_msg = "inode out of bounds";
+	else
+		return 0;
 
-	if (error_msg != NULL)
-		ext4_error_inode(dir, function, line, bh-&gt;b_blocknr,
-			"bad entry in directory: %s - "
-			"offset=%u(%u), inode=%u, rec_len=%d, name_len=%d",
-			error_msg, (unsigned) (offset%bh-&gt;b_size), offset,
-			le32_to_cpu(de-&gt;inode),
-			rlen, de-&gt;name_len);
-	return error_msg == NULL ? 1 : 0;
+	ext4_error_inode(dir, function, line, bh-&gt;b_blocknr,
+			 "bad entry in directory: %s - "
+			 "offset=%u(%u), inode=%u, rec_len=%d, name_len=%d",
+			 error_msg, (unsigned) (offset%bh-&gt;b_size), offset,
+			 le32_to_cpu(de-&gt;inode),
+			 rlen, de-&gt;name_len);
+	return 1;
 }
 
 static int ext4_readdir(struct file *filp,
@@ -194,8 +200,8 @@ static int ext4_readdir(struct file *filp,
 		while (!error &amp;&amp; filp-&gt;f_pos &lt; inode-&gt;i_size
 		       &amp;&amp; offset &lt; sb-&gt;s_blocksize) {
 			de = (struct ext4_dir_entry_2 *) (bh-&gt;b_data + offset);
-			if (!ext4_check_dir_entry(inode, de,
-						  bh, offset)) {
+			if (ext4_check_dir_entry(inode, de,
+						 bh, offset)) {
 				/*
 				 * On error, skip the f_pos to the next block
 				 */
diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.h
index 17baecbf8cda..49f1ceaac57d 100644
--- a/fs/ext4/ext4.h
+++ b/fs/ext4/ext4.h
@@ -1639,7 +1639,8 @@ extern int __ext4_check_dir_entry(const char *, unsigned int, struct inode *,
 				  struct ext4_dir_entry_2 *,
 				  struct buffer_head *, unsigned int);
 #define ext4_check_dir_entry(dir, de, bh, offset) \
-	__ext4_check_dir_entry(__func__, __LINE__, (dir), (de), (bh), (offset))
+	unlikely(__ext4_check_dir_entry(__func__, __LINE__, (dir), (de), \
+					(bh), (offset)))
 extern int ext4_htree_store_dirent(struct file *dir_file, __u32 hash,
 				    __u32 minor_hash,
 				    struct ext4_dir_entry_2 *dirent);
diff --git a/fs/ext4/namei.c b/fs/ext4/namei.c
index 203086498caa..e275464f7754 100644
--- a/fs/ext4/namei.c
+++ b/fs/ext4/namei.c
@@ -581,9 +581,9 @@ static int htree_dirblock_to_tree(struct file *dir_file,
 					   dir-&gt;i_sb-&gt;s_blocksize -
 					   EXT4_DIR_REC_LEN(0));
 	for (; de &lt; top; de = ext4_next_entry(de, dir-&gt;i_sb-&gt;s_blocksize)) {
-		if (!ext4_check_dir_entry(dir, de, bh,
-					(block&lt;&lt;EXT4_BLOCK_SIZE_BITS(dir-&gt;i_sb))
-						+((char *)de - bh-&gt;b_data))) {
+		if (ext4_check_dir_entry(dir, de, bh,
+				(block&lt;&lt;EXT4_BLOCK_SIZE_BITS(dir-&gt;i_sb))
+					 + ((char *)de - bh-&gt;b_data))) {
 			/* On error, skip the f_pos to the next block. */
 			dir_file-&gt;f_pos = (dir_file-&gt;f_pos |
 					(dir-&gt;i_sb-&gt;s_blocksize - 1)) + 1;
@@ -820,7 +820,7 @@ static inline int search_dirblock(struct buffer_head *bh,
 		if ((char *) de + namelen &lt;= dlimit &amp;&amp;
 		    ext4_match (namelen, name, de)) {
 			/* found a match - just to be sure, do a full check */
-			if (!ext4_check_dir_entry(dir, de, bh, offset))
+			if (ext4_check_dir_entry(dir, de, bh, offset))
 				return -1;
 			*res_dir = de;
 			return 1;
@@ -1269,7 +1269,7 @@ static int add_dirent_to_buf(handle_t *handle, struct dentry *dentry,
 		de = (struct ext4_dir_entry_2 *)bh-&gt;b_data;
 		top = bh-&gt;b_data + blocksize - reclen;
 		while ((char *) de &lt;= top) {
-			if (!ext4_check_dir_entry(dir, de, bh, offset))
+			if (ext4_check_dir_entry(dir, de, bh, offset))
 				return -EIO;
 			if (ext4_match(namelen, name, de))
 				return -EEXIST;
@@ -1636,7 +1636,7 @@ static int ext4_delete_entry(handle_t *handle,
 	pde = NULL;
 	de = (struct ext4_dir_entry_2 *) bh-&gt;b_data;
 	while (i &lt; bh-&gt;b_size) {
-		if (!ext4_check_dir_entry(dir, de, bh, i))
+		if (ext4_check_dir_entry(dir, de, bh, i))
 			return -EIO;
 		if (de == de_del)  {
 			BUFFER_TRACE(bh, "get_write_access");
@@ -1919,7 +1919,7 @@ static int empty_dir(struct inode *inode)
 			}
 			de = (struct ext4_dir_entry_2 *) bh-&gt;b_data;
 		}
-		if (!ext4_check_dir_entry(inode, de, bh, offset)) {
+		if (ext4_check_dir_entry(inode, de, bh, offset)) {
 			de = (struct ext4_dir_entry_2 *)(bh-&gt;b_data +
 							 sb-&gt;s_blocksize);
 			offset = (offset | (sb-&gt;s_blocksize - 1)) + 1;</pre><hr><pre>commit b7271b0a39947f757d7969f6150dcb16c1976b91
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Dec 18 13:39:38 2010 -0500

    jbd2: simplify return path of journal_init_common
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index 06dfd778cae5..2447bd86f801 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -828,7 +828,7 @@ static journal_t * journal_init_common (void)
 
 	journal = kzalloc(sizeof(*journal), GFP_KERNEL);
 	if (!journal)
-		goto fail;
+		return NULL;
 
 	init_waitqueue_head(&amp;journal-&gt;j_wait_transaction_locked);
 	init_waitqueue_head(&amp;journal-&gt;j_wait_logspace);
@@ -853,14 +853,12 @@ static journal_t * journal_init_common (void)
 	err = jbd2_journal_init_revoke(journal, JOURNAL_REVOKE_DEFAULT_HASH);
 	if (err) {
 		kfree(journal);
-		goto fail;
+		return NULL;
 	}
 
 	spin_lock_init(&amp;journal-&gt;j_history_lock);
 
 	return journal;
-fail:
-	return NULL;
 }
 
 /* jbd2_journal_init_dev and jbd2_journal_init_inode:</pre><hr><pre>commit 9a4f6271b68b9693290963b97b320d2e6e6f3446
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Dec 18 13:36:33 2010 -0500

    jbd2: move debug message into debug #ifdef
    
    This is a port to jbd2 of a patch which Namhyung Kim &lt;namhyung@gmail.com&gt;
    originally made to fs/jbd.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/recovery.c b/fs/jbd2/recovery.c
index 2bc4d5f116f1..1cad869494f0 100644
--- a/fs/jbd2/recovery.c
+++ b/fs/jbd2/recovery.c
@@ -299,10 +299,10 @@ int jbd2_journal_skip_recovery(journal_t *journal)
 #ifdef CONFIG_JBD2_DEBUG
 		int dropped = info.end_transaction - 
 			be32_to_cpu(journal-&gt;j_superblock-&gt;s_sequence);
-#endif
 		jbd_debug(1,
 			  "JBD: ignoring %d transaction%s from the journal.\n",
 			  dropped, (dropped == 1) ? "" : "s");
+#endif
 		journal-&gt;j_transaction_sequence = ++info.end_transaction;
 	}
 </pre><hr><pre>commit ae00b267f3827ba88309fb74bdf7527396f0acf9
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Dec 18 13:34:20 2010 -0500

    jbd2: remove unnecessary goto statement
    
    This is a port to jbd2 of a patch which Namhyung Kim &lt;namhyung@gmail.com&gt;
    originally made to fs/jbd.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index 80f9b2a3880b..394893242ae3 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -340,9 +340,7 @@ handle_t *jbd2__journal_start(journal_t *journal, int nblocks, int gfp_mask)
 		jbd2_free_handle(handle);
 		current-&gt;journal_info = NULL;
 		handle = ERR_PTR(err);
-		goto out;
 	}
-out:
 	return handle;
 }
 EXPORT_SYMBOL(jbd2__journal_start);</pre><hr><pre>commit a1dd53318409ed6a27a8ce4fecf52e1326a100c0
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Dec 18 13:13:40 2010 -0500

    jbd2: use offset_in_page() instead of manual calculation
    
    This is a port to jbd2 of a patch which Namhyung Kim &lt;namhyung@gmail.com&gt;
    originally made to fs/jbd.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index 10b5e3b1ca8b..80f9b2a3880b 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -774,7 +774,7 @@ do_get_write_access(handle_t *handle, struct journal_head *jh,
 		J_EXPECT_JH(jh, buffer_uptodate(jh2bh(jh)),
 			    "Possible IO failure.\n");
 		page = jh2bh(jh)-&gt;b_page;
-		offset = ((unsigned long) jh2bh(jh)-&gt;b_data) &amp; ~PAGE_MASK;
+		offset = offset_in_page(jh2bh(jh)-&gt;b_data);
 		source = kmap_atomic(page, KM_USER0);
 		/* Fire data frozen trigger just before we copy the data */
 		jbd2_buffer_frozen_trigger(jh, source + offset,</pre><hr><pre>commit cfef2c6a559b1e37cbc7e7c1b51f82d26abf24ec
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Dec 18 13:07:34 2010 -0500

    jbd2: Fix a debug message in do_get_write_access()
    
    'buffer_head' should be 'journal_head'
    
    This is a port of a patch which Namhyung Kim &lt;namhyung@gmail.com&gt; made
    to fs/jbd to jbd2.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index 6bf0a242613e..10b5e3b1ca8b 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -589,7 +589,7 @@ do_get_write_access(handle_t *handle, struct journal_head *jh,
 	transaction = handle-&gt;h_transaction;
 	journal = transaction-&gt;t_journal;
 
-	jbd_debug(5, "buffer_head %p, force_copy %d\n", jh, force_copy);
+	jbd_debug(5, "journal_head %p, force_copy %d\n", jh, force_copy);
 
 	JBUFFER_TRACE(jh, "entry");
 repeat:</pre><hr><pre>commit 670be5a78ac7c80f0d6009d648c84c65a03f373a
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Fri Dec 17 10:44:16 2010 -0500

    jbd2: Use pr_notice_ratelimited() in journal_alloc_journal_head()
    
    We had an open-coded version of printk_ratelimited(); use the provided
    abstraction to make the code cleaner and easier to understand.
    
    Based on a similar patch for fs/jbd from Namhyung Kim &lt;namhyung@gmail.com&gt;
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index f837ba953529..06dfd778cae5 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -43,6 +43,7 @@
 #include &lt;linux/vmalloc.h&gt;
 #include &lt;linux/backing-dev.h&gt;
 #include &lt;linux/bitops.h&gt;
+#include &lt;linux/ratelimit.h&gt;
 
 #define CREATE_TRACE_POINTS
 #include &lt;trace/events/jbd2.h&gt;
@@ -1982,7 +1983,6 @@ static void jbd2_journal_destroy_jbd2_journal_head_cache(void)
 static struct journal_head *journal_alloc_journal_head(void)
 {
 	struct journal_head *ret;
-	static unsigned long last_warning;
 
 #ifdef CONFIG_JBD2_DEBUG
 	atomic_inc(&amp;nr_journal_heads);
@@ -1990,11 +1990,7 @@ static struct journal_head *journal_alloc_journal_head(void)
 	ret = kmem_cache_alloc(jbd2_journal_head_cache, GFP_NOFS);
 	if (!ret) {
 		jbd_debug(1, "out of memory for journal_head\n");
-		if (time_after(jiffies, last_warning + 5*HZ)) {
-			printk(KERN_NOTICE "ENOMEM in %s, retrying.\n",
-			       __func__);
-			last_warning = jiffies;
-		}
+		pr_notice_ratelimited("ENOMEM in %s, retrying.\n", __func__);
 		while (!ret) {
 			yield();
 			ret = kmem_cache_alloc(jbd2_journal_head_cache, GFP_NOFS);</pre><hr><pre>commit a8901d34872dafcafa23efa0865dcecfd4fddf8c
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Fri Dec 17 10:40:47 2010 -0500

    ext4: Use pr_warning_ratelimited() instead of printk_ratelimit()
    
    printk_ratelimit() is deprecated since it is a global instead of a
    per-printk ratelimit.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/inode.c b/fs/ext4/inode.c
index db3cc913ee8f..c0fe426d444a 100644
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@ -40,6 +40,7 @@
 #include &lt;linux/workqueue.h&gt;
 #include &lt;linux/kernel.h&gt;
 #include &lt;linux/slab.h&gt;
+#include &lt;linux/ratelimit.h&gt;
 
 #include "ext4_jbd2.h"
 #include "xattr.h"
@@ -3729,8 +3730,7 @@ static int ext4_set_bh_endio(struct buffer_head *bh, struct inode *inode)
 retry:
 	io_end = ext4_init_io_end(inode, GFP_ATOMIC);
 	if (!io_end) {
-		if (printk_ratelimit())
-			printk(KERN_WARNING "%s: allocation fail\n", __func__);
+		pr_warning_ratelimited("%s: allocation fail\n", __func__);
 		schedule();
 		goto retry;
 	}</pre><hr><pre>commit 225db7d35c33f076115a583abec238a696f4467e
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Thu Dec 16 16:38:26 2010 -0500

    ext4: Fix up comments in inode.c
    
    This fixes up some broken argument descriptions that Namhyung Kim had
    originally submitted for ext3.  This fixes the comments that were
    still applicable in ext4.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/inode.c b/fs/ext4/inode.c
index e659597b690b..db3cc913ee8f 100644
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@ -552,7 +552,7 @@ static ext4_fsblk_t ext4_find_goal(struct inode *inode, ext4_lblk_t block,
 }
 
 /**
- *	ext4_blks_to_allocate: Look up the block map and count the number
+ *	ext4_blks_to_allocate - Look up the block map and count the number
  *	of direct blocks need to be allocated for the given branch.
  *
  *	@branch: chain of indirect blocks
@@ -591,13 +591,19 @@ static int ext4_blks_to_allocate(Indirect *branch, int k, unsigned int blks,
 
 /**
  *	ext4_alloc_blocks: multiple allocate blocks needed for a branch
+ *	@handle: handle for this transaction
+ *	@inode: inode which needs allocated blocks
+ *	@iblock: the logical block to start allocated at
+ *	@goal: preferred physical block of allocation
  *	@indirect_blks: the number of blocks need to allocate for indirect
  *			blocks
- *
+ *	@blks: number of desired blocks
  *	@new_blocks: on return it will store the new block numbers for
  *	the indirect blocks(if needed) and the first direct block,
- *	@blks:	on return it will store the total number of allocated
- *		direct blocks
+ *	@err: on return it will store the error code
+ *
+ *	This function will return the number of blocks allocated as
+ *	requested by the passed-in parameters.
  */
 static int ext4_alloc_blocks(handle_t *handle, struct inode *inode,
 			     ext4_lblk_t iblock, ext4_fsblk_t goal,
@@ -711,9 +717,11 @@ static int ext4_alloc_blocks(handle_t *handle, struct inode *inode,
 
 /**
  *	ext4_alloc_branch - allocate and set up a chain of blocks.
+ *	@handle: handle for this transaction
  *	@inode: owner
  *	@indirect_blks: number of allocated indirect blocks
  *	@blks: number of allocated direct blocks
+ *	@goal: preferred place for allocation
  *	@offsets: offsets (in the blocks) to store the pointers to next.
  *	@branch: place to store the chain in.
  *
@@ -826,6 +834,7 @@ static int ext4_alloc_branch(handle_t *handle, struct inode *inode,
 
 /**
  * ext4_splice_branch - splice the allocated branch onto inode.
+ * @handle: handle for this transaction
  * @inode: owner
  * @block: (logical) number of block we are adding
  * @chain: chain of indirect blocks (with a missing link - see</pre><hr><pre>commit a2595b8aa67011419dae26b47e474f46df902989
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Wed Dec 15 20:30:48 2010 -0500

    ext4: Add second mount options field since the s_mount_opt is full up
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/ext4.h b/fs/ext4/ext4.h
index ddae3c435138..17baecbf8cda 100644
--- a/fs/ext4/ext4.h
+++ b/fs/ext4/ext4.h
@@ -908,6 +908,13 @@ struct ext4_inode_info {
 #define test_opt(sb, opt)		(EXT4_SB(sb)-&gt;s_mount_opt &amp; \
 					 EXT4_MOUNT_##opt)
 
+#define clear_opt2(sb, opt)		EXT4_SB(sb)-&gt;s_mount_opt2 &amp;= \
+						~EXT4_MOUNT2_##opt
+#define set_opt2(sb, opt)		EXT4_SB(sb)-&gt;s_mount_opt2 |= \
+						EXT4_MOUNT2_##opt
+#define test_opt2(sb, opt)		(EXT4_SB(sb)-&gt;s_mount_opt2 &amp; \
+					 EXT4_MOUNT2_##opt)
+
 #define ext4_set_bit			ext2_set_bit
 #define ext4_set_bit_atomic		ext2_set_bit_atomic
 #define ext4_clear_bit			ext2_clear_bit
@@ -1073,6 +1080,7 @@ struct ext4_sb_info {
 	struct ext4_super_block *s_es;	/* Pointer to the super block in the buffer */
 	struct buffer_head **s_group_desc;
 	unsigned int s_mount_opt;
+	unsigned int s_mount_opt2;
 	unsigned int s_mount_flags;
 	ext4_fsblk_t s_sb_block;
 	uid_t s_resuid;
diff --git a/fs/ext4/super.c b/fs/ext4/super.c
index 7aa3a790363a..072ff973ff2b 100644
--- a/fs/ext4/super.c
+++ b/fs/ext4/super.c
@@ -1895,12 +1895,12 @@ static int ext4_setup_super(struct super_block *sb, struct ext4_super_block *es,
 	ext4_commit_super(sb, 1);
 	if (test_opt(sb, DEBUG))
 		printk(KERN_INFO "[EXT4 FS bs=%lu, gc=%u, "
-				"bpg=%lu, ipg=%lu, mo=%04x]\n",
+				"bpg=%lu, ipg=%lu, mo=%04x, mo2=%04x]\n",
 			sb-&gt;s_blocksize,
 			sbi-&gt;s_groups_count,
 			EXT4_BLOCKS_PER_GROUP(sb),
 			EXT4_INODES_PER_GROUP(sb),
-			sbi-&gt;s_mount_opt);
+			sbi-&gt;s_mount_opt, sbi-&gt;s_mount_opt2);
 
 	return res;
 }
@@ -4171,6 +4171,7 @@ static int ext4_unfreeze(struct super_block *sb)
  */
 struct ext4_mount_options {
 	unsigned long s_mount_opt;
+	unsigned long s_mount_opt2;
 	uid_t s_resuid;
 	gid_t s_resgid;
 	unsigned long s_commit_interval;
@@ -4201,6 +4202,7 @@ static int ext4_remount(struct super_block *sb, int *flags, char *data)
 	lock_super(sb);
 	old_sb_flags = sb-&gt;s_flags;
 	old_opts.s_mount_opt = sbi-&gt;s_mount_opt;
+	old_opts.s_mount_opt2 = sbi-&gt;s_mount_opt2;
 	old_opts.s_resuid = sbi-&gt;s_resuid;
 	old_opts.s_resgid = sbi-&gt;s_resgid;
 	old_opts.s_commit_interval = sbi-&gt;s_commit_interval;
@@ -4354,6 +4356,7 @@ static int ext4_remount(struct super_block *sb, int *flags, char *data)
 restore_opts:
 	sb-&gt;s_flags = old_sb_flags;
 	sbi-&gt;s_mount_opt = old_opts.s_mount_opt;
+	sbi-&gt;s_mount_opt2 = old_opts.s_mount_opt2;
 	sbi-&gt;s_resuid = old_opts.s_resuid;
 	sbi-&gt;s_resgid = old_opts.s_resgid;
 	sbi-&gt;s_commit_interval = old_opts.s_commit_interval;</pre>
    <div class="pagination">
        <a href='1_76.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><a href='1_43.html'>43</a><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><span>[77]</span><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><a href='1_144.html'>144</a><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_78.html'>Next&gt;&gt;</a>
    <div>
</body>
