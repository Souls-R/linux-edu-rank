<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by University of Michigan - Ann Arbor</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by University of Michigan - Ann Arbor</h1>
    <div class="pagination">
        <a href='4_43.html'>&lt;&lt;Prev</a><a href='4.html'>1</a><a href='4_2.html'>2</a><a href='4_3.html'>3</a><a href='4_4.html'>4</a><a href='4_5.html'>5</a><a href='4_6.html'>6</a><a href='4_7.html'>7</a><a href='4_8.html'>8</a><a href='4_9.html'>9</a><a href='4_10.html'>10</a><a href='4_11.html'>11</a><a href='4_12.html'>12</a><a href='4_13.html'>13</a><a href='4_14.html'>14</a><a href='4_15.html'>15</a><a href='4_16.html'>16</a><a href='4_17.html'>17</a><a href='4_18.html'>18</a><a href='4_19.html'>19</a><a href='4_20.html'>20</a><a href='4_21.html'>21</a><a href='4_22.html'>22</a><a href='4_23.html'>23</a><a href='4_24.html'>24</a><a href='4_25.html'>25</a><a href='4_26.html'>26</a><a href='4_27.html'>27</a><a href='4_28.html'>28</a><a href='4_29.html'>29</a><a href='4_30.html'>30</a><a href='4_31.html'>31</a><a href='4_32.html'>32</a><a href='4_33.html'>33</a><a href='4_34.html'>34</a><a href='4_35.html'>35</a><a href='4_36.html'>36</a><a href='4_37.html'>37</a><a href='4_38.html'>38</a><a href='4_39.html'>39</a><a href='4_40.html'>40</a><a href='4_41.html'>41</a><a href='4_42.html'>42</a><a href='4_43.html'>43</a><span>[44]</span><a href='4_45.html'>45</a><a href='4_46.html'>46</a><a href='4_47.html'>47</a><a href='4_48.html'>48</a><a href='4_49.html'>49</a><a href='4_50.html'>50</a><a href='4_51.html'>51</a><a href='4_52.html'>52</a><a href='4_53.html'>53</a><a href='4_54.html'>54</a><a href='4_55.html'>55</a><a href='4_56.html'>56</a><a href='4_57.html'>57</a><a href='4_45.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 0a725fc4d3bfc4734164863d6c50208b109ca5c7
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Tue Jul 31 00:37:52 2007 -0700

    nfsd4: idmap upcalls should use unsigned uid and gid
    
    We shouldn't be using negative uid's and gid's in the idmap upcalls.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Cc: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/nfs4idmap.c b/fs/nfsd/nfs4idmap.c
index 2cf9a9a2d89c..2ccffde81b84 100644
--- a/fs/nfsd/nfs4idmap.c
+++ b/fs/nfsd/nfs4idmap.c
@@ -138,7 +138,7 @@ idtoname_request(struct cache_detail *cd, struct cache_head *ch, char **bpp,
 	char idstr[11];
 
 	qword_add(bpp, blen, ent-&gt;authname);
-	snprintf(idstr, sizeof(idstr), "%d", ent-&gt;id);
+	snprintf(idstr, sizeof(idstr), "%u", ent-&gt;id);
 	qword_add(bpp, blen, ent-&gt;type == IDMAP_TYPE_GROUP ? "group" : "user");
 	qword_add(bpp, blen, idstr);
 
@@ -165,7 +165,7 @@ idtoname_show(struct seq_file *m, struct cache_detail *cd, struct cache_head *h)
 		return 0;
 	}
 	ent = container_of(h, struct ent, h);
-	seq_printf(m, "%s %s %d", ent-&gt;authname,
+	seq_printf(m, "%s %s %u", ent-&gt;authname,
 			ent-&gt;type == IDMAP_TYPE_GROUP ? "group" : "user",
 			ent-&gt;id);
 	if (test_bit(CACHE_VALID, &amp;h-&gt;flags))
@@ -349,7 +349,7 @@ nametoid_show(struct seq_file *m, struct cache_detail *cd, struct cache_head *h)
 			ent-&gt;type == IDMAP_TYPE_GROUP ? "group" : "user",
 			ent-&gt;name);
 	if (test_bit(CACHE_VALID, &amp;h-&gt;flags))
-		seq_printf(m, " %d", ent-&gt;id);
+		seq_printf(m, " %u", ent-&gt;id);
 	seq_printf(m, "\n");
 	return 0;
 }</pre><hr><pre>commit cb276805803b8e0616159d80a441ab26a931ada4
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Mon Jul 23 18:43:52 2007 -0700

    nfsd: fix possible oops on re-insertion of rpcsec_gss modules
    
    The handling of the re-registration case is wrong here; the "test" that was
    returned from auth_domain_lookup will not be used again, so that reference
    should be put.  And auth_domain_lookup never did anything with "new" in
    this case, so we should just clean it up ourself.
    
    Thanks to Akinobu Mita for bug report, analysis, and testing.
    
    Cc: Akinobu Mita &lt;akinobu.mita@gmail.com&gt;
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Cc: Neil Brown &lt;neilb@suse.de&gt;
    Cc: Trond Myklebust &lt;trond.myklebust@fys.uio.no&gt;
    Cc: &lt;stable@kernel.org&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/net/sunrpc/auth_gss/svcauth_gss.c b/net/sunrpc/auth_gss/svcauth_gss.c
index 490697542fc2..dc2f41e9f577 100644
--- a/net/sunrpc/auth_gss/svcauth_gss.c
+++ b/net/sunrpc/auth_gss/svcauth_gss.c
@@ -769,11 +769,12 @@ svcauth_gss_register_pseudoflavor(u32 pseudoflavor, char * name)
 	new-&gt;h.flavour = &amp;svcauthops_gss;
 	new-&gt;pseudoflavor = pseudoflavor;
 
+	stat = 0;
 	test = auth_domain_lookup(name, &amp;new-&gt;h);
-	if (test != &amp;new-&gt;h) { /* XXX Duplicate registration? */
-		auth_domain_put(&amp;new-&gt;h);
-		/* dangling ref-count... */
-		goto out;
+	if (test != &amp;new-&gt;h) { /* Duplicate registration */
+		auth_domain_put(test);
+		kfree(new-&gt;h.name);
+		goto out_free_dom;
 	}
 	return 0;
 </pre><hr><pre>commit 3e63516c826454c964eefdd24d33e188064c6679
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Jul 21 04:37:30 2007 -0700

    knfsd: fix typo in export display, print uid and gid as unsigned
    
    For display purposes, treat uid's and gid's as unsigned ints for now.
    Also fix a typo.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Cc: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/export.c b/fs/nfsd/export.c
index 6ab8de40904c..2d295dda4c1d 100644
--- a/fs/nfsd/export.c
+++ b/fs/nfsd/export.c
@@ -1503,9 +1503,9 @@ static void exp_flags(struct seq_file *m, int flag, int fsid,
 	if (flag &amp; NFSEXP_FSID)
 		seq_printf(m, ",fsid=%d", fsid);
 	if (anonu != (uid_t)-2 &amp;&amp; anonu != (0x10000-2))
-		seq_printf(m, ",sanonuid=%d", anonu);
+		seq_printf(m, ",anonuid=%u", anonu);
 	if (anong != (gid_t)-2 &amp;&amp; anong != (0x10000-2))
-		seq_printf(m, ",sanongid=%d", anong);
+		seq_printf(m, ",anongid=%u", anong);
 	if (fsloc &amp;&amp; fsloc-&gt;locations_count &gt; 0) {
 		char *loctype = (fsloc-&gt;migrated) ? "refer" : "replicas";
 		int i;</pre><hr><pre>commit be879c4e249a8875d7129f3b0c1bb62584dafbd8
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Wed Jul 11 18:39:02 2007 -0400

    SUNRPC: move bkl locking and xdr proc invocation into a common helper
    
    Since every invocation of xdr encode or decode functions takes the BKL now,
    there's a lot of redundant lock_kernel/unlock_kernel pairs that we can pull
    out into a common function.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;
    Signed-off-by: Trond Myklebust &lt;Trond.Myklebust@netapp.com&gt;

diff --git a/include/linux/sunrpc/xdr.h b/include/linux/sunrpc/xdr.h
index 9e340fa23c06..c6b53d181bfa 100644
--- a/include/linux/sunrpc/xdr.h
+++ b/include/linux/sunrpc/xdr.h
@@ -12,6 +12,7 @@
 #include &lt;linux/uio.h&gt;
 #include &lt;asm/byteorder.h&gt;
 #include &lt;linux/scatterlist.h&gt;
+#include &lt;linux/smp_lock.h&gt;
 
 /*
  * Buffer adjustment
@@ -35,6 +36,21 @@ struct xdr_netobj {
  */
 typedef int	(*kxdrproc_t)(void *rqstp, __be32 *data, void *obj);
 
+/*
+ * We're still requiring the BKL in the xdr code until it's been
+ * more carefully audited, at which point this wrapper will become
+ * unnecessary.
+ */
+static inline int rpc_call_xdrproc(kxdrproc_t xdrproc, void *rqstp, __be32 *data, void *obj)
+{
+	int ret;
+
+	lock_kernel();
+	ret = xdrproc(rqstp, data, obj);
+	unlock_kernel();
+	return ret;
+}
+
 /*
  * Basic structure for transmission/reception of a client XDR message.
  * Features a header (for a linear buffer containing RPC headers
diff --git a/net/sunrpc/auth.c b/net/sunrpc/auth.c
index 29a8ecc60928..1ea27559b1de 100644
--- a/net/sunrpc/auth.c
+++ b/net/sunrpc/auth.c
@@ -13,7 +13,6 @@
 #include &lt;linux/errno.h&gt;
 #include &lt;linux/sunrpc/clnt.h&gt;
 #include &lt;linux/spinlock.h&gt;
-#include &lt;linux/smp_lock.h&gt;
 
 #ifdef RPC_DEBUG
 # define RPCDBG_FACILITY	RPCDBG_AUTH
@@ -476,17 +475,13 @@ rpcauth_wrap_req(struct rpc_task *task, kxdrproc_t encode, void *rqstp,
 		__be32 *data, void *obj)
 {
 	struct rpc_cred *cred = task-&gt;tk_msg.rpc_cred;
-	int ret;
 
 	dprintk("RPC: %5u using %s cred %p to wrap rpc data\n",
 			task-&gt;tk_pid, cred-&gt;cr_ops-&gt;cr_name, cred);
 	if (cred-&gt;cr_ops-&gt;crwrap_req)
 		return cred-&gt;cr_ops-&gt;crwrap_req(task, encode, rqstp, data, obj);
 	/* By default, we encode the arguments normally. */
-	lock_kernel();
-	ret = encode(rqstp, data, obj);
-	unlock_kernel();
-	return ret;
+	return rpc_call_xdrproc(encode, rqstp, data, obj);
 }
 
 int
@@ -494,7 +489,6 @@ rpcauth_unwrap_resp(struct rpc_task *task, kxdrproc_t decode, void *rqstp,
 		__be32 *data, void *obj)
 {
 	struct rpc_cred *cred = task-&gt;tk_msg.rpc_cred;
-	int ret;
 
 	dprintk("RPC: %5u using %s cred %p to unwrap rpc data\n",
 			task-&gt;tk_pid, cred-&gt;cr_ops-&gt;cr_name, cred);
@@ -502,10 +496,7 @@ rpcauth_unwrap_resp(struct rpc_task *task, kxdrproc_t decode, void *rqstp,
 		return cred-&gt;cr_ops-&gt;crunwrap_resp(task, decode, rqstp,
 						   data, obj);
 	/* By default, we decode the arguments normally. */
-	lock_kernel();
-	ret = decode(rqstp, data, obj);
-	unlock_kernel();
-	return ret;
+	return rpc_call_xdrproc(decode, rqstp, data, obj);
 }
 
 int
diff --git a/net/sunrpc/auth_gss/auth_gss.c b/net/sunrpc/auth_gss/auth_gss.c
index abfda33bac64..4bbc59cc237c 100644
--- a/net/sunrpc/auth_gss/auth_gss.c
+++ b/net/sunrpc/auth_gss/auth_gss.c
@@ -43,7 +43,6 @@
 #include &lt;linux/types.h&gt;
 #include &lt;linux/slab.h&gt;
 #include &lt;linux/sched.h&gt;
-#include &lt;linux/smp_lock.h&gt;
 #include &lt;linux/pagemap.h&gt;
 #include &lt;linux/sunrpc/clnt.h&gt;
 #include &lt;linux/sunrpc/auth.h&gt;
@@ -1000,9 +999,7 @@ gss_wrap_req_integ(struct rpc_cred *cred, struct gss_cl_ctx *ctx,
 	offset = (u8 *)p - (u8 *)snd_buf-&gt;head[0].iov_base;
 	*p++ = htonl(rqstp-&gt;rq_seqno);
 
-	lock_kernel();
-	status = encode(rqstp, p, obj);
-	unlock_kernel();
+	status = rpc_call_xdrproc(encode, rqstp, p, obj);
 	if (status)
 		return status;
 
@@ -1096,9 +1093,7 @@ gss_wrap_req_priv(struct rpc_cred *cred, struct gss_cl_ctx *ctx,
 	offset = (u8 *)p - (u8 *)snd_buf-&gt;head[0].iov_base;
 	*p++ = htonl(rqstp-&gt;rq_seqno);
 
-	lock_kernel();
-	status = encode(rqstp, p, obj);
-	unlock_kernel();
+	status = rpc_call_xdrproc(encode, rqstp, p, obj);
 	if (status)
 		return status;
 
@@ -1157,16 +1152,12 @@ gss_wrap_req(struct rpc_task *task,
 		/* The spec seems a little ambiguous here, but I think that not
 		 * wrapping context destruction requests makes the most sense.
 		 */
-		lock_kernel();
-		status = encode(rqstp, p, obj);
-		unlock_kernel();
+		status = rpc_call_xdrproc(encode, rqstp, p, obj);
 		goto out;
 	}
 	switch (gss_cred-&gt;gc_service) {
 		case RPC_GSS_SVC_NONE:
-			lock_kernel();
-			status = encode(rqstp, p, obj);
-			unlock_kernel();
+			status = rpc_call_xdrproc(encode, rqstp, p, obj);
 			break;
 		case RPC_GSS_SVC_INTEGRITY:
 			status = gss_wrap_req_integ(cred, ctx, encode,
@@ -1282,9 +1273,7 @@ gss_unwrap_resp(struct rpc_task *task,
 	cred-&gt;cr_auth-&gt;au_rslack = cred-&gt;cr_auth-&gt;au_verfsize + (p - savedp)
 						+ (savedlen - head-&gt;iov_len);
 out_decode:
-	lock_kernel();
-	status = decode(rqstp, p, obj);
-	unlock_kernel();
+	status = rpc_call_xdrproc(decode, rqstp, p, obj);
 out:
 	gss_put_ctx(ctx);
 	dprintk("RPC: %5u gss_unwrap_resp returning %d\n", task-&gt;tk_pid,</pre><hr><pre>commit c7d51402d2a64c5b96531f9900bb368020ebbbbb
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Thu Jul 19 01:49:20 2007 -0700

    knfsd: clean up EX_RDONLY
    
    Share a little common code, reverse the arguments for consistency, drop the
    unnecessary "inline", and lowercase the name.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Acked-by: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/auth.c b/fs/nfsd/auth.c
index cf61dc8ae942..21928056e35e 100644
--- a/fs/nfsd/auth.c
+++ b/fs/nfsd/auth.c
@@ -9,10 +9,11 @@
 #include &lt;linux/sunrpc/svc.h&gt;
 #include &lt;linux/sunrpc/svcauth.h&gt;
 #include &lt;linux/nfsd/nfsd.h&gt;
+#include &lt;linux/nfsd/export.h&gt;
 
 #define	CAP_NFSD_MASK (CAP_FS_MASK|CAP_TO_MASK(CAP_SYS_RESOURCE))
 
-static int nfsexp_flags(struct svc_rqst *rqstp, struct svc_export *exp)
+int nfsexp_flags(struct svc_rqst *rqstp, struct svc_export *exp)
 {
 	struct exp_flavor_info *f;
 	struct exp_flavor_info *end = exp-&gt;ex_flavors + exp-&gt;ex_nflavors;
diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c
index f2684e57cf22..ee96a897a29e 100644
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -1797,16 +1797,9 @@ nfsd_statfs(struct svc_rqst *rqstp, struct svc_fh *fhp, struct kstatfs *stat)
 	return err;
 }
 
-static inline int EX_RDONLY(struct svc_export *exp, struct svc_rqst *rqstp)
+static int exp_rdonly(struct svc_rqst *rqstp, struct svc_export *exp)
 {
-	struct exp_flavor_info *f;
-	struct exp_flavor_info *end = exp-&gt;ex_flavors + exp-&gt;ex_nflavors;
-
-	for (f = exp-&gt;ex_flavors; f &lt; end; f++) {
-		if (f-&gt;pseudoflavor == rqstp-&gt;rq_flavor)
-			return f-&gt;flags &amp; NFSEXP_READONLY;
-	}
-	return exp-&gt;ex_flags &amp; NFSEXP_READONLY;
+	return nfsexp_flags(rqstp, exp) &amp; NFSEXP_READONLY;
 }
 
 /*
@@ -1845,7 +1838,7 @@ nfsd_permission(struct svc_rqst *rqstp, struct svc_export *exp,
 	 */
 	if (!(acc &amp; MAY_LOCAL_ACCESS))
 		if (acc &amp; (MAY_WRITE | MAY_SATTR | MAY_TRUNC)) {
-			if (EX_RDONLY(exp, rqstp) || IS_RDONLY(inode))
+			if (exp_rdonly(rqstp, exp) || IS_RDONLY(inode))
 				return nfserr_rofs;
 			if (/* (acc &amp; MAY_WRITE) &amp;&amp; */ IS_IMMUTABLE(inode))
 				return nfserr_perm;
diff --git a/include/linux/nfsd/export.h b/include/linux/nfsd/export.h
index fb4e93016666..5cd192469096 100644
--- a/include/linux/nfsd/export.h
+++ b/include/linux/nfsd/export.h
@@ -116,6 +116,7 @@ struct svc_expkey {
 #define EX_NOHIDE(exp)		((exp)-&gt;ex_flags &amp; NFSEXP_NOHIDE)
 #define EX_WGATHER(exp)		((exp)-&gt;ex_flags &amp; NFSEXP_GATHERED_WRITES)
 
+int nfsexp_flags(struct svc_rqst *rqstp, struct svc_export *exp);
 __be32 check_nfsd_access(struct svc_export *exp, struct svc_rqst *rqstp);
 
 /*</pre><hr><pre>commit e22841c637dc8b308b40f59d64a5b6683d458ab7
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Thu Jul 19 01:49:20 2007 -0700

    knfsd: move EX_RDONLY out of header
    
    EX_RDONLY is only called in one place; just put it there.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Acked-by: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c
index 5c97d0ea9e22..f2684e57cf22 100644
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -1797,6 +1797,18 @@ nfsd_statfs(struct svc_rqst *rqstp, struct svc_fh *fhp, struct kstatfs *stat)
 	return err;
 }
 
+static inline int EX_RDONLY(struct svc_export *exp, struct svc_rqst *rqstp)
+{
+	struct exp_flavor_info *f;
+	struct exp_flavor_info *end = exp-&gt;ex_flavors + exp-&gt;ex_nflavors;
+
+	for (f = exp-&gt;ex_flavors; f &lt; end; f++) {
+		if (f-&gt;pseudoflavor == rqstp-&gt;rq_flavor)
+			return f-&gt;flags &amp; NFSEXP_READONLY;
+	}
+	return exp-&gt;ex_flags &amp; NFSEXP_READONLY;
+}
+
 /*
  * Check for a user's access permissions to this inode.
  */
diff --git a/include/linux/nfsd/export.h b/include/linux/nfsd/export.h
index 78feb7beff75..fb4e93016666 100644
--- a/include/linux/nfsd/export.h
+++ b/include/linux/nfsd/export.h
@@ -116,18 +116,6 @@ struct svc_expkey {
 #define EX_NOHIDE(exp)		((exp)-&gt;ex_flags &amp; NFSEXP_NOHIDE)
 #define EX_WGATHER(exp)		((exp)-&gt;ex_flags &amp; NFSEXP_GATHERED_WRITES)
 
-static inline int EX_RDONLY(struct svc_export *exp, struct svc_rqst *rqstp)
-{
-	struct exp_flavor_info *f;
-	struct exp_flavor_info *end = exp-&gt;ex_flavors + exp-&gt;ex_nflavors;
-
-	for (f = exp-&gt;ex_flavors; f &lt; end; f++) {
-		if (f-&gt;pseudoflavor == rqstp-&gt;rq_flavor)
-			return f-&gt;flags &amp; NFSEXP_READONLY;
-	}
-	return exp-&gt;ex_flags &amp; NFSEXP_READONLY;
-}
-
 __be32 check_nfsd_access(struct svc_export *exp, struct svc_rqst *rqstp);
 
 /*</pre><hr><pre>commit 5d3dbbeaf56d0365ac6b5c0a0da0bd31cc4781e1
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Thu Jul 19 01:49:19 2007 -0700

    nfsd: remove unnecessary NULL checks from nfsd_cross_mnt
    
    We can now assume that rqst_exp_get_by_name() does not return NULL; so clean
    up some unnecessary checks.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Acked-by: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c
index b8da5ddb3a0a..5c97d0ea9e22 100644
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -120,14 +120,14 @@ nfsd_cross_mnt(struct svc_rqst *rqstp, struct dentry **dpp,
 		mntput(mnt);
 		goto out;
 	}
-	if (exp2 &amp;&amp; ((exp-&gt;ex_flags &amp; NFSEXP_CROSSMOUNT) || EX_NOHIDE(exp2))) {
+	if ((exp-&gt;ex_flags &amp; NFSEXP_CROSSMOUNT) || EX_NOHIDE(exp2)) {
 		/* successfully crossed mount point */
 		exp_put(exp);
 		*expp = exp2;
 		dput(dentry);
 		*dpp = mounts;
 	} else {
-		if (exp2) exp_put(exp2);
+		exp_put(exp2);
 		dput(mounts);
 	}
 	mntput(mnt);</pre><hr><pre>commit 9a25b96c1f6e1a3c85c9524f3046c7c75d8fecc7
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Thu Jul 19 01:49:18 2007 -0700

    nfsd: return errors, not NULL, from export functions
    
    I converted the various export-returning functions to return -ENOENT instead
    of NULL, but missed a few cases.
    
    This particular case could cause actual bugs in the case of a krb5 client that
    doesn't match any ip-based client and that is trying to access a filesystem
    not exported to krb5 clients.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Acked-by: Neil Brown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/export.c b/fs/nfsd/export.c
index c7bbf460b009..6ab8de40904c 100644
--- a/fs/nfsd/export.c
+++ b/fs/nfsd/export.c
@@ -1265,7 +1265,7 @@ struct svc_export *
 rqst_exp_get_by_name(struct svc_rqst *rqstp, struct vfsmount *mnt,
 		struct dentry *dentry)
 {
-	struct svc_export *gssexp, *exp = NULL;
+	struct svc_export *gssexp, *exp = ERR_PTR(-ENOENT);
 
 	if (rqstp-&gt;rq_client == NULL)
 		goto gss;
@@ -1288,7 +1288,7 @@ rqst_exp_get_by_name(struct svc_rqst *rqstp, struct vfsmount *mnt,
 						&amp;rqstp-&gt;rq_chandle);
 	if (PTR_ERR(gssexp) == -ENOENT)
 		return exp;
-	if (exp &amp;&amp; !IS_ERR(exp))
+	if (!IS_ERR(exp))
 		exp_put(exp);
 	return gssexp;
 }
@@ -1296,7 +1296,7 @@ rqst_exp_get_by_name(struct svc_rqst *rqstp, struct vfsmount *mnt,
 struct svc_export *
 rqst_exp_find(struct svc_rqst *rqstp, int fsid_type, u32 *fsidv)
 {
-	struct svc_export *gssexp, *exp = NULL;
+	struct svc_export *gssexp, *exp = ERR_PTR(-ENOENT);
 
 	if (rqstp-&gt;rq_client == NULL)
 		goto gss;
@@ -1318,7 +1318,7 @@ rqst_exp_find(struct svc_rqst *rqstp, int fsid_type, u32 *fsidv)
 						&amp;rqstp-&gt;rq_chandle);
 	if (PTR_ERR(gssexp) == -ENOENT)
 		return exp;
-	if (exp &amp;&amp; !IS_ERR(exp))
+	if (!IS_ERR(exp))
 		exp_put(exp);
 	return gssexp;
 }</pre><hr><pre>commit a280df32db291f41b3922ac218674be526af5b9b
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Thu Jul 19 01:49:18 2007 -0700

    nfsd: fix possible read-ahead cache and export table corruption
    
    The value of nperbucket calculated here is too small--we should be rounding up
    instead of down--with the result that the index j in the following loop can
    overflow the raparm_hash array.  At least in my case, the next thing in memory
    turns out to be export_table, so the symptoms I see are crashes caused by the
    appearance of four zeroed-out export entries in the first bucket of the hash
    table of exports (which were actually entries in the readahead cache, a
    pointer to which had been written to the export table in this initialization
    code).
    
    It looks like the bug was probably introduced with commit
    fce1456a19f5c08b688c29f00ef90fdfa074c79b ("knfsd: make the readahead params
    cache SMP-friendly").
    
    Cc: &lt;stable@kernel.org&gt;
    Cc: Greg Banks &lt;gnb@melbourne.sgi.com&gt;
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;
    Acked-by: NeilBrown &lt;neilb@suse.de&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/fs/nfsd/vfs.c b/fs/nfsd/vfs.c
index e90f4a8a1d01..b8da5ddb3a0a 100644
--- a/fs/nfsd/vfs.c
+++ b/fs/nfsd/vfs.c
@@ -1916,7 +1916,7 @@ nfsd_racache_init(int cache_size)
 		raparm_hash[i].pb_head = NULL;
 		spin_lock_init(&amp;raparm_hash[i].pb_lock);
 	}
-	nperbucket = cache_size &gt;&gt; RAPARM_HASH_BITS;
+	nperbucket = DIV_ROUND_UP(cache_size, RAPARM_HASH_SIZE);
 	for (i = 0; i &lt; cache_size - 1; i++) {
 		if (i % nperbucket == 0)
 			raparm_hash[j++].pb_head = raparml + i;</pre><hr><pre>commit 6924c55492c904695f13c552c461c2211f4fdd6a
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Fri May 11 16:22:50 2007 -0400

    locks: fix vfs_test_lock() comment
    
    Thanks to Doug Chapman for pointing out that the comment here is
    inconsistent with the function prototype.
    
    Signed-off-by: "J. Bruce Fields" &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/locks.c b/fs/locks.c
index 4a8072736efa..4f2d749ac624 100644
--- a/fs/locks.c
+++ b/fs/locks.c
@@ -1600,8 +1600,7 @@ asmlinkage long sys_flock(unsigned int fd, unsigned int cmd)
 /**
  * vfs_test_lock - test file byte range lock
  * @filp: The file to test lock for
- * @fl: The lock to test
- * @conf: Place to return a copy of the conflicting lock, if found
+ * @fl: The lock to test; also used to hold result
  *
  * Returns -ERRNO on failure.  Indicates presence of conflicting lock by
  * setting conf-&gt;fl_type to something other than F_UNLCK.</pre>
    <div class="pagination">
        <a href='4_43.html'>&lt;&lt;Prev</a><a href='4.html'>1</a><a href='4_2.html'>2</a><a href='4_3.html'>3</a><a href='4_4.html'>4</a><a href='4_5.html'>5</a><a href='4_6.html'>6</a><a href='4_7.html'>7</a><a href='4_8.html'>8</a><a href='4_9.html'>9</a><a href='4_10.html'>10</a><a href='4_11.html'>11</a><a href='4_12.html'>12</a><a href='4_13.html'>13</a><a href='4_14.html'>14</a><a href='4_15.html'>15</a><a href='4_16.html'>16</a><a href='4_17.html'>17</a><a href='4_18.html'>18</a><a href='4_19.html'>19</a><a href='4_20.html'>20</a><a href='4_21.html'>21</a><a href='4_22.html'>22</a><a href='4_23.html'>23</a><a href='4_24.html'>24</a><a href='4_25.html'>25</a><a href='4_26.html'>26</a><a href='4_27.html'>27</a><a href='4_28.html'>28</a><a href='4_29.html'>29</a><a href='4_30.html'>30</a><a href='4_31.html'>31</a><a href='4_32.html'>32</a><a href='4_33.html'>33</a><a href='4_34.html'>34</a><a href='4_35.html'>35</a><a href='4_36.html'>36</a><a href='4_37.html'>37</a><a href='4_38.html'>38</a><a href='4_39.html'>39</a><a href='4_40.html'>40</a><a href='4_41.html'>41</a><a href='4_42.html'>42</a><a href='4_43.html'>43</a><span>[44]</span><a href='4_45.html'>45</a><a href='4_46.html'>46</a><a href='4_47.html'>47</a><a href='4_48.html'>48</a><a href='4_49.html'>49</a><a href='4_50.html'>50</a><a href='4_51.html'>51</a><a href='4_52.html'>52</a><a href='4_53.html'>53</a><a href='4_54.html'>54</a><a href='4_55.html'>55</a><a href='4_56.html'>56</a><a href='4_57.html'>57</a><a href='4_45.html'>Next&gt;&gt;</a>
    <div>
</body>
