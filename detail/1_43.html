<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Massachusetts Institute of Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Massachusetts Institute of Technology</h1>
    <div class="pagination">
        <a href='1_42.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><span>[43]</span><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><a href='1_77.html'>77</a><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><a href='1_144.html'>144</a><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_44.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 6e4862a5bb9d12be87e4ea5d9a60836ebed71d28
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sun Mar 9 00:46:23 2014 -0500

    jbd2: minimize region locked by j_list_lock in journal_get_create_access()
    
    It's not needed until we start trying to modifying fields in the
    journal_head which are protected by j_list_lock.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index 78900a1252b2..357f3dc5201f 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -1073,7 +1073,6 @@ int jbd2_journal_get_create_access(handle_t *handle, struct buffer_head *bh)
 	 * reused here.
 	 */
 	jbd_lock_bh_state(bh);
-	spin_lock(&amp;journal-&gt;j_list_lock);
 	J_ASSERT_JH(jh, (jh-&gt;b_transaction == transaction ||
 		jh-&gt;b_transaction == NULL ||
 		(jh-&gt;b_transaction == journal-&gt;j_committing_transaction &amp;&amp;
@@ -1096,12 +1095,14 @@ int jbd2_journal_get_create_access(handle_t *handle, struct buffer_head *bh)
 		jh-&gt;b_modified = 0;
 
 		JBUFFER_TRACE(jh, "file as BJ_Reserved");
+		spin_lock(&amp;journal-&gt;j_list_lock);
 		__jbd2_journal_file_buffer(jh, transaction, BJ_Reserved);
 	} else if (jh-&gt;b_transaction == journal-&gt;j_committing_transaction) {
 		/* first access by this transaction */
 		jh-&gt;b_modified = 0;
 
 		JBUFFER_TRACE(jh, "set next transaction");
+		spin_lock(&amp;journal-&gt;j_list_lock);
 		jh-&gt;b_next_transaction = transaction;
 	}
 	spin_unlock(&amp;journal-&gt;j_list_lock);</pre><hr><pre>commit d2eb0b998990abf51d6e1d3bf16a2637b920a660
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sun Mar 9 00:07:19 2014 -0500

    jbd2: check jh-&gt;b_transaction without taking j_list_lock
    
    jh-&gt;b_transaction is adequately protected for reading by the
    jbd_lock_bh_state(bh), so we don't need to take j_list_lock in
    __journal_try_to_free_buffer().
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/transaction.c b/fs/jbd2/transaction.c
index 60bb365f54a5..78900a1252b2 100644
--- a/fs/jbd2/transaction.c
+++ b/fs/jbd2/transaction.c
@@ -1821,11 +1821,11 @@ __journal_try_to_free_buffer(journal_t *journal, struct buffer_head *bh)
 	if (buffer_locked(bh) || buffer_dirty(bh))
 		goto out;
 
-	if (jh-&gt;b_next_transaction != NULL)
+	if (jh-&gt;b_next_transaction != NULL || jh-&gt;b_transaction != NULL)
 		goto out;
 
 	spin_lock(&amp;journal-&gt;j_list_lock);
-	if (jh-&gt;b_cp_transaction != NULL &amp;&amp; jh-&gt;b_transaction == NULL) {
+	if (jh-&gt;b_cp_transaction != NULL) {
 		/* written-back checkpointed metadata buffer */
 		JBUFFER_TRACE(jh, "remove from checkpoint list");
 		__jbd2_journal_remove_checkpoint(jh);</pre><hr><pre>commit d4e839d4a9dc31d0c229e616146b01e1ace56604
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Mar 8 22:34:10 2014 -0500

    jbd2: add transaction to checkpoint list earlier
    
    We don't otherwise need j_list_lock during the rest of commit phase
    #7, so add the transaction to the checkpoint list at the very end of
    commit phase #6.  This allows us to drop j_list_lock earlier, which is
    a good thing since it is a super hot lock.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/commit.c b/fs/jbd2/commit.c
index af36252b5b2d..5f26139a165a 100644
--- a/fs/jbd2/commit.c
+++ b/fs/jbd2/commit.c
@@ -1065,6 +1065,25 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 		goto restart_loop;
 	}
 
+	/* Add the transaction to the checkpoint list
+	 * __journal_remove_checkpoint() can not destroy transaction
+	 * under us because it is not marked as T_FINISHED yet */
+	if (journal-&gt;j_checkpoint_transactions == NULL) {
+		journal-&gt;j_checkpoint_transactions = commit_transaction;
+		commit_transaction-&gt;t_cpnext = commit_transaction;
+		commit_transaction-&gt;t_cpprev = commit_transaction;
+	} else {
+		commit_transaction-&gt;t_cpnext =
+			journal-&gt;j_checkpoint_transactions;
+		commit_transaction-&gt;t_cpprev =
+			commit_transaction-&gt;t_cpnext-&gt;t_cpprev;
+		commit_transaction-&gt;t_cpnext-&gt;t_cpprev =
+			commit_transaction;
+		commit_transaction-&gt;t_cpprev-&gt;t_cpnext =
+				commit_transaction;
+	}
+	spin_unlock(&amp;journal-&gt;j_list_lock);
+
 	/* Done with this transaction! */
 
 	jbd_debug(3, "JBD2: commit phase 7\n");
@@ -1103,24 +1122,6 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 
 	write_unlock(&amp;journal-&gt;j_state_lock);
 
-	if (journal-&gt;j_checkpoint_transactions == NULL) {
-		journal-&gt;j_checkpoint_transactions = commit_transaction;
-		commit_transaction-&gt;t_cpnext = commit_transaction;
-		commit_transaction-&gt;t_cpprev = commit_transaction;
-	} else {
-		commit_transaction-&gt;t_cpnext =
-			journal-&gt;j_checkpoint_transactions;
-		commit_transaction-&gt;t_cpprev =
-			commit_transaction-&gt;t_cpnext-&gt;t_cpprev;
-		commit_transaction-&gt;t_cpnext-&gt;t_cpprev =
-			commit_transaction;
-		commit_transaction-&gt;t_cpprev-&gt;t_cpnext =
-				commit_transaction;
-	}
-	spin_unlock(&amp;journal-&gt;j_list_lock);
-	/* Drop all spin_locks because commit_callback may be block.
-	 * __journal_remove_checkpoint() can not destroy transaction
-	 * under us because it is not marked as T_FINISHED yet */
 	if (journal-&gt;j_commit_callback)
 		journal-&gt;j_commit_callback(journal, commit_transaction);
 
@@ -1131,7 +1132,7 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 	write_lock(&amp;journal-&gt;j_state_lock);
 	spin_lock(&amp;journal-&gt;j_list_lock);
 	commit_transaction-&gt;t_state = T_FINISHED;
-	/* Recheck checkpoint lists after j_list_lock was dropped */
+	/* Check if the transaction can be dropped now that we are finished */
 	if (commit_transaction-&gt;t_checkpoint_list == NULL &amp;&amp;
 	    commit_transaction-&gt;t_checkpoint_io_list == NULL) {
 		__jbd2_journal_drop_transaction(journal, commit_transaction);</pre><hr><pre>commit 42cf3452d5f5b0817d27c93e4e7d7eab6e89077d
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Mar 8 19:51:16 2014 -0500

    jbd2: calculate statistics without holding j_state_lock and j_list_lock
    
    The two hottest locks, and thus the biggest scalability bottlenecks,
    in the jbd2 layer, are the j_list_lock and j_state_lock.  This has
    inspired some people to do some truly unnatural things[1].
    
    [1] https://www.usenix.org/system/files/conference/fast14/fast14-paper_kang.pdf
    
    We don't need to be holding both j_state_lock and j_list_lock while
    calculating the journal statistics, so move those calculations to the
    very end of jbd2_journal_commit_transaction.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/commit.c b/fs/jbd2/commit.c
index 765b31da4029..af36252b5b2d 100644
--- a/fs/jbd2/commit.c
+++ b/fs/jbd2/commit.c
@@ -1083,24 +1083,7 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 		atomic_read(&amp;commit_transaction-&gt;t_handle_count);
 	trace_jbd2_run_stats(journal-&gt;j_fs_dev-&gt;bd_dev,
 			     commit_transaction-&gt;t_tid, &amp;stats.run);
-
-	/*
-	 * Calculate overall stats
-	 */
-	spin_lock(&amp;journal-&gt;j_history_lock);
-	journal-&gt;j_stats.ts_tid++;
-	if (commit_transaction-&gt;t_requested)
-		journal-&gt;j_stats.ts_requested++;
-	journal-&gt;j_stats.run.rs_wait += stats.run.rs_wait;
-	journal-&gt;j_stats.run.rs_request_delay += stats.run.rs_request_delay;
-	journal-&gt;j_stats.run.rs_running += stats.run.rs_running;
-	journal-&gt;j_stats.run.rs_locked += stats.run.rs_locked;
-	journal-&gt;j_stats.run.rs_flushing += stats.run.rs_flushing;
-	journal-&gt;j_stats.run.rs_logging += stats.run.rs_logging;
-	journal-&gt;j_stats.run.rs_handle_count += stats.run.rs_handle_count;
-	journal-&gt;j_stats.run.rs_blocks += stats.run.rs_blocks;
-	journal-&gt;j_stats.run.rs_blocks_logged += stats.run.rs_blocks_logged;
-	spin_unlock(&amp;journal-&gt;j_history_lock);
+	stats.ts_requested = (commit_transaction-&gt;t_requested) ? 1 : 0;
 
 	commit_transaction-&gt;t_state = T_COMMIT_CALLBACK;
 	J_ASSERT(commit_transaction == journal-&gt;j_committing_transaction);
@@ -1157,4 +1140,21 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 	spin_unlock(&amp;journal-&gt;j_list_lock);
 	write_unlock(&amp;journal-&gt;j_state_lock);
 	wake_up(&amp;journal-&gt;j_wait_done_commit);
+
+	/*
+	 * Calculate overall stats
+	 */
+	spin_lock(&amp;journal-&gt;j_history_lock);
+	journal-&gt;j_stats.ts_tid++;
+	journal-&gt;j_stats.ts_requested += stats.ts_requested;
+	journal-&gt;j_stats.run.rs_wait += stats.run.rs_wait;
+	journal-&gt;j_stats.run.rs_request_delay += stats.run.rs_request_delay;
+	journal-&gt;j_stats.run.rs_running += stats.run.rs_running;
+	journal-&gt;j_stats.run.rs_locked += stats.run.rs_locked;
+	journal-&gt;j_stats.run.rs_flushing += stats.run.rs_flushing;
+	journal-&gt;j_stats.run.rs_logging += stats.run.rs_logging;
+	journal-&gt;j_stats.run.rs_handle_count += stats.run.rs_handle_count;
+	journal-&gt;j_stats.run.rs_blocks += stats.run.rs_blocks;
+	journal-&gt;j_stats.run.rs_blocks_logged += stats.run.rs_blocks_logged;
+	spin_unlock(&amp;journal-&gt;j_history_lock);
 }</pre><hr><pre>commit 3469a32a1e948c54204b5dd6f7476a7d11349e9e
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Mar 8 19:11:36 2014 -0500

    jbd2: don't hold j_state_lock while calling wake_up()
    
    The j_state_lock is one of the hottest locks in the jbd2 layer and
    thus one of its scalability bottlenecks.
    
    We don't need to be holding the j_state_lock while we are calling
    wake_up(&amp;journal-&gt;j_wait_commit), so release the lock a little bit
    earlier.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/journal.c b/fs/jbd2/journal.c
index 244b6f6b7908..67b8e303946c 100644
--- a/fs/jbd2/journal.c
+++ b/fs/jbd2/journal.c
@@ -302,8 +302,8 @@ static void journal_kill_thread(journal_t *journal)
 	journal-&gt;j_flags |= JBD2_UNMOUNT;
 
 	while (journal-&gt;j_task) {
-		wake_up(&amp;journal-&gt;j_wait_commit);
 		write_unlock(&amp;journal-&gt;j_state_lock);
+		wake_up(&amp;journal-&gt;j_wait_commit);
 		wait_event(journal-&gt;j_wait_done_commit, journal-&gt;j_task == NULL);
 		write_lock(&amp;journal-&gt;j_state_lock);
 	}
@@ -710,8 +710,8 @@ int jbd2_log_wait_commit(journal_t *journal, tid_t tid)
 	while (tid_gt(tid, journal-&gt;j_commit_sequence)) {
 		jbd_debug(1, "JBD2: want %d, j_commit_sequence=%d\n",
 				  tid, journal-&gt;j_commit_sequence);
-		wake_up(&amp;journal-&gt;j_wait_commit);
 		read_unlock(&amp;journal-&gt;j_state_lock);
+		wake_up(&amp;journal-&gt;j_wait_commit);
 		wait_event(journal-&gt;j_wait_done_commit,
 				!tid_gt(tid, journal-&gt;j_commit_sequence));
 		read_lock(&amp;journal-&gt;j_state_lock);</pre><hr><pre>commit df3c1e9a05ff25aca9f54a6c08b77003e2e32bf1
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Sat Mar 8 18:13:52 2014 -0500

    jbd2: don't unplug after writing revoke records
    
    During commit process, keep the block device plugged after we are done
    writing the revoke records, until we are finished writing the rest of
    the commit records in the journal.  This will allow most of the
    journal blocks to be written in a single I/O operation, instead of
    separating the the revoke blocks from the rest of the journal blocks.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/jbd2/commit.c b/fs/jbd2/commit.c
index cf2fc0594063..765b31da4029 100644
--- a/fs/jbd2/commit.c
+++ b/fs/jbd2/commit.c
@@ -555,7 +555,6 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 	blk_start_plug(&amp;plug);
 	jbd2_journal_write_revoke_records(journal, commit_transaction,
 					  &amp;log_bufs, WRITE_SYNC);
-	blk_finish_plug(&amp;plug);
 
 	jbd_debug(3, "JBD2: commit phase 2b\n");
 
@@ -582,7 +581,6 @@ void jbd2_journal_commit_transaction(journal_t *journal)
 	err = 0;
 	bufs = 0;
 	descriptor = NULL;
-	blk_start_plug(&amp;plug);
 	while (commit_transaction-&gt;t_buffers) {
 
 		/* Find the next buffer to be journaled... */</pre><hr><pre>commit e861b5e9a47bd8c6a7491a2b9f6e9a230b1b8e86
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Thu Feb 20 12:54:05 2014 -0500

    ext4: avoid possible overflow in ext4_map_blocks()
    
    The ext4_map_blocks() function returns the number of blocks which
    satisfying the caller's request.  This number of blocks requested by
    the caller is specified by an unsigned integer, but the return value
    of ext4_map_blocks() is a signed integer (to accomodate error codes
    per the kernel's standard error signalling convention).
    
    Historically, overflows could never happen since mballoc() will refuse
    to allocate more than 2048 blocks at a time (which is something we
    should fix), and if the blocks were already allocated, the fact that
    there would be some number of intervening metadata blocks pretty much
    guaranteed that there could never be a contiguous region of data
    blocks that was greater than 2**31 blocks.
    
    However, this is now possible if there is a file system which is a bit
    bigger than 8TB, and is created using the new mke2fs hugeblock
    feature, which can create a perfectly contiguous file.  In that case,
    if a userspace program attempted to call fallocate() on this already
    fully allocated file, it's possible that ext4_map_blocks() could
    return a number large enough that it would overflow a signed integer,
    resulting in a ext4 thinking that the ext4_map_blocks() call had
    failed with some strange error code.
    
    Since ext4_map_blocks() is always free to return a smaller number of
    blocks than what was requested by the caller, fix this by capping the
    number of blocks that ext4_map_blocks() will ever try to map to 2**31
    - 1.  In practice this should never get hit, except by someone
    deliberately trying to provke the above-described bug.
    
    Thanks to the PaX team for asking whethre this could possibly happen
    in some off-line discussions about using some static code checking
    technology they are developing to find bugs in kernel code.
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/inode.c b/fs/ext4/inode.c
index 6e39895a91b8..113458c9d08b 100644
--- a/fs/ext4/inode.c
+++ b/fs/ext4/inode.c
@@ -514,6 +514,12 @@ int ext4_map_blocks(handle_t *handle, struct inode *inode,
 		  "logical block %lu\n", inode-&gt;i_ino, flags, map-&gt;m_len,
 		  (unsigned long) map-&gt;m_lblk);
 
+	/*
+	 * ext4_map_blocks returns an int, and m_len is an unsigned int
+	 */
+	if (unlikely(map-&gt;m_len &gt; INT_MAX))
+		map-&gt;m_len = INT_MAX;
+
 	/* Lookup extent status tree firstly */
 	if (ext4_es_lookup_extent(inode, map-&gt;m_lblk, &amp;es)) {
 		ext4_es_lru_add(inode);</pre><hr><pre>commit ab0c00fccf81dcf1dc5db0e389294ffea53be666
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Thu Feb 20 00:36:41 2014 -0500

    ext4: make sure ex.fe_logical is initialized
    
    The lowest levels of mballoc set all of the fields of struct
    ext4_free_extent except for fe_logical, since they are just trying to
    find the requested free set of blocks, and the logical block hasn't
    been set yet.  This makes some static code checkers sad.  Set it to
    various different debug values, which would be useful when
    debugging mballoc if these values were to ever show up due to the
    parts of mballoc triyng to use ac-&gt;ac_b_ex.fe_logical before it is
    properly upper layers of mballoc failing to properly set, usually by
    ext4_mb_use_best_found().
    
    Addresses-Coverity-Id: #139697
    Addresses-Coverity-Id: #139698
    Addresses-Coverity-Id: #139699
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.c
index 04a5c7504be9..0d42f635dda9 100644
--- a/fs/ext4/mballoc.c
+++ b/fs/ext4/mballoc.c
@@ -1808,6 +1808,7 @@ int ext4_mb_find_by_goal(struct ext4_allocation_context *ac,
 	ext4_lock_group(ac-&gt;ac_sb, group);
 	max = mb_find_extent(e4b, ac-&gt;ac_g_ex.fe_start,
 			     ac-&gt;ac_g_ex.fe_len, &amp;ex);
+	ex.fe_logical = 0xDEADFA11; /* debug value */
 
 	if (max &gt;= ac-&gt;ac_g_ex.fe_len &amp;&amp; ac-&gt;ac_g_ex.fe_len == sbi-&gt;s_stripe) {
 		ext4_fsblk_t start;
@@ -1936,7 +1937,7 @@ void ext4_mb_complex_scan_group(struct ext4_allocation_context *ac,
 			 */
 			break;
 		}
-
+		ex.fe_logical = 0xDEADC0DE; /* debug value */
 		ext4_mb_measure_extent(ac, &amp;ex, e4b);
 
 		i += ex.fe_len;
@@ -1977,6 +1978,7 @@ void ext4_mb_scan_aligned(struct ext4_allocation_context *ac,
 			max = mb_find_extent(e4b, i, sbi-&gt;s_stripe, &amp;ex);
 			if (max &gt;= sbi-&gt;s_stripe) {
 				ac-&gt;ac_found++;
+				ex.fe_logical = 0xDEADF00D; /* debug value */
 				ac-&gt;ac_b_ex = ex;
 				ext4_mb_use_best_found(ac, e4b);
 				break;</pre><hr><pre>commit 7b1b2c1b9c397dcb86293ae79aa7fb7c5446120f
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Wed Feb 19 20:15:21 2014 -0500

    ext4: don't calculate total xattr header size unless needed
    
    The function ext4_expand_extra_isize_ea() doesn't need the size of all
    of the extended attribute headers.  So if we don't calculate it when
    it is unneeded, it we can skip some undeeded memory references, and as
    a bonus, we eliminate some kvetching by static code analysis tools.
    
    Addresses-Coverity-Id: #741291
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;

diff --git a/fs/ext4/xattr.c b/fs/ext4/xattr.c
index e175e94116ac..185066f475f1 100644
--- a/fs/ext4/xattr.c
+++ b/fs/ext4/xattr.c
@@ -567,12 +567,13 @@ static size_t ext4_xattr_free_space(struct ext4_xattr_entry *last,
 				    size_t *min_offs, void *base, int *total)
 {
 	for (; !IS_LAST_ENTRY(last); last = EXT4_XATTR_NEXT(last)) {
-		*total += EXT4_XATTR_LEN(last-&gt;e_name_len);
 		if (!last-&gt;e_value_block &amp;&amp; last-&gt;e_value_size) {
 			size_t offs = le16_to_cpu(last-&gt;e_value_offs);
 			if (offs &lt; *min_offs)
 				*min_offs = offs;
 		}
+		if (total)
+			*total += EXT4_XATTR_LEN(last-&gt;e_name_len);
 	}
 	return (*min_offs - ((void *)last - base) - sizeof(__u32));
 }
@@ -1228,7 +1229,7 @@ int ext4_expand_extra_isize_ea(struct inode *inode, int new_extra_isize,
 	struct ext4_xattr_block_find *bs = NULL;
 	char *buffer = NULL, *b_entry_name = NULL;
 	size_t min_offs, free;
-	int total_ino, total_blk;
+	int total_ino;
 	void *base, *start, *end;
 	int extra_isize = 0, error = 0, tried_min_extra_isize = 0;
 	int s_min_extra_isize = le16_to_cpu(EXT4_SB(inode-&gt;i_sb)-&gt;s_es-&gt;s_min_extra_isize);
@@ -1286,8 +1287,7 @@ int ext4_expand_extra_isize_ea(struct inode *inode, int new_extra_isize,
 		first = BFIRST(bh);
 		end = bh-&gt;b_data + bh-&gt;b_size;
 		min_offs = end - base;
-		free = ext4_xattr_free_space(first, &amp;min_offs, base,
-					     &amp;total_blk);
+		free = ext4_xattr_free_space(first, &amp;min_offs, base, NULL);
 		if (free &lt; new_extra_isize) {
 			if (!tried_min_extra_isize &amp;&amp; s_min_extra_isize) {
 				tried_min_extra_isize++;</pre><hr><pre>commit 9a6633b1a3603ccdffec669033616f9ebb35a988
Author: Theodore Ts'o &lt;tytso@mit.edu&gt;
Date:   Wed Feb 19 20:15:15 2014 -0500

    ext4: add ext4_es_store_pblock_status()
    
    Avoid false positives by static code analysis tools such as sparse and
    coverity caused by the fact that we set the physical block, and then
    the status in the extent_status structure.  It is also more efficient
    to set both of these values at once.
    
    Addresses-Coverity-Id: #989077
    Addresses-Coverity-Id: #989078
    Addresses-Coverity-Id: #1080722
    
    Signed-off-by: "Theodore Ts'o" &lt;tytso@mit.edu&gt;
    Reviewed-by: Zheng Liu &lt;wenqing.lz@taobao.com&gt;

diff --git a/fs/ext4/extents_status.c b/fs/ext4/extents_status.c
index 3981ff783950..a900004a63e1 100644
--- a/fs/ext4/extents_status.c
+++ b/fs/ext4/extents_status.c
@@ -658,8 +658,7 @@ int ext4_es_insert_extent(struct inode *inode, ext4_lblk_t lblk,
 
 	newes.es_lblk = lblk;
 	newes.es_len = len;
-	ext4_es_store_pblock(&amp;newes, pblk);
-	ext4_es_store_status(&amp;newes, status);
+	ext4_es_store_pblock_status(&amp;newes, pblk, status);
 	trace_ext4_es_insert_extent(inode, &amp;newes);
 
 	ext4_es_insert_extent_check(inode, &amp;newes);
@@ -699,8 +698,7 @@ void ext4_es_cache_extent(struct inode *inode, ext4_lblk_t lblk,
 
 	newes.es_lblk = lblk;
 	newes.es_len = len;
-	ext4_es_store_pblock(&amp;newes, pblk);
-	ext4_es_store_status(&amp;newes, status);
+	ext4_es_store_pblock_status(&amp;newes, pblk, status);
 	trace_ext4_es_cache_extent(inode, &amp;newes);
 
 	if (!len)
@@ -812,13 +810,13 @@ static int __es_remove_extent(struct inode *inode, ext4_lblk_t lblk,
 
 			newes.es_lblk = end + 1;
 			newes.es_len = len2;
+			block = 0x7FDEADBEEF;
 			if (ext4_es_is_written(&amp;orig_es) ||
-			    ext4_es_is_unwritten(&amp;orig_es)) {
+			    ext4_es_is_unwritten(&amp;orig_es))
 				block = ext4_es_pblock(&amp;orig_es) +
 					orig_es.es_len - len2;
-				ext4_es_store_pblock(&amp;newes, block);
-			}
-			ext4_es_store_status(&amp;newes, ext4_es_status(&amp;orig_es));
+			ext4_es_store_pblock_status(&amp;newes, block,
+						    ext4_es_status(&amp;orig_es));
 			err = __es_insert_extent(inode, &amp;newes);
 			if (err) {
 				es-&gt;es_lblk = orig_es.es_lblk;
diff --git a/fs/ext4/extents_status.h b/fs/ext4/extents_status.h
index 167f4ab8ecc3..f1b62a419920 100644
--- a/fs/ext4/extents_status.h
+++ b/fs/ext4/extents_status.h
@@ -129,6 +129,15 @@ static inline void ext4_es_store_status(struct extent_status *es,
 		       (es-&gt;es_pblk &amp; ~ES_MASK));
 }
 
+static inline void ext4_es_store_pblock_status(struct extent_status *es,
+					       ext4_fsblk_t pb,
+					       unsigned int status)
+{
+	es-&gt;es_pblk = (((ext4_fsblk_t)
+			(status &amp; EXTENT_STATUS_FLAGS) &lt;&lt; ES_SHIFT) |
+		       (pb &amp; ~ES_MASK));
+}
+
 extern void ext4_es_register_shrinker(struct ext4_sb_info *sbi);
 extern void ext4_es_unregister_shrinker(struct ext4_sb_info *sbi);
 extern void ext4_es_lru_add(struct inode *inode);</pre>
    <div class="pagination">
        <a href='1_42.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><span>[43]</span><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><a href='1_77.html'>77</a><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><a href='1_144.html'>144</a><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_44.html'>Next&gt;&gt;</a>
    <div>
</body>
