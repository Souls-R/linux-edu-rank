<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Shenzhen University</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Shenzhen University</h1>
    <div class="pagination">
        <a href='21_2.html'>&lt;&lt;Prev</a><a href='21.html'>1</a><a href='21_2.html'>2</a><span>[3]</span><a href='21_4.html'>4</a><a href='21_4.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 56465a38305f22bca3469c2738d7320a0c333e72
Author: Jiajian Ye &lt;yejiajian2018@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:09:23 2022 -0700

    tools/vm/page_owner_sort.c: add a security check
    
    Add a security check after using malloc() to allocate memory.
    
    Link: https://lkml.kernel.org/r/20220301151438.166118-2-yejiajian2018@email.szu.edu.cn
    Signed-off-by: Jiajian Ye &lt;yejiajian2018@email.szu.edu.cn&gt;
    Cc: Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;
    Cc: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
    Cc: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index 79d69c3b84ed..69fb6ca7c0b7 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -217,7 +217,13 @@ static void add_list(char *buf, int len)
 		printf("max_size too small??\n");
 		exit(1);
 	}
+
 	list[list_size].txt = malloc(len+1);
+	if (!list[list_size].txt) {
+		printf("Out of memory\n");
+		exit(1);
+	}
+
 	list[list_size].len = len;
 	list[list_size].num = 1;
 	list[list_size].page_num = get_page_num(buf);</pre><hr><pre>commit 59d7cb27d528eae2f060d548dcd14d292b19fda3
Author: Jiajian Ye &lt;yejiajian2018@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:09:20 2022 -0700

    tools/vm/page_owner_sort.c: fix comments
    
    Two adjustments are made:
    
    1. Correct a grammatical error: replace the "what" in "Do the job what
       you want to debug" with "that".
    
    2. Replace "has not been" with "has been" in the description of the -f
       option: According to Commit b1c9ba071e7d ("tools/vm/page_owner_sort.c:
       fix the instructions for use"), the description of the "-f" option is
       "Filter out the information of blocks whose memory has been released."
    
    Link: https://lkml.kernel.org/r/20220301151438.166118-1-yejiajian2018@email.szu.edu.cn
    Signed-off-by: Jiajian Ye &lt;yejiajian2018@email.szu.edu.cn&gt;
    Cc: Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;
    Cc: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
    Cc: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/Documentation/vm/page_owner.rst b/Documentation/vm/page_owner.rst
index 6591e518819f..2ddb632d847b 100644
--- a/Documentation/vm/page_owner.rst
+++ b/Documentation/vm/page_owner.rst
@@ -78,7 +78,7 @@ Usage
 
 2) Enable page owner: add "page_owner=on" to boot cmdline.
 
-3) Do the job what you want to debug
+3) Do the job that you want to debug.
 
 4) Analyze information from page owner::
 
@@ -126,4 +126,4 @@ Usage
 		-c		Cull by comparing stacktrace instead of total block.
 
 	Filter:
-		-f		Filter out the information of blocks whose memory has not been released.
+		-f		Filter out the information of blocks whose memory has been released.</pre><hr><pre>commit 49e495a015e9cc127728b0f353a15d16da138fb8
Author: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:09:17 2022 -0700

    tools/vm/page_owner_sort.c: fix the instructions for use
    
    I noticed a discrepancy between the usage method and the code logic.
    
    If we enable the -f option, it should be "Filter out the information of
    blocks whose memory has been released".
    
    Link: https://lkml.kernel.org/r/20220219143106.2805-1-caoyixuan2019@email.szu.edu.cn
    Signed-off-by: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Cc: Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;
    Cc: Sean Anderson &lt;seanga2@gmail.com&gt;
    Cc: Muchun Song &lt;songmuchun@bytedance.com&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Cc: Tang Bin &lt;tangbin@cmss.chinamobile.com&gt;
    Cc: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index c8ec2d6b314d..79d69c3b84ed 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -246,7 +246,7 @@ static void usage(void)
 		"-a	Sort by memory allocate time.\n"
 		"-r	Sort by memory release time.\n"
 		"-c	Cull by comparing stacktrace instead of total block.\n"
-		"-f	Filter out the information of blocks whose memory has not been released.\n"
+		"-f	Filter out the information of blocks whose memory has been released.\n"
 	);
 }
 </pre><hr><pre>commit bf215eab785a30756ea1e53b62a5638d1177a795
Author: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:09:14 2022 -0700

    mm/page_owner.c: record tgid
    
    In a single-threaded process, the pid in kernel task_struct is the same
    as the tgid, which can mark the process of page allocation.  But in a
    multithreaded process, only the task_struct of the thread leader has the
    same pid as tgid, and the pids of other threads are different from tgid.
    Therefore, tgid is recorded to provide effective information for
    debugging and data statistics of multithreaded programs.
    
    This can also be achieved by observing the task name (executable file
    name) for a specific process.  However, when the same program is started
    multiple times, the task name is the same and the tgid is different.
    Therefore, in the debugging of multi-threaded programs, combined with
    the task name and tgid, more accurate runtime information of a certain
    run of the program can be obtained.
    
    Link: https://lkml.kernel.org/r/20220219180450.2399-1-caoyixuan2019@email.szu.edu.cn
    Signed-off-by: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Cc: Waiman Long &lt;longman@redhat.com&gt;
    Cc: Rafael Aquini &lt;aquini@redhat.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/mm/page_owner.c b/mm/page_owner.c
index d56afa9c792e..fb3a05fdebdb 100644
--- a/mm/page_owner.c
+++ b/mm/page_owner.c
@@ -31,6 +31,7 @@ struct page_owner {
 	u64 free_ts_nsec;
 	char comm[TASK_COMM_LEN];
 	pid_t pid;
+	pid_t tgid;
 };
 
 static bool page_owner_enabled = false;
@@ -165,6 +166,7 @@ static inline void __set_page_owner_handle(struct page_ext *page_ext,
 		page_owner-&gt;gfp_mask = gfp_mask;
 		page_owner-&gt;last_migrate_reason = -1;
 		page_owner-&gt;pid = current-&gt;pid;
+		page_owner-&gt;tgid = current-&gt;tgid;
 		page_owner-&gt;ts_nsec = local_clock();
 		strlcpy(page_owner-&gt;comm, current-&gt;comm,
 			sizeof(page_owner-&gt;comm));
@@ -233,6 +235,7 @@ void __folio_copy_owner(struct folio *newfolio, struct folio *old)
 		old_page_owner-&gt;last_migrate_reason;
 	new_page_owner-&gt;handle = old_page_owner-&gt;handle;
 	new_page_owner-&gt;pid = old_page_owner-&gt;pid;
+	new_page_owner-&gt;tgid = old_page_owner-&gt;tgid;
 	new_page_owner-&gt;ts_nsec = old_page_owner-&gt;ts_nsec;
 	new_page_owner-&gt;free_ts_nsec = old_page_owner-&gt;ts_nsec;
 	strcpy(new_page_owner-&gt;comm, old_page_owner-&gt;comm);
@@ -383,11 +386,11 @@ print_page_owner(char __user *buf, size_t count, unsigned long pfn,
 		return -ENOMEM;
 
 	ret = scnprintf(kbuf, count,
-			"Page allocated via order %u, mask %#x(%pGg), pid %d (%s), ts %llu ns, free_ts %llu ns\n",
+			"Page allocated via order %u, mask %#x(%pGg), pid %d, tgid %d (%s), ts %llu ns, free_ts %llu ns\n",
 			page_owner-&gt;order, page_owner-&gt;gfp_mask,
 			&amp;page_owner-&gt;gfp_mask, page_owner-&gt;pid,
-			page_owner-&gt;comm, page_owner-&gt;ts_nsec,
-			page_owner-&gt;free_ts_nsec);
+			page_owner-&gt;tgid, page_owner-&gt;comm,
+			page_owner-&gt;ts_nsec, page_owner-&gt;free_ts_nsec);
 
 	/* Print information relevant to grouping pages by mobility */
 	pageblock_mt = get_pageblock_migratetype(page);
@@ -454,10 +457,10 @@ void __dump_page_owner(const struct page *page)
 	else
 		pr_alert("page_owner tracks the page as freed\n");
 
-	pr_alert("page last allocated via order %u, migratetype %s, gfp_mask %#x(%pGg), pid %d (%s), ts %llu, free_ts %llu\n",
+	pr_alert("page last allocated via order %u, migratetype %s, gfp_mask %#x(%pGg), pid %d, tgid %d (%s), ts %llu, free_ts %llu\n",
 		 page_owner-&gt;order, migratetype_names[mt], gfp_mask, &amp;gfp_mask,
-		 page_owner-&gt;pid, page_owner-&gt;comm, page_owner-&gt;ts_nsec,
-		 page_owner-&gt;free_ts_nsec);
+		 page_owner-&gt;pid, page_owner-&gt;tgid, page_owner-&gt;comm,
+		 page_owner-&gt;ts_nsec, page_owner-&gt;free_ts_nsec);
 
 	handle = READ_ONCE(page_owner-&gt;handle);
 	if (!handle)</pre><hr><pre>commit 57f2b54a937987847e666aaf56d207aa457adee6
Author: Shenghong Han &lt;hanshenghong2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:08:56 2022 -0700

    Documentation/vm/page_owner.rst: update the documentation
    
    Update the documentation of ``page_owner``.
    
    [akpm@linux-foundation.org: small grammatical tweaks]
    
    Link: https://lkml.kernel.org/r/20211214134736.2569-1-hanshenghong2019@email.szu.edu.cn
    Signed-off-by: Shenghong Han &lt;hanshenghong2019@email.szu.edu.cn&gt;
    Cc: Jonathan Corbet &lt;corbet@lwn.net&gt;
    Cc: Vlastimil Babka &lt;vbabka@suse.cz&gt;
    Cc: Georgi Djakov &lt;georgi.djakov@linaro.org&gt;
    Cc: Liam Mark &lt;lmark@codeaurora.org&gt;
    Cc: Tang Bin &lt;tangbin@cmss.chinamobile.com&gt;
    Cc: Zhang Shengju &lt;zhangshengju@cmss.chinamobile.com&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Cc: Xiaoming Ni &lt;nixiaoming@huawei.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/Documentation/vm/page_owner.rst b/Documentation/vm/page_owner.rst
index 905555e3e483..6420097a1f7d 100644
--- a/Documentation/vm/page_owner.rst
+++ b/Documentation/vm/page_owner.rst
@@ -97,7 +97,7 @@ Usage
 
    The ``page_owner_sort`` tool ignores ``PFN`` rows, puts the remaining rows
    in buf, uses regexp to extract the page order value, counts the times
-   and pages of buf, and finally sorts them according to the times.
+   and pages of buf, and finally sorts them according to the parameter(s).
 
    See the result about who allocated each page
    in the ``sorted_page_owner.txt``. General output::
@@ -107,4 +107,23 @@ Usage
 	 // Detailed stack
 
    By default, ``page_owner_sort`` is sorted according to the times of buf.
-   If you want to sort by the pages nums of buf, use the ``-m`` parameter.
+   If you want to sort by the page nums of buf, use the ``-m`` parameter.
+   The detailed parameters are:
+
+   fundamental function:
+
+	Sort:
+		-a		Sort by memory allocation time.
+		-m		Sort by total memory.
+		-p		Sort by pid.
+		-r		Sort by memory release time.
+		-s		Sort by stack trace.
+		-t		Sort by times (default).
+
+   additional function:
+
+	Cull:
+		-c		Cull by comparing stacktrace instead of total block.
+
+	Filter:
+		-f		Filter out the information of blocks whose memory has not been released.</pre><hr><pre>commit 41ed64347b5db8f6c9359d4f87f768db1a83bd79
Author: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:08:53 2022 -0700

    tools/vm/page_owner_sort.c: delete invalid duplicate code
    
    I noticed that there is two invalid lines of duplicate code.  It's better
    to delete it.
    
    Link: https://lkml.kernel.org/r/20211213095743.3630-1-caoyixuan2019@email.szu.edu.cn
    Signed-off-by: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Cc: Mark Brown &lt;broonie@kernel.org&gt;
    Cc: Sean Anderson &lt;seanga2@gmail.com&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Cc: Tang Bin &lt;tangbin@cmss.chinamobile.com&gt;
    Cc: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index 284a5070402c..c8ec2d6b314d 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -227,8 +227,6 @@ static void add_list(char *buf, int len)
 	list[list_size].pid = get_pid(buf);
 	list[list_size].ts_nsec = get_ts_nsec(buf);
 	list[list_size].free_ts_nsec = get_free_ts_nsec(buf);
-	memcpy(list[list_size].txt, buf, len);
-	list[list_size].txt[len] = 0;
 	list_size++;
 	if (list_size % 1000 == 0) {
 		printf("loaded %d\r", list_size);</pre><hr><pre>commit e7a3f6776905b4e0b61692add3d0808315379c89
Author: Shenghong Han &lt;hanshenghong2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:08:50 2022 -0700

    tools/vm/page_owner_sort.c: two trivial fixes
    
    1) There is an unused variable. It's better to delete it.
    2) One case is missing in the usage().
    
    Link: https://lkml.kernel.org/r/20211213164518.2461-1-hanshenghong2019@email.szu.edu.cn
    Signed-off-by: Shenghong Han &lt;hanshenghong2019@email.szu.edu.cn&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index c9fedc1806d5..284a5070402c 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -41,8 +41,6 @@ static struct block_list *list;
 static int list_size;
 static int max_size;
 
-struct block_list *block_head;
-
 int read_block(char *buf, int buf_size, FILE *fin)
 {
 	char *curr = buf, *const buf_end = buf + buf_size;
@@ -249,7 +247,8 @@ static void usage(void)
 		"-p	Sort by pid.\n"
 		"-a	Sort by memory allocate time.\n"
 		"-r	Sort by memory release time.\n"
-		"-c	cull by comparing stacktrace instead of total block.\n"
+		"-c	Cull by comparing stacktrace instead of total block.\n"
+		"-f	Filter out the information of blocks whose memory has not been released.\n"
 	);
 }
 </pre><hr><pre>commit 8f9c447e2e2b53c2db4fac85fc42ecada8b39e52
Author: Chongxi Zhao &lt;zhaochongxi2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:08:47 2022 -0700

    tools/vm/page_owner_sort.c: support sorting pid and time
    
    When viewing the page owner information, we expect that the information
    can be sorted by PID, so that we can quickly combine PID with the program
    to check the information together.
    
    We also expect that the information can be sorted by time.  Time sorting
    helps to view the running status of the program according to the time
    interval when the program hangs up.
    
    Finally, we hope to pass the page_ owner_ Sort.  C can reduce part of the
    output and only output the plate information whose memory has not been
    released, which can make us locate the problem of the program faster.
    Therefore, the following adjustments have been made:
    
    1. Add the static functions search_pattern and check_regcomp to
       improve the cleanliness.
    
    2. Add member attributes and their corresponding sorting methods.  In
       terms of comparison time, int will overflow because the data of ull is
       too large, so the ternary operator is used
    
    3. Add the -f parameter to filter out the information of blocks whose
       memory has not been released
    
    Link: https://lkml.kernel.org/r/20211206165653.5093-1-zhaochongxi2019@email.szu.edu.cn
    Signed-off-by: Chongxi Zhao &lt;zhaochongxi2019@email.szu.edu.cn&gt;
    Reviewed-by: Sean Anderson &lt;seanga2@gmail.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index 492be7f752c0..c9fedc1806d5 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -20,6 +20,7 @@
 #include &lt;string.h&gt;
 #include &lt;regex.h&gt;
 #include &lt;errno.h&gt;
+#include &lt;linux/types.h&gt;
 
 struct block_list {
 	char *txt;
@@ -27,9 +28,15 @@ struct block_list {
 	int len;
 	int num;
 	int page_num;
+	pid_t pid;
+	__u64 ts_nsec;
+	__u64 free_ts_nsec;
 };
 
 static regex_t order_pattern;
+static regex_t pid_pattern;
+static regex_t ts_nsec_pattern;
+static regex_t free_ts_nsec_pattern;
 static struct block_list *list;
 static int list_size;
 static int max_size;
@@ -79,34 +86,124 @@ static int compare_page_num(const void *p1, const void *p2)
 	return l2-&gt;page_num - l1-&gt;page_num;
 }
 
-static int get_page_num(char *buf)
+static int compare_pid(const void *p1, const void *p2)
 {
-	int err, val_len, order_val;
-	char order_str[4] = {0};
-	char *endptr;
+	const struct block_list *l1 = p1, *l2 = p2;
+
+	return l1-&gt;pid - l2-&gt;pid;
+}
+
+static int compare_ts(const void *p1, const void *p2)
+{
+	const struct block_list *l1 = p1, *l2 = p2;
+
+	return l1-&gt;ts_nsec &lt; l2-&gt;ts_nsec ? -1 : 1;
+}
+
+static int compare_free_ts(const void *p1, const void *p2)
+{
+	const struct block_list *l1 = p1, *l2 = p2;
+
+	return l1-&gt;free_ts_nsec &lt; l2-&gt;free_ts_nsec ? -1 : 1;
+}
+
+static int search_pattern(regex_t *pattern, char *pattern_str, char *buf)
+{
+	int err, val_len;
 	regmatch_t pmatch[2];
 
-	err = regexec(&amp;order_pattern, buf, 2, pmatch, REG_NOTBOL);
+	err = regexec(pattern, buf, 2, pmatch, REG_NOTBOL);
 	if (err != 0 || pmatch[1].rm_so == -1) {
-		printf("no order pattern in %s\n", buf);
-		return 0;
+		printf("no matching pattern in %s\n", buf);
+		return -1;
 	}
 	val_len = pmatch[1].rm_eo - pmatch[1].rm_so;
-	if (val_len &gt; 2) /* max_order should not exceed 2 digits */
-		goto wrong_order;
 
-	memcpy(order_str, buf + pmatch[1].rm_so, val_len);
+	memcpy(pattern_str, buf + pmatch[1].rm_so, val_len);
+
+	return 0;
+}
+
+static void check_regcomp(regex_t *pattern, const char *regex)
+{
+	int err;
+
+	err = regcomp(pattern, regex, REG_EXTENDED | REG_NEWLINE);
+	if (err != 0 || pattern-&gt;re_nsub != 1) {
+		printf("Invalid pattern %s code %d\n", regex, err);
+		exit(1);
+	}
+}
+
+# define FIELD_BUFF 25
+
+static int get_page_num(char *buf)
+{
+	int order_val;
+	char order_str[FIELD_BUFF] = {0};
+	char *endptr;
 
+	search_pattern(&amp;order_pattern, order_str, buf);
 	errno = 0;
 	order_val = strtol(order_str, &amp;endptr, 10);
-	if (errno != 0 || endptr == order_str || *endptr != '\0')
-		goto wrong_order;
+	if (order_val &gt; 64 || errno != 0 || endptr == order_str || *endptr != '\0') {
+		printf("wrong order in follow buf:\n%s\n", buf);
+		return 0;
+	}
 
 	return 1 &lt;&lt; order_val;
+}
 
-wrong_order:
-	printf("wrong order in follow buf:\n%s\n", buf);
-	return 0;
+static pid_t get_pid(char *buf)
+{
+	pid_t pid;
+	char pid_str[FIELD_BUFF] = {0};
+	char *endptr;
+
+	search_pattern(&amp;pid_pattern, pid_str, buf);
+	errno = 0;
+	pid = strtol(pid_str, &amp;endptr, 10);
+	if (errno != 0 || endptr == pid_str || *endptr != '\0') {
+		printf("wrong/invalid pid in follow buf:\n%s\n", buf);
+		return -1;
+	}
+
+	return pid;
+
+}
+
+static __u64 get_ts_nsec(char *buf)
+{
+	__u64 ts_nsec;
+	char ts_nsec_str[FIELD_BUFF] = {0};
+	char *endptr;
+
+	search_pattern(&amp;ts_nsec_pattern, ts_nsec_str, buf);
+	errno = 0;
+	ts_nsec = strtoull(ts_nsec_str, &amp;endptr, 10);
+	if (errno != 0 || endptr == ts_nsec_str || *endptr != '\0') {
+		printf("wrong ts_nsec in follow buf:\n%s\n", buf);
+		return -1;
+	}
+
+	return ts_nsec;
+}
+
+static __u64 get_free_ts_nsec(char *buf)
+{
+	__u64 free_ts_nsec;
+	char free_ts_nsec_str[FIELD_BUFF] = {0};
+	char *endptr;
+
+	search_pattern(&amp;free_ts_nsec_pattern, free_ts_nsec_str, buf);
+	errno = 0;
+	free_ts_nsec = strtoull(free_ts_nsec_str, &amp;endptr, 10);
+	if (errno != 0 || endptr == free_ts_nsec_str || *endptr != '\0') {
+		printf("wrong free_ts_nsec in follow buf:\n%s\n", buf);
+		return -1;
+	}
+
+	return free_ts_nsec;
 }
 
 static void add_list(char *buf, int len)
@@ -129,6 +226,11 @@ static void add_list(char *buf, int len)
 	memcpy(list[list_size].txt, buf, len);
 	list[list_size].txt[len] = 0;
 	list[list_size].stacktrace = strchr(list[list_size].txt, '\n') ?: "";
+	list[list_size].pid = get_pid(buf);
+	list[list_size].ts_nsec = get_ts_nsec(buf);
+	list[list_size].free_ts_nsec = get_free_ts_nsec(buf);
+	memcpy(list[list_size].txt, buf, len);
+	list[list_size].txt[len] = 0;
 	list_size++;
 	if (list_size % 1000 == 0) {
 		printf("loaded %d\r", list_size);
@@ -144,6 +246,9 @@ static void usage(void)
 		"-m	Sort by total memory.\n"
 		"-s	Sort by the stack trace.\n"
 		"-t	Sort by times (default).\n"
+		"-p	Sort by pid.\n"
+		"-a	Sort by memory allocate time.\n"
+		"-r	Sort by memory release time.\n"
 		"-c	cull by comparing stacktrace instead of total block.\n"
 	);
 }
@@ -152,28 +257,40 @@ int main(int argc, char **argv)
 {
 	int (*cmp)(const void *, const void *) = compare_num;
 	int cull_st = 0;
+	int filter = 0;
 	FILE *fin, *fout;
 	char *buf;
 	int ret, i, count;
 	struct block_list *list2;
 	struct stat st;
-	int err;
 	int opt;
 
-	while ((opt = getopt(argc, argv, "mstc")) != -1)
+	while ((opt = getopt(argc, argv, "acfmprst")) != -1)
 		switch (opt) {
+		case 'a':
+			cmp = compare_ts;
+			break;
+		case 'c':
+			cull_st = 1;
+			break;
+		case 'f':
+			filter = 1;
+			break;
 		case 'm':
 			cmp = compare_page_num;
 			break;
+		case 'p':
+			cmp = compare_pid;
+			break;
+		case 'r':
+			cmp = compare_free_ts;
+			break;
 		case 's':
 			cmp = compare_stacktrace;
 			break;
 		case 't':
 			cmp = compare_num;
 			break;
-		case 'c':
-			cull_st = 1;
-			break;
 		default:
 			usage();
 			exit(1);
@@ -192,13 +309,10 @@ int main(int argc, char **argv)
 		exit(1);
 	}
 
-	err = regcomp(&amp;order_pattern, "order\\s*([0-9]*),", REG_EXTENDED|REG_NEWLINE);
-	if (err != 0 || order_pattern.re_nsub != 1) {
-		printf("%s: Invalid pattern 'order\\s*([0-9]*),' code %d\n",
-			argv[0], err);
-		exit(1);
-	}
-
+	check_regcomp(&amp;order_pattern, "order\\s*([0-9]*),");
+	check_regcomp(&amp;pid_pattern, "pid\\s*([0-9]*),");
+	check_regcomp(&amp;ts_nsec_pattern, "ts\\s*([0-9]*)\\s*ns,");
+	check_regcomp(&amp;free_ts_nsec_pattern, "free_ts\\s*([0-9]*)\\s*ns");
 	fstat(fileno(fin), &amp;st);
 	max_size = st.st_size / 100; /* hack ... */
 
@@ -248,10 +362,15 @@ int main(int argc, char **argv)
 
 	qsort(list2, count, sizeof(list[0]), cmp);
 
-	for (i = 0; i &lt; count; i++)
+	for (i = 0; i &lt; count; i++) {
+		if (filter == 1 &amp;&amp; list2[i].free_ts_nsec != 0)
+			continue;
 		fprintf(fout, "%d times, %d pages:\n%s\n",
 				list2[i].num, list2[i].page_num, list2[i].txt);
-
+	}
 	regfree(&amp;order_pattern);
+	regfree(&amp;pid_pattern);
+	regfree(&amp;ts_nsec_pattern);
+	regfree(&amp;free_ts_nsec_pattern);
 	return 0;
 }</pre><hr><pre>commit cd75ea0e32620c622aeaef531ef7b9f59c67f7a6
Author: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
Date:   Thu Mar 24 18:08:44 2022 -0700

    tools/vm/page_owner_sort.c: add switch between culling by stacktrace and txt
    
    Culling by comparing stacktrace would casue loss of some information.  For
    example, if there exists 2 blocks which have the same stacktrace and the
    different head info
    
      Page allocated via order 0, mask 0x108c48(...), pid 73696,
        ts 1578829190639010 ns, free_ts 1576583851324450 ns
        prep_new_page+0x80/0xb8
        get_page_from_freelist+0x924/0xee8
        __alloc_pages+0x138/0xc18
        alloc_pages+0x80/0xf0
        __page_cache_alloc+0x90/0xc8
    
      Page allocated via order 0, mask 0x108c48(...), pid 61806,
        ts 1354113726046100 ns, free_ts 1354104926841400 ns
        prep_new_page+0x80/0xb8
        get_page_from_freelist+0x924/0xee8
        __alloc_pages+0x138/0xc18
        alloc_pages+0x80/0xf0
        __page_cache_alloc+0x90/0xc8
    
    After culling, it would be like this
    
      2 times, 2 pages:
      Page allocated via order 0, mask 0x108c48(...), pid 73696,
        ts 1578829190639010 ns, free_ts 1576583851324450 ns
        prep_new_page+0x80/0xb8
        get_page_from_freelist+0x924/0xee8
        __alloc_pages+0x138/0xc18
        alloc_pages+0x80/0xf0
        __page_cache_alloc+0x90/0xc8
    
    The info of second block missed.  So, add -c to turn on culling by
    stacktrace.  By default, it will cull by txt.
    
    Link: https://lkml.kernel.org/r/20211129145658.2491-1-zhangyinan2019@email.szu.edu.cn
    Signed-off-by: Yinan Zhang &lt;zhangyinan2019@email.szu.edu.cn&gt;
    Cc: Changhee Han &lt;ch0.han@lge.com&gt;
    Cc: Sean Anderson &lt;seanga2@gmail.com&gt;
    Cc: Stephen Rothwell &lt;sfr@canb.auug.org.au&gt;
    Cc: Tang Bin &lt;tangbin@cmss.chinamobile.com&gt;
    Cc: Zhang Shengju &lt;zhangshengju@cmss.chinamobile.com&gt;
    Cc: Zhenliang Wei &lt;weizhenliang@huawei.com&gt;
    Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/tools/vm/page_owner_sort.c b/tools/vm/page_owner_sort.c
index 1b2acf02d3cd..492be7f752c0 100644
--- a/tools/vm/page_owner_sort.c
+++ b/tools/vm/page_owner_sort.c
@@ -51,6 +51,13 @@ int read_block(char *buf, int buf_size, FILE *fin)
 	return -1; /* EOF or no space left in buf. */
 }
 
+static int compare_txt(const void *p1, const void *p2)
+{
+	const struct block_list *l1 = p1, *l2 = p2;
+
+	return strcmp(l1-&gt;txt, l2-&gt;txt);
+}
+
 static int compare_stacktrace(const void *p1, const void *p2)
 {
 	const struct block_list *l1 = p1, *l2 = p2;
@@ -137,12 +144,14 @@ static void usage(void)
 		"-m	Sort by total memory.\n"
 		"-s	Sort by the stack trace.\n"
 		"-t	Sort by times (default).\n"
+		"-c	cull by comparing stacktrace instead of total block.\n"
 	);
 }
 
 int main(int argc, char **argv)
 {
 	int (*cmp)(const void *, const void *) = compare_num;
+	int cull_st = 0;
 	FILE *fin, *fout;
 	char *buf;
 	int ret, i, count;
@@ -151,7 +160,7 @@ int main(int argc, char **argv)
 	int err;
 	int opt;
 
-	while ((opt = getopt(argc, argv, "mst")) != -1)
+	while ((opt = getopt(argc, argv, "mstc")) != -1)
 		switch (opt) {
 		case 'm':
 			cmp = compare_page_num;
@@ -162,6 +171,9 @@ int main(int argc, char **argv)
 		case 't':
 			cmp = compare_num;
 			break;
+		case 'c':
+			cull_st = 1;
+			break;
 		default:
 			usage();
 			exit(1);
@@ -209,7 +221,10 @@ int main(int argc, char **argv)
 
 	printf("sorting ....\n");
 
-	qsort(list, list_size, sizeof(list[0]), compare_stacktrace);
+	if (cull_st == 1)
+		qsort(list, list_size, sizeof(list[0]), compare_stacktrace);
+	else
+		qsort(list, list_size, sizeof(list[0]), compare_txt);
 
 	list2 = malloc(sizeof(*list) * list_size);
 	if (!list2) {
@@ -219,9 +234,11 @@ int main(int argc, char **argv)
 
 	printf("culling\n");
 
+	long offset = cull_st ? &amp;list[0].stacktrace - &amp;list[0].txt : 0;
+
 	for (i = count = 0; i &lt; list_size; i++) {
 		if (count == 0 ||
-		    strcmp(list2[count-1].stacktrace, list[i].stacktrace) != 0) {
+		    strcmp(*(&amp;list2[count-1].txt+offset), *(&amp;list[i].txt+offset)) != 0) {
 			list2[count++] = list[i];
 		} else {
 			list2[count-1].num += list[i].num;</pre><hr><pre>commit 024314d6d540a24cfe029421ad7e97e1d6e886b2
Author: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
Date:   Wed Feb 23 21:41:04 2022 +0800

    Documentation/vm/page_owner.rst: fix language
    
    There are some words that need to be fixed.
    
    Thanks for Shuah Khan's constructive suggestions.
    The text has been fixed as follows.
    
    a. So, if you'd like to use it, you need
    to add "page_owner=on" into your boot cmdline.
    
    Here, "into" has been replaced with "to".
    
    b. ...page owner is disabled in runtime due to no
    enabling, boot option, runtime overhead is marginal.
    
    Here, "no" has been replaced with "not".
    
    Signed-off-by: Yixuan Cao &lt;caoyixuan2019@email.szu.edu.cn&gt;
    Acked-by: Randy Dunlap &lt;rdunlap@infradead.org&gt;
    Link: https://lore.kernel.org/r/20220223134104.2663-1-caoyixuan2019@email.szu.edu.cn
    Signed-off-by: Jonathan Corbet &lt;corbet@lwn.net&gt;

diff --git a/Documentation/vm/page_owner.rst b/Documentation/vm/page_owner.rst
index 9837fc8147dd..bc28edaf3de1 100644
--- a/Documentation/vm/page_owner.rst
+++ b/Documentation/vm/page_owner.rst
@@ -26,9 +26,9 @@ fragmentation statistics can be obtained through gfp flag information of
 each page. It is already implemented and activated if page owner is
 enabled. Other usages are more than welcome.
 
-page owner is disabled in default. So, if you'd like to use it, you need
-to add "page_owner=on" into your boot cmdline. If the kernel is built
-with page owner and page owner is disabled in runtime due to no enabling
+page owner is disabled by default. So, if you'd like to use it, you need
+to add "page_owner=on" to your boot cmdline. If the kernel is built
+with page owner and page owner is disabled in runtime due to not enabling
 boot option, runtime overhead is marginal. If disabled in runtime, it
 doesn't require memory to store owner information, so there is no runtime
 memory overhead. And, page owner inserts just two unlikely branches into</pre>
    <div class="pagination">
        <a href='21_2.html'>&lt;&lt;Prev</a><a href='21.html'>1</a><a href='21_2.html'>2</a><span>[3]</span><a href='21_4.html'>4</a><a href='21_4.html'>Next&gt;&gt;</a>
    <div>
</body>
