<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Zhejiang University</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Zhejiang University</h1>
    <div class="pagination">
        <a href='6_22.html'>&lt;&lt;Prev</a><a href='6.html'>1</a><a href='6_2.html'>2</a><a href='6_3.html'>3</a><a href='6_4.html'>4</a><a href='6_5.html'>5</a><a href='6_6.html'>6</a><a href='6_7.html'>7</a><a href='6_8.html'>8</a><a href='6_9.html'>9</a><a href='6_10.html'>10</a><a href='6_11.html'>11</a><a href='6_12.html'>12</a><a href='6_13.html'>13</a><a href='6_14.html'>14</a><a href='6_15.html'>15</a><a href='6_16.html'>16</a><a href='6_17.html'>17</a><a href='6_18.html'>18</a><a href='6_19.html'>19</a><a href='6_20.html'>20</a><a href='6_21.html'>21</a><a href='6_22.html'>22</a><span>[23]</span><a href='6_24.html'>24</a><a href='6_25.html'>25</a><a href='6_26.html'>26</a><a href='6_27.html'>27</a><a href='6_28.html'>28</a><a href='6_29.html'>29</a><a href='6_30.html'>30</a><a href='6_31.html'>31</a><a href='6_32.html'>32</a><a href='6_33.html'>33</a><a href='6_34.html'>34</a><a href='6_35.html'>35</a><a href='6_36.html'>36</a><a href='6_24.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit e2cb6b891ad2b8caa9131e3be70f45243df82a80
Author: Lin Ma &lt;linma@zju.edu.cn&gt;
Date:   Mon Apr 12 19:17:57 2021 +0800

    bluetooth: eliminate the potential race condition when removing the HCI controller
    
    There is a possible race condition vulnerability between issuing a HCI
    command and removing the cont.  Specifically, functions hci_req_sync()
    and hci_dev_do_close() can race each other like below:
    
    thread-A in hci_req_sync()      |   thread-B in hci_dev_do_close()
                                    |   hci_req_sync_lock(hdev);
    test_bit(HCI_UP, &amp;hdev-&gt;flags); |
    ...                             |   test_and_clear_bit(HCI_UP, &amp;hdev-&gt;flags)
    hci_req_sync_lock(hdev);        |
                                    |
    In this commit we alter the sequence in function hci_req_sync(). Hence,
    the thread-A cannot issue th.
    
    Signed-off-by: Lin Ma &lt;linma@zju.edu.cn&gt;
    Cc: Marcel Holtmann &lt;marcel@holtmann.org&gt;
    Fixes: 7c6a329e4447 ("[Bluetooth] Fix regression from using default link policy")
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;

diff --git a/net/bluetooth/hci_request.c b/net/bluetooth/hci_request.c
index e55976db4403..805ce546b813 100644
--- a/net/bluetooth/hci_request.c
+++ b/net/bluetooth/hci_request.c
@@ -272,12 +272,16 @@ int hci_req_sync(struct hci_dev *hdev, int (*req)(struct hci_request *req,
 {
 	int ret;
 
-	if (!test_bit(HCI_UP, &amp;hdev-&gt;flags))
-		return -ENETDOWN;
-
 	/* Serialize all requests */
 	hci_req_sync_lock(hdev);
-	ret = __hci_req_sync(hdev, req, opt, timeout, hci_status);
+	/* check the state after obtaing the lock to protect the HCI_UP
+	 * against any races from hci_dev_do_close when the controller
+	 * gets removed.
+	 */
+	if (test_bit(HCI_UP, &amp;hdev-&gt;flags))
+		ret = __hci_req_sync(hdev, req, opt, timeout, hci_status);
+	else
+		ret = -ENETDOWN;
 	hci_req_sync_unlock(hdev);
 
 	return ret;</pre><hr><pre>commit 58eaa7b2d07d3c25e1068b0bf42ca7e7464f4bca
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Thu Apr 15 15:46:44 2021 +0800

    spi: spi-zynqmp-gqspi: Fix runtime PM imbalance in zynqmp_qspi_probe
    
    There is a PM usage counter decrement after zynqmp_qspi_init_hw()
    without any refcount increment, which leads to refcount leak.Add
    a refcount increment to balance the refcount. Also set
    auto_runtime_pm to resume suspended spi controller.
    
    Fixes: 9e3a000362aec ("spi: zynqmp: Add pm runtime support")
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Tested-by: Quanyang Wang &lt;quanyang.wang@windriver.com&gt;
    Link: https://lore.kernel.org/r/20210415074644.24646-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/drivers/spi/spi-zynqmp-gqspi.c b/drivers/spi/spi-zynqmp-gqspi.c
index 408e348382c5..32e53f379e9b 100644
--- a/drivers/spi/spi-zynqmp-gqspi.c
+++ b/drivers/spi/spi-zynqmp-gqspi.c
@@ -1163,11 +1163,16 @@ static int zynqmp_qspi_probe(struct platform_device *pdev)
 	pm_runtime_set_autosuspend_delay(&amp;pdev-&gt;dev, SPI_AUTOSUSPEND_TIMEOUT);
 	pm_runtime_set_active(&amp;pdev-&gt;dev);
 	pm_runtime_enable(&amp;pdev-&gt;dev);
+
+	ret = pm_runtime_get_sync(&amp;pdev-&gt;dev);
+	if (ret &lt; 0) {
+		dev_err(&amp;pdev-&gt;dev, "Failed to pm_runtime_get_sync: %d\n", ret);
+		goto clk_dis_all;
+	}
+
 	/* QSPI controller initializations */
 	zynqmp_qspi_init_hw(xqspi);
 
-	pm_runtime_mark_last_busy(&amp;pdev-&gt;dev);
-	pm_runtime_put_autosuspend(&amp;pdev-&gt;dev);
 	xqspi-&gt;irq = platform_get_irq(pdev, 0);
 	if (xqspi-&gt;irq &lt;= 0) {
 		ret = -ENXIO;
@@ -1190,6 +1195,7 @@ static int zynqmp_qspi_probe(struct platform_device *pdev)
 	ctlr-&gt;mode_bits = SPI_CPOL | SPI_CPHA | SPI_RX_DUAL | SPI_RX_QUAD |
 			    SPI_TX_DUAL | SPI_TX_QUAD;
 	ctlr-&gt;dev.of_node = np;
+	ctlr-&gt;auto_runtime_pm = true;
 
 	ret = devm_spi_register_controller(&amp;pdev-&gt;dev, ctlr);
 	if (ret) {
@@ -1197,9 +1203,13 @@ static int zynqmp_qspi_probe(struct platform_device *pdev)
 		goto clk_dis_all;
 	}
 
+	pm_runtime_mark_last_busy(&amp;pdev-&gt;dev);
+	pm_runtime_put_autosuspend(&amp;pdev-&gt;dev);
+
 	return 0;
 
 clk_dis_all:
+	pm_runtime_put_sync(&amp;pdev-&gt;dev);
 	pm_runtime_set_suspended(&amp;pdev-&gt;dev);
 	pm_runtime_disable(&amp;pdev-&gt;dev);
 	clk_disable_unprepare(xqspi-&gt;refclk);</pre><hr><pre>commit fe6df2b48043bbe1e852b2320501d3b169363c35
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Wed Apr 7 13:11:49 2021 +0800

    mfd: arizona: Fix rumtime PM imbalance on error
    
    pm_runtime_get_sync() will increase the rumtime PM counter
    even it returns an error. Thus a pairing decrement is needed
    to prevent refcount leak. Fix this by replacing this API with
    pm_runtime_resume_and_get(), which will not change the runtime
    PM counter on error.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Acked-by: Charles Keepax &lt;ckeepax@opensource.cirrus.com&gt;
    Signed-off-by: Lee Jones &lt;lee.jones@linaro.org&gt;

diff --git a/drivers/mfd/arizona-irq.c b/drivers/mfd/arizona-irq.c
index 077d9ab112b7..d919ae9691e2 100644
--- a/drivers/mfd/arizona-irq.c
+++ b/drivers/mfd/arizona-irq.c
@@ -100,7 +100,7 @@ static irqreturn_t arizona_irq_thread(int irq, void *data)
 	unsigned int val;
 	int ret;
 
-	ret = pm_runtime_get_sync(arizona-&gt;dev);
+	ret = pm_runtime_resume_and_get(arizona-&gt;dev);
 	if (ret &lt; 0) {
 		dev_err(arizona-&gt;dev, "Failed to resume device: %d\n", ret);
 		return IRQ_NONE;</pre><hr><pre>commit 917a3200b9f467a154999c7572af345f2470aaf4
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Fri Apr 9 16:28:05 2021 +0800

    dmaengine: tegra20: Fix runtime PM imbalance on error
    
    pm_runtime_get_sync() will increase the runtime PM counter
    even it returns an error. Thus a pairing decrement is needed
    to prevent refcount leak. Fix this by replacing this API with
    pm_runtime_resume_and_get(), which will not change the runtime
    PM counter on error.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Acked-by: Thierry Reding &lt;treding@nvidia.com&gt;
    Link: https://lore.kernel.org/r/20210409082805.23643-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Vinod Koul &lt;vkoul@kernel.org&gt;

diff --git a/drivers/dma/tegra20-apb-dma.c b/drivers/dma/tegra20-apb-dma.c
index 71827d9b0aa1..b7260749e8ee 100644
--- a/drivers/dma/tegra20-apb-dma.c
+++ b/drivers/dma/tegra20-apb-dma.c
@@ -723,7 +723,7 @@ static void tegra_dma_issue_pending(struct dma_chan *dc)
 		goto end;
 	}
 	if (!tdc-&gt;busy) {
-		err = pm_runtime_get_sync(tdc-&gt;tdma-&gt;dev);
+		err = pm_runtime_resume_and_get(tdc-&gt;tdma-&gt;dev);
 		if (err &lt; 0) {
 			dev_err(tdc2dev(tdc), "Failed to enable DMA\n");
 			goto end;
@@ -818,7 +818,7 @@ static void tegra_dma_synchronize(struct dma_chan *dc)
 	struct tegra_dma_channel *tdc = to_tegra_dma_chan(dc);
 	int err;
 
-	err = pm_runtime_get_sync(tdc-&gt;tdma-&gt;dev);
+	err = pm_runtime_resume_and_get(tdc-&gt;tdma-&gt;dev);
 	if (err &lt; 0) {
 		dev_err(tdc2dev(tdc), "Failed to synchronize DMA: %d\n", err);
 		return;</pre><hr><pre>commit f1995d5e43cf897f63b4d7a7f84a252d891ae820
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Wed Apr 7 07:46:06 2021 +0200

    media: sun8i-di: Fix runtime PM imbalance in deinterlace_start_streaming
    
    pm_runtime_get_sync() will increase the runtime PM counter
    even it returns an error. Thus a pairing decrement is needed
    to prevent refcount leak. Fix this by replacing this API with
    pm_runtime_resume_and_get(), which will not change the runtime
    PM counter on error.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
    Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;

diff --git a/drivers/media/platform/sunxi/sun8i-di/sun8i-di.c b/drivers/media/platform/sunxi/sun8i-di/sun8i-di.c
index ed863bf5ea80..671e4a928993 100644
--- a/drivers/media/platform/sunxi/sun8i-di/sun8i-di.c
+++ b/drivers/media/platform/sunxi/sun8i-di/sun8i-di.c
@@ -589,7 +589,7 @@ static int deinterlace_start_streaming(struct vb2_queue *vq, unsigned int count)
 	int ret;
 
 	if (V4L2_TYPE_IS_OUTPUT(vq-&gt;type)) {
-		ret = pm_runtime_get_sync(dev);
+		ret = pm_runtime_resume_and_get(dev);
 		if (ret &lt; 0) {
 			dev_err(dev, "Failed to enable module\n");
 </pre><hr><pre>commit 69306a947b3ae21e0d1cbfc9508f00fec86c7297
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Wed Apr 7 07:43:13 2021 +0200

    media: platform: sti: Fix runtime PM imbalance in regs_show
    
    pm_runtime_get_sync() will increase the runtime PM counter
    even it returns an error. Thus a pairing decrement is needed
    to prevent refcount leak. Fix this by replacing this API with
    pm_runtime_resume_and_get(), which will not change the runtime
    PM counter on error.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Hans Verkuil &lt;hverkuil-cisco@xs4all.nl&gt;
    Signed-off-by: Mauro Carvalho Chehab &lt;mchehab+huawei@kernel.org&gt;

diff --git a/drivers/media/platform/sti/bdisp/bdisp-debug.c b/drivers/media/platform/sti/bdisp/bdisp-debug.c
index 2b270093009c..a27f638df11c 100644
--- a/drivers/media/platform/sti/bdisp/bdisp-debug.c
+++ b/drivers/media/platform/sti/bdisp/bdisp-debug.c
@@ -480,7 +480,7 @@ static int regs_show(struct seq_file *s, void *data)
 	int ret;
 	unsigned int i;
 
-	ret = pm_runtime_get_sync(bdisp-&gt;dev);
+	ret = pm_runtime_resume_and_get(bdisp-&gt;dev);
 	if (ret &lt; 0) {
 		seq_puts(s, "Cannot wake up IP\n");
 		return 0;</pre><hr><pre>commit 5859c926d1f052ee61b5815b14658875c14f6243
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Thu Apr 8 15:26:58 2021 +0800

    PCI: tegra: Fix runtime PM imbalance in pex_ep_event_pex_rst_deassert()
    
    pm_runtime_get_sync() will increase the runtime PM counter
    even it returns an error. Thus a pairing decrement is needed
    to prevent refcount leak. Fix this by replacing this API with
    pm_runtime_resume_and_get(), which will not change the runtime
    PM counter on error.
    
    Link: https://lore.kernel.org/r/20210408072700.15791-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Signed-off-by: Lorenzo Pieralisi &lt;lorenzo.pieralisi@arm.com&gt;
    Acked-by: Thierry Reding &lt;treding@nvidia.com&gt;

diff --git a/drivers/pci/controller/dwc/pcie-tegra194.c b/drivers/pci/controller/dwc/pcie-tegra194.c
index 18acd48e8e9b..9b6799258fa4 100644
--- a/drivers/pci/controller/dwc/pcie-tegra194.c
+++ b/drivers/pci/controller/dwc/pcie-tegra194.c
@@ -1645,7 +1645,7 @@ static void pex_ep_event_pex_rst_deassert(struct tegra_pcie_dw *pcie)
 	if (pcie-&gt;ep_state == EP_STATE_ENABLED)
 		return;
 
-	ret = pm_runtime_get_sync(dev);
+	ret = pm_runtime_resume_and_get(dev);
 	if (ret &lt; 0) {
 		dev_err(dev, "Failed to get runtime sync for PCIe dev: %d\n",
 			ret);</pre><hr><pre>commit a21fbc42807b15b74b0891bd557063e6acf4fcae
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Thu Apr 8 17:25:59 2021 +0800

    spi: spi-zynqmp-gqspi: Fix runtime PM imbalance in zynqmp_qspi_probe
    
    When platform_get_irq() fails, a pairing PM usage counter
    increment is needed to keep the counter balanced. It's the
    same for the following error paths.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Link: https://lore.kernel.org/r/20210408092559.3824-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/drivers/spi/spi-zynqmp-gqspi.c b/drivers/spi/spi-zynqmp-gqspi.c
index c8fa6ee18ae7..95963a2de64a 100644
--- a/drivers/spi/spi-zynqmp-gqspi.c
+++ b/drivers/spi/spi-zynqmp-gqspi.c
@@ -1197,6 +1197,7 @@ static int zynqmp_qspi_probe(struct platform_device *pdev)
 	return 0;
 
 clk_dis_all:
+	pm_runtime_get_noresume(&amp;pdev-&gt;dev);
 	pm_runtime_set_suspended(&amp;pdev-&gt;dev);
 	pm_runtime_disable(&amp;pdev-&gt;dev);
 	clk_disable_unprepare(xqspi-&gt;refclk);</pre><hr><pre>commit 7b3f5b207da5116add56c335c5fb92cee140dc63
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Thu Apr 8 14:40:34 2021 +0800

    ASoC: codecs: Fix runtime PM imbalance in tas2552_probe
    
    There is a rumtime PM imbalance between the error handling path
    after devm_snd_soc_register_component() and all other error
    handling paths. Add a PM runtime increment to balance refcount.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Link: https://lore.kernel.org/r/20210408064036.6691-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/sound/soc/codecs/tas2552.c b/sound/soc/codecs/tas2552.c
index bd00c35116cd..700baa6314aa 100644
--- a/sound/soc/codecs/tas2552.c
+++ b/sound/soc/codecs/tas2552.c
@@ -730,8 +730,10 @@ static int tas2552_probe(struct i2c_client *client,
 	ret = devm_snd_soc_register_component(&amp;client-&gt;dev,
 				      &amp;soc_component_dev_tas2552,
 				      tas2552_dai, ARRAY_SIZE(tas2552_dai));
-	if (ret &lt; 0)
+	if (ret &lt; 0) {
 		dev_err(&amp;client-&gt;dev, "Failed to register component: %d\n", ret);
+		pm_runtime_get_noresume(&amp;client-&gt;dev);
+	}
 
 	return ret;
 }</pre><hr><pre>commit d599005afde8dd86b819d353fd77568c35295337
Author: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
Date:   Fri Feb 26 16:41:46 2021 +0800

    mmc: sdhci-pci-o2micro: Add missing checks in sdhci_pci_o2_probe
    
    It's odd to adopt different error handling on failure of
    pci_read_config_dword(). Check the return value and terminate
    execution flow on failure of all pci_read_config_dword() calls
    in this function.
    
    Signed-off-by: Dinghao Liu &lt;dinghao.liu@zju.edu.cn&gt;
    Link: https://lore.kernel.org/r/20210226084146.29095-1-dinghao.liu@zju.edu.cn
    Signed-off-by: Ulf Hansson &lt;ulf.hansson@linaro.org&gt;

diff --git a/drivers/mmc/host/sdhci-pci-o2micro.c b/drivers/mmc/host/sdhci-pci-o2micro.c
index 94e3f72f6405..51d55a87aebe 100644
--- a/drivers/mmc/host/sdhci-pci-o2micro.c
+++ b/drivers/mmc/host/sdhci-pci-o2micro.c
@@ -706,6 +706,8 @@ static int sdhci_pci_o2_probe(struct sdhci_pci_chip *chip)
 			ret = pci_read_config_dword(chip-&gt;pdev,
 						    O2_SD_FUNC_REG0,
 						    &amp;scratch_32);
+			if (ret)
+				return ret;
 			scratch_32 = ((scratch_32 &amp; 0xFF000000) &gt;&gt; 24);
 
 			/* Check Whether subId is 0x11 or 0x12 */
@@ -716,6 +718,8 @@ static int sdhci_pci_o2_probe(struct sdhci_pci_chip *chip)
 				ret = pci_read_config_dword(chip-&gt;pdev,
 							    O2_SD_FUNC_REG4,
 							    &amp;scratch_32);
+				if (ret)
+					return ret;
 
 				/* Enable Base Clk setting change */
 				scratch_32 |= O2_SD_FREG4_ENABLE_CLK_SET;
@@ -795,6 +799,8 @@ static int sdhci_pci_o2_probe(struct sdhci_pci_chip *chip)
 
 		ret = pci_read_config_dword(chip-&gt;pdev,
 					    O2_SD_PLL_SETTING, &amp;scratch_32);
+		if (ret)
+			return ret;
 
 		if ((scratch_32 &amp; 0xff000000) == 0x01000000) {
 			scratch_32 &amp;= 0x0000FFFF;
@@ -812,6 +818,8 @@ static int sdhci_pci_o2_probe(struct sdhci_pci_chip *chip)
 			ret = pci_read_config_dword(chip-&gt;pdev,
 						    O2_SD_FUNC_REG4,
 						    &amp;scratch_32);
+			if (ret)
+				return ret;
 			scratch_32 |= (1 &lt;&lt; 22);
 			pci_write_config_dword(chip-&gt;pdev,
 					       O2_SD_FUNC_REG4, scratch_32);</pre>
    <div class="pagination">
        <a href='6_22.html'>&lt;&lt;Prev</a><a href='6.html'>1</a><a href='6_2.html'>2</a><a href='6_3.html'>3</a><a href='6_4.html'>4</a><a href='6_5.html'>5</a><a href='6_6.html'>6</a><a href='6_7.html'>7</a><a href='6_8.html'>8</a><a href='6_9.html'>9</a><a href='6_10.html'>10</a><a href='6_11.html'>11</a><a href='6_12.html'>12</a><a href='6_13.html'>13</a><a href='6_14.html'>14</a><a href='6_15.html'>15</a><a href='6_16.html'>16</a><a href='6_17.html'>17</a><a href='6_18.html'>18</a><a href='6_19.html'>19</a><a href='6_20.html'>20</a><a href='6_21.html'>21</a><a href='6_22.html'>22</a><span>[23]</span><a href='6_24.html'>24</a><a href='6_25.html'>25</a><a href='6_26.html'>26</a><a href='6_27.html'>27</a><a href='6_28.html'>28</a><a href='6_29.html'>29</a><a href='6_30.html'>30</a><a href='6_31.html'>31</a><a href='6_32.html'>32</a><a href='6_33.html'>33</a><a href='6_34.html'>34</a><a href='6_35.html'>35</a><a href='6_36.html'>36</a><a href='6_24.html'>Next&gt;&gt;</a>
    <div>
</body>
