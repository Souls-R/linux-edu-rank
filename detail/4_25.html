<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by University of Michigan - Ann Arbor</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by University of Michigan - Ann Arbor</h1>
    <div class="pagination">
        <a href='4_24.html'>&lt;&lt;Prev</a><a href='4.html'>1</a><a href='4_2.html'>2</a><a href='4_3.html'>3</a><a href='4_4.html'>4</a><a href='4_5.html'>5</a><a href='4_6.html'>6</a><a href='4_7.html'>7</a><a href='4_8.html'>8</a><a href='4_9.html'>9</a><a href='4_10.html'>10</a><a href='4_11.html'>11</a><a href='4_12.html'>12</a><a href='4_13.html'>13</a><a href='4_14.html'>14</a><a href='4_15.html'>15</a><a href='4_16.html'>16</a><a href='4_17.html'>17</a><a href='4_18.html'>18</a><a href='4_19.html'>19</a><a href='4_20.html'>20</a><a href='4_21.html'>21</a><a href='4_22.html'>22</a><a href='4_23.html'>23</a><a href='4_24.html'>24</a><span>[25]</span><a href='4_26.html'>26</a><a href='4_27.html'>27</a><a href='4_28.html'>28</a><a href='4_29.html'>29</a><a href='4_30.html'>30</a><a href='4_31.html'>31</a><a href='4_32.html'>32</a><a href='4_33.html'>33</a><a href='4_34.html'>34</a><a href='4_35.html'>35</a><a href='4_36.html'>36</a><a href='4_37.html'>37</a><a href='4_38.html'>38</a><a href='4_39.html'>39</a><a href='4_40.html'>40</a><a href='4_41.html'>41</a><a href='4_42.html'>42</a><a href='4_43.html'>43</a><a href='4_44.html'>44</a><a href='4_45.html'>45</a><a href='4_46.html'>46</a><a href='4_47.html'>47</a><a href='4_48.html'>48</a><a href='4_49.html'>49</a><a href='4_50.html'>50</a><a href='4_51.html'>51</a><a href='4_52.html'>52</a><a href='4_53.html'>53</a><a href='4_54.html'>54</a><a href='4_55.html'>55</a><a href='4_56.html'>56</a><a href='4_57.html'>57</a><a href='4_26.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 3e633079e377d2b527a8390f63ceb887b5cabfbf
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 13:17:19 2009 -0800

    nfsd4: add a helper function to decide if stateid is delegation
    
    Make this check self-documenting.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index 909a7a493688..d5555850cb64 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2048,6 +2048,11 @@ static int check_stateid_generation(stateid_t *in, stateid_t *ref)
 	return nfs_ok;
 }
 
+static int is_delegation_stateid(stateid_t *stateid)
+{
+	return stateid-&gt;si_fileid == 0;
+}
+
 /*
 * Checks for stateid operations
 */
@@ -2073,7 +2078,7 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 		goto out;
 
 	status = nfserr_bad_stateid;
-	if (!stateid-&gt;si_fileid) { /* delegation stateid */
+	if (is_delegation_stateid(stateid)) {
 		dp = find_delegation_stateid(ino, stateid);
 		if (!dp)
 			goto out;</pre><hr><pre>commit 819a8f539acf7838d62fec20e88401ff53303cd1
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 12:13:24 2009 -0800

    nfsd4: remove some dprintk's
    
    I can't recall ever seeing these printk's used to debug a problem.  I'll
    happily put them back if we see a case where they'd be useful.  (Though
    if we do that the find_XXX() errors would probably be better
    reported in find_XXX() functions themselves.)
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index 099938ebc9d3..909a7a493688 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2059,9 +2059,6 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 	struct inode *ino = current_fh-&gt;fh_dentry-&gt;d_inode;
 	__be32 status;
 
-	dprintk("NFSD: preprocess_stateid_op: stateid = (%08x/%08x/%08x/%08x)\n",
-		stateid-&gt;si_boot, stateid-&gt;si_stateownerid, 
-		stateid-&gt;si_fileid, stateid-&gt;si_generation); 
 	if (filpp)
 		*filpp = NULL;
 
@@ -2078,10 +2075,8 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 	status = nfserr_bad_stateid;
 	if (!stateid-&gt;si_fileid) { /* delegation stateid */
 		dp = find_delegation_stateid(ino, stateid);
-		if (!dp) {
-			dprintk("NFSD: delegation stateid not found\n");
+		if (!dp)
 			goto out;
-		}
 		status = check_stateid_generation(stateid, &amp;dp-&gt;dl_stateid);
 		if (status)
 			goto out;
@@ -2095,10 +2090,8 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 			*filpp = dp-&gt;dl_vfs_file;
 	} else { /* open or lock stateid */
 		stp = find_stateid(stateid, flags);
-		if (!stp) {
-			dprintk("NFSD: open or lock stateid not found\n");
+		if (!stp)
 			goto out;
-		}
 		if ((flags &amp; CHECK_FH) &amp;&amp; nfs4_check_fh(current_fh, stp))
 			goto out;
 		if (!stp-&gt;st_stateowner-&gt;so_confirmed)</pre><hr><pre>commit fd03b09906c32aea7b47f1275c9cd6034141159d
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 11:27:30 2009 -0800

    nfsd4: remove unneeded local variable
    
    We no longer need stidp.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index 16fcb656f47f..099938ebc9d3 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2056,7 +2056,6 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 {
 	struct nfs4_stateid *stp = NULL;
 	struct nfs4_delegation *dp = NULL;
-	stateid_t *stidp;
 	struct inode *ino = current_fh-&gt;fh_dentry-&gt;d_inode;
 	__be32 status;
 
@@ -2083,8 +2082,7 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 			dprintk("NFSD: delegation stateid not found\n");
 			goto out;
 		}
-		stidp = &amp;dp-&gt;dl_stateid;
-		status = check_stateid_generation(stateid, stidp);
+		status = check_stateid_generation(stateid, &amp;dp-&gt;dl_stateid);
 		if (status)
 			goto out;
 		status = nfs4_check_delegmode(dp, flags);
@@ -2105,8 +2103,7 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 			goto out;
 		if (!stp-&gt;st_stateowner-&gt;so_confirmed)
 			goto out;
-		stidp = &amp;stp-&gt;st_stateid;
-		status = check_stateid_generation(stateid, stidp);
+		status = check_stateid_generation(stateid, &amp;stp-&gt;st_stateid);
 		if (status)
 			goto out;
 		status = nfs4_check_openmode(stp, flags);</pre><hr><pre>commit dc9bf700ed2fc3eab50f31000b13fda781e7c9f1
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 11:14:43 2009 -0800

    nfsd4: remove redundant "if" in nfs4_preprocess_stateid_op
    
    Note that we exit this first big "if" with stp == NULL if and only if we
    took the first branch; therefore, the second "if" is redundant, and we
    can just combine the two, simplifying the logic.
    
    Reviewed-by: Yang Hongyang &lt;yanghy@cn.fujitsu.com&gt;
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index d6ca2be306dc..16fcb656f47f 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2087,6 +2087,14 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 		status = check_stateid_generation(stateid, stidp);
 		if (status)
 			goto out;
+		status = nfs4_check_delegmode(dp, flags);
+		if (status)
+			goto out;
+		renew_client(dp-&gt;dl_client);
+		if (flags &amp; DELEG_RET)
+			unhash_delegation(dp);
+		if (filpp)
+			*filpp = dp-&gt;dl_vfs_file;
 	} else { /* open or lock stateid */
 		stp = find_stateid(stateid, flags);
 		if (!stp) {
@@ -2101,23 +2109,12 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 		status = check_stateid_generation(stateid, stidp);
 		if (status)
 			goto out;
-	}
-	if (stp) {
 		status = nfs4_check_openmode(stp, flags);
 		if (status)
 			goto out;
 		renew_client(stp-&gt;st_stateowner-&gt;so_client);
 		if (filpp)
 			*filpp = stp-&gt;st_vfs_file;
-	} else {
-		status = nfs4_check_delegmode(dp, flags);
-		if (status)
-			goto out;
-		renew_client(dp-&gt;dl_client);
-		if (flags &amp; DELEG_RET)
-			unhash_delegation(dp);
-		if (filpp)
-			*filpp = dp-&gt;dl_vfs_file;
 	}
 	status = nfs_ok;
 out:</pre><hr><pre>commit 0c2a498fa6d33d8ca9c8a0c29039c41e1734cb9e
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 11:11:50 2009 -0800

    nfsd4: move check_stateid_generation check
    
    No change in behavior.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index b7e2f251ea95..d6ca2be306dc 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2084,6 +2084,9 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 			goto out;
 		}
 		stidp = &amp;dp-&gt;dl_stateid;
+		status = check_stateid_generation(stateid, stidp);
+		if (status)
+			goto out;
 	} else { /* open or lock stateid */
 		stp = find_stateid(stateid, flags);
 		if (!stp) {
@@ -2095,10 +2098,10 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 		if (!stp-&gt;st_stateowner-&gt;so_confirmed)
 			goto out;
 		stidp = &amp;stp-&gt;st_stateid;
+		status = check_stateid_generation(stateid, stidp);
+		if (status)
+			goto out;
 	}
-	status = check_stateid_generation(stateid, stidp);
-	if (status)
-		goto out;
 	if (stp) {
 		status = nfs4_check_openmode(stp, flags);
 		if (status)</pre><hr><pre>commit a4455be0850009f5da9a3b82523079922cd4b26e
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Sat Feb 21 10:40:22 2009 -0800

    nfsd4: trivial preprocess_stateid_op cleanup
    
    Remove a couple redundant comments, adjust style; no change in behavior.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index 7f616e928a57..b7e2f251ea95 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -2072,21 +2072,21 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 	if (ZERO_STATEID(stateid) || ONE_STATEID(stateid))
 		return check_special_stateids(current_fh, stateid, flags);
 
-	/* STALE STATEID */
 	status = nfserr_stale_stateid;
 	if (STALE_STATEID(stateid)) 
 		goto out;
 
-	/* BAD STATEID */
 	status = nfserr_bad_stateid;
 	if (!stateid-&gt;si_fileid) { /* delegation stateid */
-		if(!(dp = find_delegation_stateid(ino, stateid))) {
+		dp = find_delegation_stateid(ino, stateid);
+		if (!dp) {
 			dprintk("NFSD: delegation stateid not found\n");
 			goto out;
 		}
 		stidp = &amp;dp-&gt;dl_stateid;
 	} else { /* open or lock stateid */
-		if (!(stp = find_stateid(stateid, flags))) {
+		stp = find_stateid(stateid, flags);
+		if (!stp) {
 			dprintk("NFSD: open or lock stateid not found\n");
 			goto out;
 		}
@@ -2100,13 +2100,15 @@ nfs4_preprocess_stateid_op(struct svc_fh *current_fh, stateid_t *stateid, int fl
 	if (status)
 		goto out;
 	if (stp) {
-		if ((status = nfs4_check_openmode(stp,flags)))
+		status = nfs4_check_openmode(stp, flags);
+		if (status)
 			goto out;
 		renew_client(stp-&gt;st_stateowner-&gt;so_client);
 		if (filpp)
 			*filpp = stp-&gt;st_vfs_file;
 	} else {
-		if ((status = nfs4_check_delegmode(dp, flags)))
+		status = nfs4_check_delegmode(dp, flags);
+		if (status)
 			goto out;
 		renew_client(dp-&gt;dl_client);
 		if (flags &amp; DELEG_RET)</pre><hr><pre>commit 6c02eaa1d1e53b9b2cc27d0c6fff3e57da4b611f
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Mon Feb 2 17:30:51 2009 -0500

    nfsd4: use helper for copying delegation filehandle
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4callback.c b/fs/nfsd/nfs4callback.c
index c464181b5994..c6804db33c17 100644
--- a/fs/nfsd/nfs4callback.c
+++ b/fs/nfsd/nfs4callback.c
@@ -218,7 +218,7 @@ static int
 encode_cb_recall(struct xdr_stream *xdr, struct nfs4_cb_recall *cb_rec)
 {
 	__be32 *p;
-	int len = cb_rec-&gt;cbr_fhlen;
+	int len = cb_rec-&gt;cbr_fh.fh_size;
 
 	RESERVE_SPACE(12+sizeof(cb_rec-&gt;cbr_stateid) + len);
 	WRITE32(OP_CB_RECALL);
@@ -226,7 +226,7 @@ encode_cb_recall(struct xdr_stream *xdr, struct nfs4_cb_recall *cb_rec)
 	WRITEMEM(&amp;cb_rec-&gt;cbr_stateid.si_opaque, sizeof(stateid_opaque_t));
 	WRITE32(cb_rec-&gt;cbr_trunc);
 	WRITE32(len);
-	WRITEMEM(cb_rec-&gt;cbr_fhval, len);
+	WRITEMEM(&amp;cb_rec-&gt;cbr_fh.fh_base, len);
 	return 0;
 }
 
diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c
index 41a3590ef2cc..7f616e928a57 100644
--- a/fs/nfsd/nfs4state.c
+++ b/fs/nfsd/nfs4state.c
@@ -215,9 +215,7 @@ alloc_init_deleg(struct nfs4_client *clp, struct nfs4_stateid *stp, struct svc_f
 	dp-&gt;dl_stateid.si_stateownerid = current_delegid++;
 	dp-&gt;dl_stateid.si_fileid = 0;
 	dp-&gt;dl_stateid.si_generation = 0;
-	dp-&gt;dl_fhlen = current_fh-&gt;fh_handle.fh_size;
-	memcpy(dp-&gt;dl_fhval, &amp;current_fh-&gt;fh_handle.fh_base,
-		        current_fh-&gt;fh_handle.fh_size);
+	fh_copy_shallow(&amp;dp-&gt;dl_fh, &amp;current_fh-&gt;fh_handle);
 	dp-&gt;dl_time = 0;
 	atomic_set(&amp;dp-&gt;dl_count, 1);
 	list_add(&amp;dp-&gt;dl_perfile, &amp;fp-&gt;fi_delegations);
diff --git a/include/linux/nfsd/state.h b/include/linux/nfsd/state.h
index b65b2a6274b0..1130d534bb63 100644
--- a/include/linux/nfsd/state.h
+++ b/include/linux/nfsd/state.h
@@ -66,8 +66,7 @@ struct nfs4_cb_recall {
 	u32			cbr_ident;
 	int			cbr_trunc;
 	stateid_t		cbr_stateid;
-	u32			cbr_fhlen;
-	char			cbr_fhval[NFS4_FHSIZE];
+	struct knfsd_fh		cbr_fh;
 	struct nfs4_delegation	*cbr_dp;
 };
 
@@ -86,8 +85,7 @@ struct nfs4_delegation {
 };
 
 #define dl_stateid      dl_recall.cbr_stateid
-#define dl_fhlen        dl_recall.cbr_fhlen
-#define dl_fhval        dl_recall.cbr_fhval
+#define dl_fh           dl_recall.cbr_fh
 
 /* client delegation callback info */
 struct nfs4_callback {</pre><hr><pre>commit a4773c08f2872626cb923433284488fbe8acb0ae
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Mon Feb 2 17:23:10 2009 -0500

    nfsd4: use helper for copying filehandles for replay
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c
index 326506272258..af66073ed423 100644
--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -123,10 +123,8 @@ do_open_lookup(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfsd4_o
 	fh_dup2(current_fh, &amp;resfh);
 
 	/* set reply cache */
-	open-&gt;op_stateowner-&gt;so_replay.rp_openfh_len = resfh.fh_handle.fh_size;
-	memcpy(open-&gt;op_stateowner-&gt;so_replay.rp_openfh,
-			&amp;resfh.fh_handle.fh_base, resfh.fh_handle.fh_size);
-
+	fh_copy_shallow(&amp;open-&gt;op_stateowner-&gt;so_replay.rp_openfh,
+			&amp;resfh.fh_handle);
 	if (!created)
 		status = do_open_permission(rqstp, current_fh, open,
 					    NFSD_MAY_NOP);
@@ -152,10 +150,8 @@ do_open_fhandle(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfsd4_
 	memset(&amp;open-&gt;op_cinfo, 0, sizeof(struct nfsd4_change_info));
 
 	/* set replay cache */
-	open-&gt;op_stateowner-&gt;so_replay.rp_openfh_len = current_fh-&gt;fh_handle.fh_size;
-	memcpy(open-&gt;op_stateowner-&gt;so_replay.rp_openfh,
-		&amp;current_fh-&gt;fh_handle.fh_base,
-		current_fh-&gt;fh_handle.fh_size);
+	fh_copy_shallow(&amp;open-&gt;op_stateowner-&gt;so_replay.rp_openfh,
+			&amp;current_fh-&gt;fh_handle);
 
 	open-&gt;op_truncate = (open-&gt;op_iattr.ia_valid &amp; ATTR_SIZE) &amp;&amp;
 		(open-&gt;op_iattr.ia_size == 0);
@@ -187,9 +183,8 @@ nfsd4_open(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,
 	if (status == nfserr_replay_me) {
 		struct nfs4_replay *rp = &amp;open-&gt;op_stateowner-&gt;so_replay;
 		fh_put(&amp;cstate-&gt;current_fh);
-		cstate-&gt;current_fh.fh_handle.fh_size = rp-&gt;rp_openfh_len;
-		memcpy(&amp;cstate-&gt;current_fh.fh_handle.fh_base, rp-&gt;rp_openfh,
-				rp-&gt;rp_openfh_len);
+		fh_copy_shallow(&amp;cstate-&gt;current_fh.fh_handle,
+				&amp;rp-&gt;rp_openfh);
 		status = fh_verify(rqstp, &amp;cstate-&gt;current_fh, 0, NFSD_MAY_NOP);
 		if (status)
 			dprintk("nfsd4_open: replay failed"
diff --git a/include/linux/nfsd/nfsfh.h b/include/linux/nfsd/nfsfh.h
index fa317f6c154b..afa19016c4a8 100644
--- a/include/linux/nfsd/nfsfh.h
+++ b/include/linux/nfsd/nfsfh.h
@@ -269,6 +269,13 @@ fh_copy(struct svc_fh *dst, struct svc_fh *src)
 	return dst;
 }
 
+static inline void
+fh_copy_shallow(struct knfsd_fh *dst, struct knfsd_fh *src)
+{
+	dst-&gt;fh_size = src-&gt;fh_size;
+	memcpy(&amp;dst-&gt;fh_base, &amp;src-&gt;fh_base, src-&gt;fh_size);
+}
+
 static __inline__ struct svc_fh *
 fh_init(struct svc_fh *fhp, int maxsize)
 {
diff --git a/include/linux/nfsd/state.h b/include/linux/nfsd/state.h
index 128298c0362d..b65b2a6274b0 100644
--- a/include/linux/nfsd/state.h
+++ b/include/linux/nfsd/state.h
@@ -168,8 +168,7 @@ struct nfs4_replay {
 	unsigned int		rp_buflen;
 	char			*rp_buf;
 	unsigned		intrp_allocated;
-	int			rp_openfh_len;
-	char			rp_openfh[NFS4_FHSIZE];
+	struct knfsd_fh		rp_openfh;
 	char			rp_ibuf[NFSD4_REPLAY_ISIZE];
 };
 </pre><hr><pre>commit 13024b7b4097d33fe6bba34b1c83602e88753270
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Mon Feb 2 17:04:03 2009 -0500

    nfsd4: fix misplaced comment
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c
index 85b9a084177a..326506272258 100644
--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -120,9 +120,9 @@ do_open_lookup(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfsd4_o
 		goto out;
 
 	set_change_info(&amp;open-&gt;op_cinfo, current_fh);
+	fh_dup2(current_fh, &amp;resfh);
 
 	/* set reply cache */
-	fh_dup2(current_fh, &amp;resfh);
 	open-&gt;op_stateowner-&gt;so_replay.rp_openfh_len = resfh.fh_handle.fh_size;
 	memcpy(open-&gt;op_stateowner-&gt;so_replay.rp_openfh,
 			&amp;resfh.fh_handle.fh_base, resfh.fh_handle.fh_size);</pre><hr><pre>commit 99f88726381f676bba6e7dcf74b7412857d7946a
Author: J. Bruce Fields &lt;bfields@fieldses.org&gt;
Date:   Mon Feb 2 15:12:27 2009 -0500

    nfsd: clarify exclusive create bitmask result.
    
    The use of |= is confusing--the bitmask is always initialized to zero in
    this case, so we're effectively just doing an assignment here.
    
    Signed-off-by: J. Bruce Fields &lt;bfields@citi.umich.edu&gt;

diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c
index 9fa60a3ad48c..85b9a084177a 100644
--- a/fs/nfsd/nfs4proc.c
+++ b/fs/nfsd/nfs4proc.c
@@ -103,11 +103,13 @@ do_open_lookup(struct svc_rqst *rqstp, struct svc_fh *current_fh, struct nfsd4_o
 					(u32 *)open-&gt;op_verf.data,
 					&amp;open-&gt;op_truncate, &amp;created);
 
-		/* If we ever decide to use different attrs to store the
-		 * verifier in nfsd_create_v3, then we'll need to change this
+		/*
+		 * Following rfc 3530 14.2.16, use the returned bitmask
+		 * to indicate which attributes we used to store the
+		 * verifier:
 		 */
 		if (open-&gt;op_createmode == NFS4_CREATE_EXCLUSIVE &amp;&amp; status == 0)
-			open-&gt;op_bmval[1] |= (FATTR4_WORD1_TIME_ACCESS |
+			open-&gt;op_bmval[1] = (FATTR4_WORD1_TIME_ACCESS |
 						FATTR4_WORD1_TIME_MODIFY);
 	} else {
 		status = nfsd_lookup(rqstp, current_fh,</pre>
    <div class="pagination">
        <a href='4_24.html'>&lt;&lt;Prev</a><a href='4.html'>1</a><a href='4_2.html'>2</a><a href='4_3.html'>3</a><a href='4_4.html'>4</a><a href='4_5.html'>5</a><a href='4_6.html'>6</a><a href='4_7.html'>7</a><a href='4_8.html'>8</a><a href='4_9.html'>9</a><a href='4_10.html'>10</a><a href='4_11.html'>11</a><a href='4_12.html'>12</a><a href='4_13.html'>13</a><a href='4_14.html'>14</a><a href='4_15.html'>15</a><a href='4_16.html'>16</a><a href='4_17.html'>17</a><a href='4_18.html'>18</a><a href='4_19.html'>19</a><a href='4_20.html'>20</a><a href='4_21.html'>21</a><a href='4_22.html'>22</a><a href='4_23.html'>23</a><a href='4_24.html'>24</a><span>[25]</span><a href='4_26.html'>26</a><a href='4_27.html'>27</a><a href='4_28.html'>28</a><a href='4_29.html'>29</a><a href='4_30.html'>30</a><a href='4_31.html'>31</a><a href='4_32.html'>32</a><a href='4_33.html'>33</a><a href='4_34.html'>34</a><a href='4_35.html'>35</a><a href='4_36.html'>36</a><a href='4_37.html'>37</a><a href='4_38.html'>38</a><a href='4_39.html'>39</a><a href='4_40.html'>40</a><a href='4_41.html'>41</a><a href='4_42.html'>42</a><a href='4_43.html'>43</a><a href='4_44.html'>44</a><a href='4_45.html'>45</a><a href='4_46.html'>46</a><a href='4_47.html'>47</a><a href='4_48.html'>48</a><a href='4_49.html'>49</a><a href='4_50.html'>50</a><a href='4_51.html'>51</a><a href='4_52.html'>52</a><a href='4_53.html'>53</a><a href='4_54.html'>54</a><a href='4_55.html'>55</a><a href='4_56.html'>56</a><a href='4_57.html'>57</a><a href='4_26.html'>Next&gt;&gt;</a>
    <div>
</body>
