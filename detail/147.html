<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by University of Massachusetts at Amherst</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by University of Massachusetts at Amherst</h1>
    <div class="pagination">
        <span>[1]</span>
    </div>
    <hr>
    <pre>commit 7109c4429af3640f79a638f177fc5d05b9807149
Author: Ting Yang &lt;tingy@cs.umass.edu&gt;
Date:   Tue Aug 28 12:53:24 2007 +0200

    sched: call update_curr() in task_tick_fair()
    
    update the fair-clock before using it for the key value.
    
    [ mingo@elte.hu: small cleanups. ]
    
    Signed-off-by: Ting Yang &lt;tingy@cs.umass.edu&gt;
    Signed-off-by: Ingo Molnar &lt;mingo@elte.hu&gt;
    Signed-off-by: Mike Galbraith &lt;efault@gmx.de&gt;
    Signed-off-by: Peter Zijlstra &lt;a.p.zijlstra@chello.nl&gt;

diff --git a/kernel/sched_fair.c b/kernel/sched_fair.c
index 721fe7744874..9f06094e5275 100644
--- a/kernel/sched_fair.c
+++ b/kernel/sched_fair.c
@@ -1094,10 +1094,11 @@ static void task_tick_fair(struct rq *rq, struct task_struct *curr)
 static void task_new_fair(struct rq *rq, struct task_struct *p)
 {
 	struct cfs_rq *cfs_rq = task_cfs_rq(p);
-	struct sched_entity *se = &amp;p-&gt;se;
+	struct sched_entity *se = &amp;p-&gt;se, *curr = cfs_rq_curr(cfs_rq);
 
 	sched_info_queued(p);
 
+	update_curr(cfs_rq);
 	update_stats_enqueue(cfs_rq, se);
 	/*
 	 * Child runs first: we let it run before the parent
@@ -1105,7 +1106,7 @@ static void task_new_fair(struct rq *rq, struct task_struct *p)
 	 * it will preempt the parent:
 	 */
 	p-&gt;se.fair_key = current-&gt;se.fair_key -
-		niced_granularity(&amp;rq-&gt;curr-&gt;se, sched_granularity(cfs_rq)) - 1;
+		niced_granularity(curr, sched_granularity(cfs_rq)) - 1;
 	/*
 	 * The first wait is dominated by the child-runs-first logic,
 	 * so do not credit it with that waiting time yet:</pre>
    <div class="pagination">
        <span>[1]</span>
    <div>
</body>
