<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Huazhong University of Science and Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Huazhong University of Science and Technology</h1>
    <div class="pagination">
        <a href='14_5.html'>&lt;&lt;Prev</a><a href='14.html'>1</a><a href='14_2.html'>2</a><a href='14_3.html'>3</a><a href='14_4.html'>4</a><a href='14_5.html'>5</a><span>[6]</span><a href='14_7.html'>7</a><a href='14_8.html'>8</a><a href='14_7.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 8bfb89f6149ea8e790f58abad1f4a84066d86c91
Author: Jun Chen &lt;jun_c@hust.edu.cn&gt;
Date:   Mon Apr 10 10:37:23 2023 +0800

    scsi: lpfc: Silence an incorrect device output
    
    In lpfc_sli4_pci_mem_unset(), case LPFC_SLI_INTF_IF_TYPE_1 does not have a
    break statement, resulting in an incorrect device output.
    
    Fix this by adding a break statement before the default option.
    
    Signed-off-by: Jun Chen &lt;jun_c@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230410023724.3209455-1-jun_c@hust.edu.cn
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Reviewed-by: Justin Tee &lt;justin.tee@broadcom.com&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index 3b0642dc023b..92e7197087bf 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -12107,6 +12107,7 @@ lpfc_sli4_pci_mem_unset(struct lpfc_hba *phba)
 			iounmap(phba-&gt;sli4_hba.dpp_regs_memmap_p);
 		break;
 	case LPFC_SLI_INTF_IF_TYPE_1:
+		break;
 	default:
 		dev_printk(KERN_ERR, &amp;phba-&gt;pcidev-&gt;dev,
 			   "FATAL - unsupported SLI4 interface type - %d\n",</pre><hr><pre>commit 91a0c0c1413239d0548b5aac4c82f38f6d53a91e
Author: Shuchang Li &lt;lishuchang@hust.edu.cn&gt;
Date:   Tue Apr 4 15:21:32 2023 +0800

    scsi: lpfc: Fix ioremap issues in lpfc_sli4_pci_mem_setup()
    
    When if_type equals zero and pci_resource_start(pdev, PCI_64BIT_BAR4)
    returns false, drbl_regs_memmap_p is not remapped. This passes a NULL
    pointer to iounmap(), which can trigger a WARN() on certain arches.
    
    When if_type equals six and pci_resource_start(pdev, PCI_64BIT_BAR4)
    returns true, drbl_regs_memmap_p may has been remapped and
    ctrl_regs_memmap_p is not remapped. This is a resource leak and passes a
    NULL pointer to iounmap().
    
    To fix these issues, we need to add null checks before iounmap(), and
    change some goto labels.
    
    Fixes: 1351e69fc6db ("scsi: lpfc: Add push-to-adapter support to sli4")
    Signed-off-by: Shuchang Li &lt;lishuchang@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230404072133.1022-1-lishuchang@hust.edu.cn
    Reviewed-by: Justin Tee &lt;justin.tee@broadcom.com&gt;
    Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;

diff --git a/drivers/scsi/lpfc/lpfc_init.c b/drivers/scsi/lpfc/lpfc_init.c
index a9e36c73cfc5..3b0642dc023b 100644
--- a/drivers/scsi/lpfc/lpfc_init.c
+++ b/drivers/scsi/lpfc/lpfc_init.c
@@ -12024,7 +12024,7 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 				goto out_iounmap_all;
 		} else {
 			error = -ENOMEM;
-			goto out_iounmap_all;
+			goto out_iounmap_ctrl;
 		}
 	}
 
@@ -12042,7 +12042,7 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 			dev_err(&amp;pdev-&gt;dev,
 			   "ioremap failed for SLI4 HBA dpp registers.\n");
 			error = -ENOMEM;
-			goto out_iounmap_ctrl;
+			goto out_iounmap_all;
 		}
 		phba-&gt;pci_bar4_memmap_p = phba-&gt;sli4_hba.dpp_regs_memmap_p;
 	}
@@ -12067,9 +12067,11 @@ lpfc_sli4_pci_mem_setup(struct lpfc_hba *phba)
 	return 0;
 
 out_iounmap_all:
-	iounmap(phba-&gt;sli4_hba.drbl_regs_memmap_p);
+	if (phba-&gt;sli4_hba.drbl_regs_memmap_p)
+		iounmap(phba-&gt;sli4_hba.drbl_regs_memmap_p);
 out_iounmap_ctrl:
-	iounmap(phba-&gt;sli4_hba.ctrl_regs_memmap_p);
+	if (phba-&gt;sli4_hba.ctrl_regs_memmap_p)
+		iounmap(phba-&gt;sli4_hba.ctrl_regs_memmap_p);
 out_iounmap_conf:
 	iounmap(phba-&gt;sli4_hba.conf_regs_memmap_p);
 </pre><hr><pre>commit fb4a624f88f658c7b7ae124452bd42eaa8ac7168
Author: Xu Biang &lt;xubiang@hust.edu.cn&gt;
Date:   Thu Apr 6 06:28:01 2023 -0700

    ALSA: firewire-tascam: add missing unwind goto in snd_tscm_stream_start_duplex()
    
    Smatch Warns:
    sound/firewire/tascam/tascam-stream.c:493 snd_tscm_stream_start_duplex()
    warn: missing unwind goto?
    
    The direct return will cause the stream list of "&amp;tscm-&gt;domain" unemptied
    and the session in "tscm" unfinished if amdtp_domain_start() returns with
    an error.
    
    Fix this by changing the direct return to a goto which will empty the
    stream list of "&amp;tscm-&gt;domain" and finish the session in "tscm".
    
    The snd_tscm_stream_start_duplex() function is called in the prepare
    callback of PCM. According to "ALSA Kernel API Documentation", the prepare
    callback of PCM will be called many times at each setup. So, if the
    "&amp;d-&gt;streams" list is not emptied, when the prepare callback is called
    next time, snd_tscm_stream_start_duplex() will receive -EBUSY from
    amdtp_domain_add_stream() that tries to add an existing stream to the
    domain. The error handling code after the "error" label will be executed
    in this case, and the "&amp;d-&gt;streams" list will be emptied. So not emptying
    the "&amp;d-&gt;streams" list will not cause an issue. But it is more efficient
    and readable to empty it on the first error by changing the direct return
    to a goto statement.
    
    The session in "tscm" has been begun before amdtp_domain_start(), so it
    needs to be finished when amdtp_domain_start() fails.
    
    Fixes: c281d46a51e3 ("ALSA: firewire-tascam: support AMDTP domain")
    Signed-off-by: Xu Biang &lt;xubiang@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Acked-by: Takashi Sakamoto &lt;o-takashi@sakamocchi.jp&gt;
    Cc: &lt;stable@vger.kernel.org&gt;
    Link: https://lore.kernel.org/r/20230406132801.105108-1-xubiang@hust.edu.cn
    Signed-off-by: Takashi Iwai &lt;tiwai@suse.de&gt;

diff --git a/sound/firewire/tascam/tascam-stream.c b/sound/firewire/tascam/tascam-stream.c
index 53e094cc411f..dfe783d01d7d 100644
--- a/sound/firewire/tascam/tascam-stream.c
+++ b/sound/firewire/tascam/tascam-stream.c
@@ -490,7 +490,7 @@ int snd_tscm_stream_start_duplex(struct snd_tscm *tscm, unsigned int rate)
 		// packet is important for media clock recovery.
 		err = amdtp_domain_start(&amp;tscm-&gt;domain, tx_init_skip_cycles, true, true);
 		if (err &lt; 0)
-			return err;
+			goto error;
 
 		if (!amdtp_domain_wait_ready(&amp;tscm-&gt;domain, READY_TIMEOUT_MS)) {
 			err = -ETIMEDOUT;</pre><hr><pre>commit 194f8692302cbf31d8072f3fc2710fb04720d8a0
Author: Zihao Wang &lt;u202012060@hust.edu.cn&gt;
Date:   Tue Apr 4 16:46:22 2023 +0800

    ASoC: tegra20_ac97: Add missing unwind goto in tegra20_ac97_platform_probe()
    
    Smatch Warns:
            sound/soc/tegra/tegra20_ac97.c:321 tegra20_ac97_platform_probe()
            warn: missing unwind goto?
    
    The goto will set the "soc_ac97_ops" and "soc_ac97_bus" operations to
    NULL.  But they are already NULL at this point so it is a no-op.
    However, just for consistency, change the direct return to a goto.  No
    functional change.
    
    Signed-off-by: Zihao Wang &lt;u202012060@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Link: https://lore.kernel.org/r/20230404084622.1202-1-u202012060@hust.edu.cn
    Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;

diff --git a/sound/soc/tegra/tegra20_ac97.c b/sound/soc/tegra/tegra20_ac97.c
index fea6955f7f43..c498145e76e0 100644
--- a/sound/soc/tegra/tegra20_ac97.c
+++ b/sound/soc/tegra/tegra20_ac97.c
@@ -318,7 +318,8 @@ static int tegra20_ac97_platform_probe(struct platform_device *pdev)
 	ac97-&gt;reset = devm_reset_control_get_exclusive(&amp;pdev-&gt;dev, "ac97");
 	if (IS_ERR(ac97-&gt;reset)) {
 		dev_err(&amp;pdev-&gt;dev, "Can't retrieve ac97 reset\n");
-		return PTR_ERR(ac97-&gt;reset);
+		ret = PTR_ERR(ac97-&gt;reset);
+		goto err;
 	}
 
 	ac97-&gt;clk_ac97 = devm_clk_get(&amp;pdev-&gt;dev, NULL);</pre><hr><pre>commit fc187a46a8e682f0f1167b230792b88de01ceaa0
Author: Li Yang &lt;lidaxian@hust.edu.cn&gt;
Date:   Fri Mar 31 17:55:44 2023 +0800

    soc: renesas: renesas-soc: Release 'chipid' from ioremap()
    
    Smatch reports:
    
    drivers/soc/renesas/renesas-soc.c:536 renesas_soc_init() warn:
    'chipid' from ioremap() not released on lines: 475.
    
    If soc_dev_atrr allocation is failed, function renesas_soc_init()
    will return without releasing 'chipid' from ioremap().
    
    Fix this by adding function iounmap().
    
    Fixes: cb5508e47e60 ("soc: renesas: Add support for reading product revision for RZ/G2L family")
    Signed-off-by: Li Yang &lt;lidaxian@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Geert Uytterhoeven &lt;geert+renesas@glider.be&gt;
    Link: https://lore.kernel.org/r/20230331095545.31823-1-lidaxian@hust.edu.cn
    Signed-off-by: Geert Uytterhoeven &lt;geert+renesas@glider.be&gt;

diff --git a/drivers/soc/renesas/renesas-soc.c b/drivers/soc/renesas/renesas-soc.c
index 4ba893e45427..42af7c09f743 100644
--- a/drivers/soc/renesas/renesas-soc.c
+++ b/drivers/soc/renesas/renesas-soc.c
@@ -469,8 +469,11 @@ static int __init renesas_soc_init(void)
 	}
 
 	soc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);
-	if (!soc_dev_attr)
+	if (!soc_dev_attr) {
+		if (chipid)
+			iounmap(chipid);
 		return -ENOMEM;
+	}
 
 	np = of_find_node_by_path("/");
 	of_property_read_string(np, "model", &amp;soc_dev_attr-&gt;machine);</pre><hr><pre>commit c3fbced9af885a6f217fd95509a613d6590916ce
Author: Zhaoyang Li &lt;lizhaoyang04@hust.edu.cn&gt;
Date:   Mon Mar 27 19:54:22 2023 +0800

    soc: bcm: brcmstb: biuctrl: fix of_iomap leak
    
    Smatch reports:
    
    drivers/soc/bcm/brcmstb/biuctrl.c:291 setup_hifcpubiuctrl_regs() warn:
    'cpubiuctrl_base' from of_iomap() not released on lines: 291.
    
    This is because in setup_hifcpubiuctrl_regs(),
    cpubiuctrl_base is not released when handle error, which may cause a leak.
    To fix this, iounmap is added when handle error.
    
    Fixes: 22f7a9116eba ("soc: brcmstb: Correct CPU_CREDIT_REG offset for Brahma-B53 CPUs")
    Signed-off-by: Zhaoyang Li &lt;lizhaoyang04@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230327115422.1536615-1-lizhaoyang04@hust.edu.cn
    Signed-off-by: Florian Fainelli &lt;f.fainelli@gmail.com&gt;

diff --git a/drivers/soc/bcm/brcmstb/biuctrl.c b/drivers/soc/bcm/brcmstb/biuctrl.c
index e1d7b4543248..364ddbe365c2 100644
--- a/drivers/soc/bcm/brcmstb/biuctrl.c
+++ b/drivers/soc/bcm/brcmstb/biuctrl.c
@@ -288,6 +288,10 @@ static int __init setup_hifcpubiuctrl_regs(struct device_node *np)
 	if (BRCM_ID(family_id) == 0x7260 &amp;&amp; BRCM_REV(family_id) == 0)
 		cpubiuctrl_regs = b53_cpubiuctrl_no_wb_regs;
 out:
+	if (ret &amp;&amp; cpubiuctrl_base) {
+		iounmap(cpubiuctrl_base);
+		cpubiuctrl_base = NULL;
+	}
 	return ret;
 }
 </pre><hr><pre>commit db2c2b161d4a8f4a81e6f643848b1531517a67a5
Author: Mingxuan Xiang &lt;mx_xiang@hust.edu.cn&gt;
Date:   Fri Mar 24 14:09:34 2023 +0800

    usb: dwc3: host: remove dead code in dwc3_host_get_irq()
    
    According to the description of platform_get_irq()
     * Return: non-zero IRQ number on success,
                            negative error number on failure.
    and the code, platform_get_irq() will return -EINVAL
    instead of IRQ0.
    
    So platform_get_irq() no longer returns 0, there is no
    need to check whether the return value is 0.
    
    Found by Smatch:
    drivers/usb/dwc3/host.c:60 dwc3_host_get_irq()
            warn: platform_get_irq() does not return zero
    
    Signed-off-by: Mingxuan Xiang &lt;mx_xiang@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Acked-by: Thinh Nguyen &lt;Thinh.Nguyen@synopsys.com&gt;
    Link: https://lore.kernel.org/r/20230324060934.1686859-1-mx_xiang@hust.edu.cn
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;

diff --git a/drivers/usb/dwc3/host.c b/drivers/usb/dwc3/host.c
index f6f13e7f1ba1..61f57fe5bb78 100644
--- a/drivers/usb/dwc3/host.c
+++ b/drivers/usb/dwc3/host.c
@@ -52,13 +52,8 @@ static int dwc3_host_get_irq(struct dwc3 *dwc)
 		goto out;
 
 	irq = platform_get_irq(dwc3_pdev, 0);
-	if (irq &gt; 0) {
+	if (irq &gt; 0)
 		dwc3_host_fill_xhci_irq_res(dwc, irq, NULL);
-		goto out;
-	}
-
-	if (!irq)
-		irq = -EINVAL;
 
 out:
 	return irq;</pre><hr><pre>commit f33642224e38d7e0d59336e10e7b4e370b1c4506
Author: SongJingyi &lt;u201912584@hust.edu.cn&gt;
Date:   Fri Mar 24 11:14:06 2023 +0800

    ptp_qoriq: fix memory leak in probe()
    
    Smatch complains that:
    drivers/ptp/ptp_qoriq.c ptp_qoriq_probe()
    warn: 'base' from ioremap() not released.
    
    Fix this by revising the parameter from 'ptp_qoriq-&gt;base' to 'base'.
    This is only a bug if ptp_qoriq_init() returns on the
    first -ENODEV error path.
    For other error paths ptp_qoriq-&gt;base and base are the same.
    And this change makes the code more readable.
    
    Fixes: 7f4399ba405b ("ptp_qoriq: fix NULL access if ptp dt node missing")
    Signed-off-by: SongJingyi &lt;u201912584@hust.edu.cn&gt;
    Reviewed-by: Dan Carpenter &lt;error27@gmail.com&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230324031406.1895159-1-u201912584@hust.edu.cn
    Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;

diff --git a/drivers/ptp/ptp_qoriq.c b/drivers/ptp/ptp_qoriq.c
index 61530167efe4..350154e4c2b5 100644
--- a/drivers/ptp/ptp_qoriq.c
+++ b/drivers/ptp/ptp_qoriq.c
@@ -637,7 +637,7 @@ static int ptp_qoriq_probe(struct platform_device *dev)
 	return 0;
 
 no_clock:
-	iounmap(ptp_qoriq-&gt;base);
+	iounmap(base);
 no_ioremap:
 	release_resource(ptp_qoriq-&gt;rsrc);
 no_resource:</pre><hr><pre>commit 813cc94c7847ae4a17e9f744fb4dbdf7df6bd732
Author: Tianyi Jing &lt;jingfelix@hust.edu.cn&gt;
Date:   Sat Mar 18 22:38:51 2023 +0800

    hwmon: (xgene) Fix ioremap and memremap leak
    
    Smatch reports:
    
    drivers/hwmon/xgene-hwmon.c:757 xgene_hwmon_probe() warn:
    'ctx-&gt;pcc_comm_addr' from ioremap() not released on line: 757.
    
    This is because in drivers/hwmon/xgene-hwmon.c:701 xgene_hwmon_probe(),
    ioremap and memremap is not released, which may cause a leak.
    
    To fix this, ioremap and memremap is modified to devm_ioremap and
    devm_memremap.
    
    Signed-off-by: Tianyi Jing &lt;jingfelix@hust.edu.cn&gt;
    Reviewed-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230318143851.2191625-1-jingfelix@hust.edu.cn
    [groeck: Fixed formatting and subject]
    Signed-off-by: Guenter Roeck &lt;linux@roeck-us.net&gt;

diff --git a/drivers/hwmon/xgene-hwmon.c b/drivers/hwmon/xgene-hwmon.c
index d1abea49f01b..78d9f52e2a71 100644
--- a/drivers/hwmon/xgene-hwmon.c
+++ b/drivers/hwmon/xgene-hwmon.c
@@ -698,14 +698,14 @@ static int xgene_hwmon_probe(struct platform_device *pdev)
 		ctx-&gt;comm_base_addr = pcc_chan-&gt;shmem_base_addr;
 		if (ctx-&gt;comm_base_addr) {
 			if (version == XGENE_HWMON_V2)
-				ctx-&gt;pcc_comm_addr = (void __force *)ioremap(
-							ctx-&gt;comm_base_addr,
-							pcc_chan-&gt;shmem_size);
+				ctx-&gt;pcc_comm_addr = (void __force *)devm_ioremap(&amp;pdev-&gt;dev,
+								  ctx-&gt;comm_base_addr,
+								  pcc_chan-&gt;shmem_size);
 			else
-				ctx-&gt;pcc_comm_addr = memremap(
-							ctx-&gt;comm_base_addr,
-							pcc_chan-&gt;shmem_size,
-							MEMREMAP_WB);
+				ctx-&gt;pcc_comm_addr = devm_memremap(&amp;pdev-&gt;dev,
+								   ctx-&gt;comm_base_addr,
+								   pcc_chan-&gt;shmem_size,
+								   MEMREMAP_WB);
 		} else {
 			dev_err(&amp;pdev-&gt;dev, "Failed to get PCC comm region\n");
 			rc = -ENODEV;</pre><hr><pre>commit 8d13d50b157655247cdb3a69aca7836b58ff8735
Author: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
Date:   Thu Mar 9 12:01:06 2023 +0800

    platform/x86/intel: tpmi: Revise the comment of intel_vsec_add_aux
    
    intel_vsec_add_aux() is resource managed including res and
    feature_vsec_dev memory.
    
    Fix this by revising the comment of intel_vsec_add_aux since res variable
    will also be freed in the intel_vsec_add_aux.
    
    Signed-off-by: Dongliang Mu &lt;dzm91@hust.edu.cn&gt;
    Link: https://lore.kernel.org/r/20230309040107.534716-3-dzm91@hust.edu.cn
    Reviewed-by: Hans de Goede &lt;hdegoede@redhat.com&gt;
    Signed-off-by: Hans de Goede &lt;hdegoede@redhat.com&gt;

diff --git a/drivers/platform/x86/intel/tpmi.c b/drivers/platform/x86/intel/tpmi.c
index a8733c43e4ab..a5227951decc 100644
--- a/drivers/platform/x86/intel/tpmi.c
+++ b/drivers/platform/x86/intel/tpmi.c
@@ -239,8 +239,8 @@ static int tpmi_create_device(struct intel_tpmi_info *tpmi_info,
 	/*
 	 * intel_vsec_add_aux() is resource managed, no explicit
 	 * delete is required on error or on module unload.
-	 * feature_vsec_dev memory is also freed as part of device
-	 * delete.
+	 * feature_vsec_dev and res memory are also freed as part of
+	 * device deletion.
 	 */
 	return intel_vsec_add_aux(vsec_dev-&gt;pcidev, &amp;vsec_dev-&gt;auxdev.dev,
 				  feature_vsec_dev, feature_id_name);</pre>
    <div class="pagination">
        <a href='14_5.html'>&lt;&lt;Prev</a><a href='14.html'>1</a><a href='14_2.html'>2</a><a href='14_3.html'>3</a><a href='14_4.html'>4</a><a href='14_5.html'>5</a><span>[6]</span><a href='14_7.html'>7</a><a href='14_8.html'>8</a><a href='14_7.html'>Next&gt;&gt;</a>
    <div>
</body>
