<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by University of Pittsburgh</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by University of Pittsburgh</h1>
    <div class="pagination">
        <span>[1]</span>
    </div>
    <hr>
    <pre>commit ab52a484455007b3c9c11e18f6d0eed6d8f2de4e
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Wed Jun 28 23:40:21 2017 +0900

    kselftest: add ksft_print_msg() function to output general information
    
    Add a generic information output function: ksft_print_msg()
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/kselftest.h b/tools/testing/selftests/kselftest.h
index a00844e4c915..08e90c2cc5cb 100644
--- a/tools/testing/selftests/kselftest.h
+++ b/tools/testing/selftests/kselftest.h
@@ -55,6 +55,16 @@ static inline void ksft_print_cnts(void)
 	printf("1..%d\n", ksft_test_num());
 }
 
+static inline void ksft_print_msg(const char *msg, ...)
+{
+	va_list args;
+
+	va_start(args, msg);
+	printf("# ");
+	vprintf(msg, args);
+	va_end(args);
+}
+
 static inline void ksft_test_result_pass(const char *msg, ...)
 {
 	va_list args;</pre><hr><pre>commit 151b2732111f0743e764a7bc62d4f580341a62f3
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Wed Jun 28 23:40:20 2017 +0900

    kselftest: make ksft_* output functions variadic
    
    Make the ksft_* output functions variadic to allow string formatting
    directly in these functions.
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/kselftest.h b/tools/testing/selftests/kselftest.h
index be01f2d15472..a00844e4c915 100644
--- a/tools/testing/selftests/kselftest.h
+++ b/tools/testing/selftests/kselftest.h
@@ -12,6 +12,7 @@
 
 #include &lt;stdlib.h&gt;
 #include &lt;unistd.h&gt;
+#include &lt;stdarg.h&gt;
 
 /* define kselftest exit codes */
 #define KSFT_PASS  0
@@ -54,22 +55,40 @@ static inline void ksft_print_cnts(void)
 	printf("1..%d\n", ksft_test_num());
 }
 
-static inline void ksft_test_result_pass(const char *msg)
+static inline void ksft_test_result_pass(const char *msg, ...)
 {
+	va_list args;
+
 	ksft_cnt.ksft_pass++;
-	printf("ok %d %s\n", ksft_test_num(), msg);
+
+	va_start(args, msg);
+	printf("ok %d ", ksft_test_num());
+	vprintf(msg, args);
+	va_end(args);
 }
 
-static inline void ksft_test_result_fail(const char *msg)
+static inline void ksft_test_result_fail(const char *msg, ...)
 {
+	va_list args;
+
 	ksft_cnt.ksft_fail++;
-	printf("not ok %d %s\n", ksft_test_num(), msg);
+
+	va_start(args, msg);
+	printf("not ok %d ", ksft_test_num());
+	vprintf(msg, args);
+	va_end(args);
 }
 
-static inline void ksft_test_result_skip(const char *msg)
+static inline void ksft_test_result_skip(const char *msg, ...)
 {
+	va_list args;
+
 	ksft_cnt.ksft_xskip++;
-	printf("ok %d # skip %s\n", ksft_test_num(), msg);
+
+	va_start(args, msg);
+	printf("ok %d # skip ", ksft_test_num());
+	vprintf(msg, args);
+	va_end(args);
 }
 
 static inline int ksft_exit_pass(void)
@@ -85,9 +104,15 @@ static inline int ksft_exit_fail(void)
 	exit(KSFT_FAIL);
 }
 
-static inline int ksft_exit_fail_msg(const char *msg)
+static inline int ksft_exit_fail_msg(const char *msg, ...)
 {
-	printf("Bail out! %s\n", msg);
+	va_list args;
+
+	va_start(args, msg);
+	printf("Bail out! ");
+	vprintf(msg, args);
+	va_end(args);
+
 	ksft_print_cnts();
 	exit(KSFT_FAIL);
 }
@@ -104,12 +129,18 @@ static inline int ksft_exit_xpass(void)
 	exit(KSFT_XPASS);
 }
 
-static inline int ksft_exit_skip(const char *msg)
+static inline int ksft_exit_skip(const char *msg, ...)
 {
-	if (msg)
-		printf("1..%d # Skipped: %s\n", ksft_test_num(), msg);
-	else
+	if (msg) {
+		va_list args;
+
+		va_start(args, msg);
+		printf("1..%d # Skipped: ", ksft_test_num());
+		vprintf(msg, args);
+		va_end(args);
+	} else {
 		ksft_print_cnts();
+	}
 	exit(KSFT_SKIP);
 }
 </pre><hr><pre>commit e4d1065b315b433f224920f1617bc3783230501c
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Fri Jun 16 00:54:22 2017 +0900

    kselftest: make callers of ksft_exit_skip() output the reason for skipping
    
    Make the three tests that did use the old ksft_ext_skip()
    (breakpoints/breakpoint_test_arm64, breakpoints/step_after_suspend_test,
    and membarrier_test) use the new one, with an output for the
    reason for skipping all the tests.
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/breakpoints/breakpoint_test_arm64.c b/tools/testing/selftests/breakpoints/breakpoint_test_arm64.c
index 3897e996541e..fa6d57af5217 100644
--- a/tools/testing/selftests/breakpoints/breakpoint_test_arm64.c
+++ b/tools/testing/selftests/breakpoints/breakpoint_test_arm64.c
@@ -101,9 +101,8 @@ static bool set_watchpoint(pid_t pid, int size, int wp)
 		return true;
 
 	if (errno == EIO) {
-		printf("ptrace(PTRACE_SETREGSET, NT_ARM_HW_WATCH) "
+		ksft_exit_skip("ptrace(PTRACE_SETREGSET, NT_ARM_HW_WATCH) "
 			"not supported on this hardware\n");
-		ksft_exit_skip();
 	}
 	perror("ptrace(PTRACE_SETREGSET, NT_ARM_HW_WATCH) failed");
 	return false;
diff --git a/tools/testing/selftests/breakpoints/step_after_suspend_test.c b/tools/testing/selftests/breakpoints/step_after_suspend_test.c
index bf37c1087f25..c60c2effb6bc 100644
--- a/tools/testing/selftests/breakpoints/step_after_suspend_test.c
+++ b/tools/testing/selftests/breakpoints/step_after_suspend_test.c
@@ -83,8 +83,8 @@ bool run_test(int cpu)
 
 	if (ptrace(PTRACE_SINGLESTEP, pid, NULL, NULL) &lt; 0) {
 		if (errno == EIO) {
-			printf("ptrace(PTRACE_SINGLESTEP) not supported on this architecture\n");
-			ksft_exit_skip();
+			ksft_exit_skip("ptrace(PTRACE_SINGLESTEP) "
+				"not supported on this architecture");
 		}
 		perror("ptrace(PTRACE_SINGLESTEP) failed");
 		return false;
diff --git a/tools/testing/selftests/membarrier/membarrier_test.c b/tools/testing/selftests/membarrier/membarrier_test.c
index cae8c984dfb0..18cb9d1da4e4 100644
--- a/tools/testing/selftests/membarrier/membarrier_test.c
+++ b/tools/testing/selftests/membarrier/membarrier_test.c
@@ -87,8 +87,7 @@ static enum test_membarrier_status test_membarrier_query(void)
 			 * It is valid to build a kernel with
 			 * CONFIG_MEMBARRIER=n. However, this skips the tests.
 			 */
-			ksft_test_result_skip("CONFIG_MEMBARRIER is not enabled\n");
-			return ksft_exit_skip();
+			ksft_exit_skip("CONFIG_MEMBARRIER is not enabled\n");
 		}
 		ksft_test_result_fail("sys_membarrier() failed\n");
 		return TEST_MEMBARRIER_FAIL;
@@ -108,13 +107,13 @@ int main(int argc, char **argv)
 	case TEST_MEMBARRIER_FAIL:
 		return ksft_exit_fail();
 	case TEST_MEMBARRIER_SKIP:
-		return ksft_exit_skip();
+		return ksft_exit_skip(NULL);
 	}
 	switch (test_membarrier()) {
 	case TEST_MEMBARRIER_FAIL:
 		return ksft_exit_fail();
 	case TEST_MEMBARRIER_SKIP:
-		return ksft_exit_skip();
+		return ksft_exit_skip(NULL);
 	}
 
 	return ksft_exit_pass();</pre><hr><pre>commit 54f57baab644e99b6da34d9538b2a9c0a05b690d
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Fri Jun 16 00:54:20 2017 +0900

    kselftest: make ksft_exit_skip() output a reason for skipping
    
    Make ksft_exit_skip() input an optional message string as the reason
    for skipping all the tests and outputs it prior to exiting.
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/kselftest.h b/tools/testing/selftests/kselftest.h
index 1d874a50d957..be01f2d15472 100644
--- a/tools/testing/selftests/kselftest.h
+++ b/tools/testing/selftests/kselftest.h
@@ -104,9 +104,12 @@ static inline int ksft_exit_xpass(void)
 	exit(KSFT_XPASS);
 }
 
-static inline int ksft_exit_skip(void)
+static inline int ksft_exit_skip(const char *msg)
 {
-	ksft_print_cnts();
+	if (msg)
+		printf("1..%d # Skipped: %s\n", ksft_test_num(), msg);
+	else
+		ksft_print_cnts();
 	exit(KSFT_SKIP);
 }
 </pre><hr><pre>commit b901216441e6599063ff2828ec7f2f902b9902f0
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Mon Jun 12 08:56:50 2017 +0200

    kselftest: breakpoints: convert step_after_suspend_test to TAP13 output
    
    Make the step_after_suspend test output in the TAP13 format by using the
    TAP13 output functions defined in kselftest.h
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Alice Ferrazzi &lt;alice.ferrazzi@gmail.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/breakpoints/step_after_suspend_test.c b/tools/testing/selftests/breakpoints/step_after_suspend_test.c
index 60b8a95dac26..bf37c1087f25 100644
--- a/tools/testing/selftests/breakpoints/step_after_suspend_test.c
+++ b/tools/testing/selftests/breakpoints/step_after_suspend_test.c
@@ -135,28 +135,21 @@ void suspend(void)
 	struct itimerspec spec = {};
 
 	power_state_fd = open("/sys/power/state", O_RDWR);
-	if (power_state_fd &lt; 0) {
-		perror("open(\"/sys/power/state\") failed (is this test running as root?)");
-		ksft_exit_fail();
-	}
+	if (power_state_fd &lt; 0)
+		ksft_exit_fail_msg(
+			"open(\"/sys/power/state\") failed (is this test running as root?)");
 
 	timerfd = timerfd_create(CLOCK_BOOTTIME_ALARM, 0);
-	if (timerfd &lt; 0) {
-		perror("timerfd_create() failed");
-		ksft_exit_fail();
-	}
+	if (timerfd &lt; 0)
+		ksft_exit_fail_msg("timerfd_create() failed");
 
 	spec.it_value.tv_sec = 5;
 	err = timerfd_settime(timerfd, 0, &amp;spec, NULL);
-	if (err &lt; 0) {
-		perror("timerfd_settime() failed");
-		ksft_exit_fail();
-	}
+	if (err &lt; 0)
+		ksft_exit_fail_msg("timerfd_settime() failed");
 
-	if (write(power_state_fd, "mem", strlen("mem")) != strlen("mem")) {
-		perror("entering suspend failed");
-		ksft_exit_fail();
-	}
+	if (write(power_state_fd, "mem", strlen("mem")) != strlen("mem"))
+		ksft_exit_fail_msg("entering suspend failed");
 
 	close(timerfd);
 	close(power_state_fd);
@@ -170,6 +163,9 @@ int main(int argc, char **argv)
 	cpu_set_t available_cpus;
 	int err;
 	int cpu;
+	char buf[10];
+
+	ksft_print_header();
 
 	while ((opt = getopt(argc, argv, "n")) != -1) {
 		switch (opt) {
@@ -187,10 +183,8 @@ int main(int argc, char **argv)
 		suspend();
 
 	err = sched_getaffinity(0, sizeof(available_cpus), &amp;available_cpus);
-	if (err &lt; 0) {
-		perror("sched_getaffinity() failed");
-		ksft_exit_fail();
-	}
+	if (err &lt; 0)
+		ksft_exit_fail_msg("sched_getaffinity() failed");
 
 	for (cpu = 0; cpu &lt; CPU_SETSIZE; cpu++) {
 		bool test_success;
@@ -199,18 +193,15 @@ int main(int argc, char **argv)
 			continue;
 
 		test_success = run_test(cpu);
-		printf("CPU %d: ", cpu);
+		sprintf(buf, "CPU %d", cpu);
 		if (test_success) {
-			printf("[OK]\n");
-			ksft_inc_pass_cnt();
+			ksft_test_result_pass(buf);
 		} else {
-			printf("[FAILED]\n");
-			ksft_inc_fail_cnt();
+			ksft_test_result_fail(buf);
 			succeeded = false;
 		}
 	}
 
-	ksft_print_cnts();
 	if (succeeded)
 		ksft_exit_pass();
 	else</pre><hr><pre>commit 748e84b79af0121a39eb55f0cb5a727e08eb91b2
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Mon Jun 12 08:56:49 2017 +0200

    kselftest: breakpoints: convert breakpoint_test to TAP13 output
    
    Make the breakpoints test output in the TAP13 format by using the
    TAP13 output functions defined in kselftest.h
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Alice Ferrazzi &lt;alice.ferrazzi@gmail.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/breakpoints/breakpoint_test.c b/tools/testing/selftests/breakpoints/breakpoint_test.c
index 120895ab5505..c02fc9a0e228 100644
--- a/tools/testing/selftests/breakpoints/breakpoint_test.c
+++ b/tools/testing/selftests/breakpoints/breakpoint_test.c
@@ -42,10 +42,8 @@ static void set_breakpoint_addr(void *addr, int n)
 
 	ret = ptrace(PTRACE_POKEUSER, child_pid,
 		     offsetof(struct user, u_debugreg[n]), addr);
-	if (ret) {
-		perror("Can't set breakpoint addr\n");
-		ksft_exit_fail();
-	}
+	if (ret)
+		ksft_exit_fail_msg("Can't set breakpoint addr");
 }
 
 static void toggle_breakpoint(int n, int type, int len,
@@ -105,10 +103,8 @@ static void toggle_breakpoint(int n, int type, int len,
 
 	ret = ptrace(PTRACE_POKEUSER, child_pid,
 		     offsetof(struct user, u_debugreg[7]), dr7);
-	if (ret) {
-		perror("Can't set dr7");
-		ksft_exit_fail();
-	}
+	if (ret)
+		ksft_exit_fail_msg("Can't set dr7");
 }
 
 /* Dummy variables to test read/write accesses */
@@ -264,26 +260,29 @@ static void check_success(const char *msg)
 	const char *msg2;
 	int child_nr_tests;
 	int status;
+	int ret;
 
 	/* Wait for the child to SIGTRAP */
 	wait(&amp;status);
 
 	msg2 = "Failed";
+	ret = 0;
 
 	if (WSTOPSIG(status) == SIGTRAP) {
 		child_nr_tests = ptrace(PTRACE_PEEKDATA, child_pid,
 					&amp;nr_tests, 0);
 		if (child_nr_tests == nr_tests)
-			msg2 = "Ok";
-		if (ptrace(PTRACE_POKEDATA, child_pid, &amp;trapped, 1)) {
-			perror("Can't poke\n");
-			ksft_exit_fail();
-		}
+			ret = 1;
+		if (ptrace(PTRACE_POKEDATA, child_pid, &amp;trapped, 1))
+			ksft_exit_fail_msg("Can't poke");
 	}
 
 	nr_tests++;
 
-	printf("%s [%s]\n", msg, msg2);
+	if (ret)
+		ksft_test_result_pass(msg);
+	else
+		ksft_test_result_fail(msg);
 }
 
 static void launch_instruction_breakpoints(char *buf, int local, int global)
@@ -378,6 +377,8 @@ int main(int argc, char **argv)
 	pid_t pid;
 	int ret;
 
+	ksft_print_header();
+
 	pid = fork();
 	if (!pid) {
 		trigger_tests();</pre><hr><pre>commit 326f57a4c378f4dacf8fbeb05a1decfeff74f54e
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Mon Jun 12 08:56:48 2017 +0200

    kselftest: membarrier: convert to TAP13 output
    
    Make the membarrier test output in the TAP13 format by using the
    TAP13 output functions defined in kselftest.h
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Alice Ferrazzi &lt;alice.ferrazzi@gmail.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/membarrier/membarrier_test.c b/tools/testing/selftests/membarrier/membarrier_test.c
index 535f0fef4d0b..cae8c984dfb0 100644
--- a/tools/testing/selftests/membarrier/membarrier_test.c
+++ b/tools/testing/selftests/membarrier/membarrier_test.c
@@ -21,36 +21,42 @@ static int sys_membarrier(int cmd, int flags)
 static enum test_membarrier_status test_membarrier_cmd_fail(void)
 {
 	int cmd = -1, flags = 0;
+	const char *test_name = "membarrier command fail";
 
 	if (sys_membarrier(cmd, flags) != -1) {
-		printf("membarrier: Wrong command should fail but passed.\n");
+		ksft_test_result_fail(test_name);
 		return TEST_MEMBARRIER_FAIL;
 	}
+
+	ksft_test_result_pass(test_name);
 	return TEST_MEMBARRIER_PASS;
 }
 
 static enum test_membarrier_status test_membarrier_flags_fail(void)
 {
 	int cmd = MEMBARRIER_CMD_QUERY, flags = 1;
+	const char *test_name = "Wrong flags should fail";
 
 	if (sys_membarrier(cmd, flags) != -1) {
-		printf("membarrier: Wrong flags should fail but passed.\n");
+		ksft_test_result_fail(test_name);
 		return TEST_MEMBARRIER_FAIL;
 	}
+
+	ksft_test_result_pass(test_name);
 	return TEST_MEMBARRIER_PASS;
 }
 
 static enum test_membarrier_status test_membarrier_success(void)
 {
 	int cmd = MEMBARRIER_CMD_SHARED, flags = 0;
+	const char *test_name = "execute MEMBARRIER_CMD_SHARED";
 
 	if (sys_membarrier(cmd, flags) != 0) {
-		printf("membarrier: Executing MEMBARRIER_CMD_SHARED failed. %s.\n",
-				strerror(errno));
+		ksft_test_result_fail(test_name);
 		return TEST_MEMBARRIER_FAIL;
 	}
 
-	printf("membarrier: MEMBARRIER_CMD_SHARED success.\n");
+	ksft_test_result_pass(test_name);
 	return TEST_MEMBARRIER_PASS;
 }
 
@@ -74,32 +80,30 @@ static enum test_membarrier_status test_membarrier_query(void)
 {
 	int flags = 0, ret;
 
-	printf("membarrier MEMBARRIER_CMD_QUERY ");
 	ret = sys_membarrier(MEMBARRIER_CMD_QUERY, flags);
 	if (ret &lt; 0) {
-		printf("failed. %s.\n", strerror(errno));
-		switch (errno) {
-		case ENOSYS:
+		if (errno == ENOSYS) {
 			/*
 			 * It is valid to build a kernel with
 			 * CONFIG_MEMBARRIER=n. However, this skips the tests.
 			 */
-			return TEST_MEMBARRIER_SKIP;
-		case EINVAL:
-		default:
-			return TEST_MEMBARRIER_FAIL;
+			ksft_test_result_skip("CONFIG_MEMBARRIER is not enabled\n");
+			return ksft_exit_skip();
 		}
+		ksft_test_result_fail("sys_membarrier() failed\n");
+		return TEST_MEMBARRIER_FAIL;
 	}
 	if (!(ret &amp; MEMBARRIER_CMD_SHARED)) {
-		printf("command MEMBARRIER_CMD_SHARED is not supported.\n");
+		ksft_test_result_fail("command MEMBARRIER_CMD_SHARED is not supported.\n");
 		return TEST_MEMBARRIER_FAIL;
 	}
-	printf("syscall available.\n");
+	ksft_test_result_pass("sys_membarrier available");
 	return TEST_MEMBARRIER_PASS;
 }
 
 int main(int argc, char **argv)
 {
+	ksft_print_header();
 	switch (test_membarrier_query()) {
 	case TEST_MEMBARRIER_FAIL:
 		return ksft_exit_fail();
@@ -113,6 +117,5 @@ int main(int argc, char **argv)
 		return ksft_exit_skip();
 	}
 
-	printf("membarrier: tests done!\n");
 	return ksft_exit_pass();
 }</pre><hr><pre>commit b6a4b66d845ae4c7f4eece419269c65ca332ba7b
Author: Paul Elder &lt;paul.elder@pitt.edu&gt;
Date:   Mon Jun 12 08:56:47 2017 +0200

    kselftest: add TAP13 conformant versions of ksft_* functions
    
    Add TAP13 conformat output functions to kselftest.h.
    
    Also add exit functions that output TAP13 exiting text, as well as
    functions to keep track of testing progress.
    
    Signed-off-by: Paul Elder &lt;paul.elder@pitt.edu&gt;
    Signed-off-by: Alice Ferrazzi &lt;alice.ferrazzi@gmail.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
    Signed-off-by: Shuah Khan &lt;shuahkh@osg.samsung.com&gt;

diff --git a/tools/testing/selftests/kselftest.h b/tools/testing/selftests/kselftest.h
index ef1c80d67ac7..1d874a50d957 100644
--- a/tools/testing/selftests/kselftest.h
+++ b/tools/testing/selftests/kselftest.h
@@ -31,38 +31,82 @@ struct ksft_count {
 
 static struct ksft_count ksft_cnt;
 
+static inline int ksft_test_num(void)
+{
+	return ksft_cnt.ksft_pass + ksft_cnt.ksft_fail +
+		ksft_cnt.ksft_xfail + ksft_cnt.ksft_xpass +
+		ksft_cnt.ksft_xskip;
+}
+
 static inline void ksft_inc_pass_cnt(void) { ksft_cnt.ksft_pass++; }
 static inline void ksft_inc_fail_cnt(void) { ksft_cnt.ksft_fail++; }
 static inline void ksft_inc_xfail_cnt(void) { ksft_cnt.ksft_xfail++; }
 static inline void ksft_inc_xpass_cnt(void) { ksft_cnt.ksft_xpass++; }
 static inline void ksft_inc_xskip_cnt(void) { ksft_cnt.ksft_xskip++; }
 
+static inline void ksft_print_header(void)
+{
+	printf("TAP version 13\n");
+}
+
 static inline void ksft_print_cnts(void)
 {
-	printf("Pass: %d Fail: %d Xfail: %d Xpass: %d, Xskip: %d\n",
-		ksft_cnt.ksft_pass, ksft_cnt.ksft_fail,
-		ksft_cnt.ksft_xfail, ksft_cnt.ksft_xpass,
-		ksft_cnt.ksft_xskip);
+	printf("1..%d\n", ksft_test_num());
+}
+
+static inline void ksft_test_result_pass(const char *msg)
+{
+	ksft_cnt.ksft_pass++;
+	printf("ok %d %s\n", ksft_test_num(), msg);
+}
+
+static inline void ksft_test_result_fail(const char *msg)
+{
+	ksft_cnt.ksft_fail++;
+	printf("not ok %d %s\n", ksft_test_num(), msg);
+}
+
+static inline void ksft_test_result_skip(const char *msg)
+{
+	ksft_cnt.ksft_xskip++;
+	printf("ok %d # skip %s\n", ksft_test_num(), msg);
 }
 
 static inline int ksft_exit_pass(void)
 {
+	ksft_print_cnts();
 	exit(KSFT_PASS);
 }
+
 static inline int ksft_exit_fail(void)
 {
+	printf("Bail out!\n");
+	ksft_print_cnts();
 	exit(KSFT_FAIL);
 }
+
+static inline int ksft_exit_fail_msg(const char *msg)
+{
+	printf("Bail out! %s\n", msg);
+	ksft_print_cnts();
+	exit(KSFT_FAIL);
+}
+
 static inline int ksft_exit_xfail(void)
 {
+	ksft_print_cnts();
 	exit(KSFT_XFAIL);
 }
+
 static inline int ksft_exit_xpass(void)
 {
+	ksft_print_cnts();
 	exit(KSFT_XPASS);
 }
+
 static inline int ksft_exit_skip(void)
 {
+	ksft_print_cnts();
 	exit(KSFT_SKIP);
 }
 </pre>
    <div class="pagination">
        <span>[1]</span>
    <div>
</body>
