<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patches contributed by Massachusetts Institute of Technology</title>
    <style>
    .pagination {
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        overflow-wrap: break-word;
    }
    .pagination a, .pagination span {
        margin: 0 4px;
    }

    </style>
</head>
<body>
    <h1>Patches contributed by Massachusetts Institute of Technology</h1>
    <div class="pagination">
        <a href='1_143.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><a href='1_43.html'>43</a><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><a href='1_77.html'>77</a><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><span>[144]</span><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_145.html'>Next&gt;&gt;</a>
    </div>
    <hr>
    <pre>commit 710d86f8bc4515a906799b85135e6f6962703e01
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Fri Dec 6 18:56:53 2013 -0500

    MIPS: BCM47XX: Fix some very confused types and data corruption
    
    Fix nvram_read_alpha2 copying too many bytes over the ssb_sprom
    structure. Also fix the arguments of the read_macaddr, although the code
    was technically not wrong before due to an extra dereference.
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Acked-by: Hauke Mehrtens &lt;hauke@hauke-m.de&gt;
    Signed-off-by: John Crispin &lt;blogic@openwrt.org&gt;
    Patchwork: http://patchwork.linux-mips.org/patch/6211/

diff --git a/arch/mips/bcm47xx/sprom.c b/arch/mips/bcm47xx/sprom.c
index ad03c931b905..a8b5408dd349 100644
--- a/arch/mips/bcm47xx/sprom.c
+++ b/arch/mips/bcm47xx/sprom.c
@@ -135,7 +135,7 @@ static void nvram_read_leddc(const char *prefix, const char *name,
 }
 
 static void nvram_read_macaddr(const char *prefix, const char *name,
-			       u8 (*val)[6], bool fallback)
+			       u8 val[6], bool fallback)
 {
 	char buf[100];
 	int err;
@@ -144,11 +144,11 @@ static void nvram_read_macaddr(const char *prefix, const char *name,
 	if (err &lt; 0)
 		return;
 
-	bcm47xx_nvram_parse_macaddr(buf, *val);
+	bcm47xx_nvram_parse_macaddr(buf, val);
 }
 
 static void nvram_read_alpha2(const char *prefix, const char *name,
-			     char (*val)[2], bool fallback)
+			     char val[2], bool fallback)
 {
 	char buf[10];
 	int err;
@@ -162,7 +162,7 @@ static void nvram_read_alpha2(const char *prefix, const char *name,
 		pr_warn("alpha2 is too long %s\n", buf);
 		return;
 	}
-	memcpy(val, buf, sizeof(val));
+	memcpy(val, buf, 2);
 }
 
 static void bcm47xx_fill_sprom_r1234589(struct ssb_sprom *sprom,
@@ -180,7 +180,7 @@ static void bcm47xx_fill_sprom_r1234589(struct ssb_sprom *sprom,
 		      fallback);
 	nvram_read_s8(prefix, NULL, "ag1", &amp;sprom-&gt;antenna_gain.a1, 0,
 		      fallback);
-	nvram_read_alpha2(prefix, "ccode", &amp;sprom-&gt;alpha2, fallback);
+	nvram_read_alpha2(prefix, "ccode", sprom-&gt;alpha2, fallback);
 }
 
 static void bcm47xx_fill_sprom_r12389(struct ssb_sprom *sprom,
@@ -633,20 +633,20 @@ static void bcm47xx_fill_sprom_path_r45(struct ssb_sprom *sprom,
 static void bcm47xx_fill_sprom_ethernet(struct ssb_sprom *sprom,
 					const char *prefix, bool fallback)
 {
-	nvram_read_macaddr(prefix, "et0macaddr", &amp;sprom-&gt;et0mac, fallback);
+	nvram_read_macaddr(prefix, "et0macaddr", sprom-&gt;et0mac, fallback);
 	nvram_read_u8(prefix, NULL, "et0mdcport", &amp;sprom-&gt;et0mdcport, 0,
 		      fallback);
 	nvram_read_u8(prefix, NULL, "et0phyaddr", &amp;sprom-&gt;et0phyaddr, 0,
 		      fallback);
 
-	nvram_read_macaddr(prefix, "et1macaddr", &amp;sprom-&gt;et1mac, fallback);
+	nvram_read_macaddr(prefix, "et1macaddr", sprom-&gt;et1mac, fallback);
 	nvram_read_u8(prefix, NULL, "et1mdcport", &amp;sprom-&gt;et1mdcport, 0,
 		      fallback);
 	nvram_read_u8(prefix, NULL, "et1phyaddr", &amp;sprom-&gt;et1phyaddr, 0,
 		      fallback);
 
-	nvram_read_macaddr(prefix, "macaddr", &amp;sprom-&gt;il0mac, fallback);
-	nvram_read_macaddr(prefix, "il0macaddr", &amp;sprom-&gt;il0mac, fallback);
+	nvram_read_macaddr(prefix, "macaddr", sprom-&gt;il0mac, fallback);
+	nvram_read_macaddr(prefix, "il0macaddr", sprom-&gt;il0mac, fallback);
 }
 
 static void bcm47xx_fill_board_data(struct ssb_sprom *sprom, const char *prefix,</pre><hr><pre>commit 72de182362e013b2c2cc92092d97fff58e429d5d
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Sun Jan 19 10:30:32 2014 -0500

    drm/nouveau/mxm: fix null deref on load
    
    Since commit 61b365a505d6 ("drm/nouveau: populate master subdev pointer
    only when fully constructed"), the nouveau_mxm(bios) call will return
    NULL, since it's still being called from the constructor.  Instead, pass
    the mxm pointer via the unused data field.
    
    See https://bugs.freedesktop.org/show_bug.cgi?id=73791
    
    Reported-by: Andreas Reis &lt;andreas.reis@gmail.com&gt;
    Tested-by: Andreas Reis &lt;andreas.reis@gmail.com&gt;
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Cc: Ben Skeggs &lt;bskeggs@redhat.com&gt;
    Cc: Dave Airlie &lt;airlied@linux.ie&gt;
    Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;

diff --git a/drivers/gpu/drm/nouveau/core/subdev/mxm/nv50.c b/drivers/gpu/drm/nouveau/core/subdev/mxm/nv50.c
index af129c2e8113..64f8b4702bf7 100644
--- a/drivers/gpu/drm/nouveau/core/subdev/mxm/nv50.c
+++ b/drivers/gpu/drm/nouveau/core/subdev/mxm/nv50.c
@@ -100,7 +100,7 @@ mxm_match_dcb(struct nouveau_mxm *mxm, u8 *data, void *info)
 static int
 mxm_dcb_sanitise_entry(struct nouveau_bios *bios, void *data, int idx, u16 pdcb)
 {
-	struct nouveau_mxm *mxm = nouveau_mxm(bios);
+	struct nouveau_mxm *mxm = data;
 	struct context ctx = { .outp = (u32 *)(bios-&gt;data + pdcb) };
 	u8 type, i2cidx, link, ver, len;
 	u8 *conn;
@@ -199,7 +199,7 @@ mxm_dcb_sanitise(struct nouveau_mxm *mxm)
 		return;
 	}
 
-	dcb_outp_foreach(bios, NULL, mxm_dcb_sanitise_entry);
+	dcb_outp_foreach(bios, mxm, mxm_dcb_sanitise_entry);
 	mxms_foreach(mxm, 0x01, mxm_show_unmatched, NULL);
 }
 </pre><hr><pre>commit 5d2f4767c4eacab351b8450b0de4d3261fe1a957
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Tue Jan 7 12:33:59 2014 -0500

    drm/nouveau/bios: fix offset calculation for BMPv1 bioses
    
    The only BIOS on record that needs the 14 offset has a bios major
    version 2 but BMP version 1.01. Another bunch of BIOSes that need the 18
    offset have BMP version 2.01 or 5.01 or higher. So instead of looking at the
    bios major version, look at the BMP version. BIOSes with BMP version 0
    do not contain a detectable script, so always return 0 for them.
    
    See https://bugs.freedesktop.org/show_bug.cgi?id=68835
    
    Reported-by: Mauro Molinari &lt;mauromol@tiscali.it&gt;
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Signed-off-by: Ben Skeggs &lt;bskeggs@redhat.com&gt;

diff --git a/drivers/gpu/drm/nouveau/core/subdev/bios/init.c b/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
index 9f5b81e99731..df1b1b423093 100644
--- a/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
+++ b/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
@@ -365,13 +365,13 @@ static u16
 init_script(struct nouveau_bios *bios, int index)
 {
 	struct nvbios_init init = { .bios = bios };
-	u16 data;
+	u16 bmp_ver = bmp_version(bios), data;
 
-	if (bmp_version(bios) &amp;&amp; bmp_version(bios) &lt; 0x0510) {
-		if (index &gt; 1)
+	if (bmp_ver &amp;&amp; bmp_ver &lt; 0x0510) {
+		if (index &gt; 1 || bmp_ver &lt; 0x0100)
 			return 0x0000;
 
-		data = bios-&gt;bmp_offset + (bios-&gt;version.major &lt; 2 ? 14 : 18);
+		data = bios-&gt;bmp_offset + (bmp_ver &lt; 0x0200 ? 14 : 18);
 		return nv_ro16(bios, data + (index * 2));
 	}
 </pre><hr><pre>commit 6d60792ec059d9f2139828f9f017679abb81aa73
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Sun Jan 5 20:07:02 2014 -0500

    drm/nouveau/bios: make jump conditional
    
    This fixes a hang in VBIOS scripts of the form "condition; jump".
    The jump used to always be executed, while now it will only be
    executed if the condition is true.
    
    See https://bugs.freedesktop.org/show_bug.cgi?id=72943
    
    Reported-by: Darcy Brás da Silva &lt;dardevelin@cidadecool.com&gt;
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Cc: stable@vger.kernel.org

diff --git a/drivers/gpu/drm/nouveau/core/subdev/bios/init.c b/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
index 420908cb82b6..9f5b81e99731 100644
--- a/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
+++ b/drivers/gpu/drm/nouveau/core/subdev/bios/init.c
@@ -1294,7 +1294,11 @@ init_jump(struct nvbios_init *init)
 	u16 offset = nv_ro16(bios, init-&gt;offset + 1);
 
 	trace("JUMP\t0x%04x\n", offset);
-	init-&gt;offset = offset;
+
+	if (init_exec(init))
+		init-&gt;offset = offset;
+	else
+		init-&gt;offset += 3;
 }
 
 /**</pre><hr><pre>commit b25b4427e9dfba073cf9bc86603956ed395eb6e3
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Wed Dec 11 22:19:01 2013 -0500

    drm/nouveau: only runtime suspend by default in optimus configuration
    
    The intent was to only enable it by default for optimus, e.g. see the
    runtime_idle callback. The suspend callback may be called directly, e.g.
    as a result of nouveau_crtc_set_config.
    
    Reported-by: Stefan Lippers-Hollmann &lt;s.l-h@gmx.de&gt;
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Tested-by: Stefan Lippers-Hollmann &lt;s.l-h@gmx.de&gt;
    Cc: stable@vger.kernel.org
    Signed-off-by: Dave Airlie &lt;airlied@redhat.com&gt;

diff --git a/drivers/gpu/drm/nouveau/nouveau_drm.c b/drivers/gpu/drm/nouveau/nouveau_drm.c
index 7a3759f1c41a..98a22e6e27a1 100644
--- a/drivers/gpu/drm/nouveau/nouveau_drm.c
+++ b/drivers/gpu/drm/nouveau/nouveau_drm.c
@@ -858,6 +858,12 @@ static int nouveau_pmops_runtime_suspend(struct device *dev)
 	if (nouveau_runtime_pm == 0)
 		return -EINVAL;
 
+	/* are we optimus enabled? */
+	if (nouveau_runtime_pm == -1 &amp;&amp; !nouveau_is_optimus() &amp;&amp; !nouveau_is_v1_dsm()) {
+		DRM_DEBUG_DRIVER("failing to power off - not optimus\n");
+		return -EINVAL;
+	}
+
 	nv_debug_level(SILENT);
 	drm_kms_helper_poll_disable(drm_dev);
 	vga_switcheroo_set_dynamic_switch(pdev, VGA_SWITCHEROO_OFF);</pre><hr><pre>commit 0f58411d4fd704d8958879fb08751eae3573271b
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Thu Dec 5 09:42:49 2013 -0500

    drm: don't double-free on driver load error
    
    All instances of drm_dev_register are followed by drm_dev_free on
    failure. Don't free dev-&gt;control/render/primary on failure, as they will
    be freed by drm_dev_free since commit 8f6599da8e (drm: delay minor
    destruction to drm_dev_free()). Instead unplug them.
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Reported-and-tested-by: Bruno Prémont &lt;bonbons@linux-vserver.org&gt;
    Reviewed-by: David Herrmann &lt;dh.herrmann@gmail.com&gt;
    Signed-off-by: Dave Airlie &lt;airlied@redhat.com&gt;

diff --git a/drivers/gpu/drm/drm_stub.c b/drivers/gpu/drm/drm_stub.c
index f53d5246979c..66dd3a001cf1 100644
--- a/drivers/gpu/drm/drm_stub.c
+++ b/drivers/gpu/drm/drm_stub.c
@@ -566,11 +566,11 @@ int drm_dev_register(struct drm_device *dev, unsigned long flags)
 	if (dev-&gt;driver-&gt;unload)
 		dev-&gt;driver-&gt;unload(dev);
 err_primary_node:
-	drm_put_minor(dev-&gt;primary);
+	drm_unplug_minor(dev-&gt;primary);
 err_render_node:
-	drm_put_minor(dev-&gt;render);
+	drm_unplug_minor(dev-&gt;render);
 err_control_node:
-	drm_put_minor(dev-&gt;control);
+	drm_unplug_minor(dev-&gt;control);
 err_agp:
 	if (dev-&gt;driver-&gt;bus-&gt;agp_destroy)
 		dev-&gt;driver-&gt;bus-&gt;agp_destroy(dev);</pre><hr><pre>commit 1b429835be7ce514b36b551e785d425fd56cd1f2
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Fri Dec 6 19:43:37 2013 -0500

    powerpc/44x: Fix ocm_block allocation
    
    Allocate enough memory for the ocm_block structure, not just a pointer
    to it.
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Signed-off-by: Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;

diff --git a/arch/powerpc/sysdev/ppc4xx_ocm.c b/arch/powerpc/sysdev/ppc4xx_ocm.c
index b7c43453236d..85d9e37f5ccb 100644
--- a/arch/powerpc/sysdev/ppc4xx_ocm.c
+++ b/arch/powerpc/sysdev/ppc4xx_ocm.c
@@ -339,7 +339,7 @@ void *ppc4xx_ocm_alloc(phys_addr_t *phys, int size, int align,
 		if (IS_ERR_VALUE(offset))
 			continue;
 
-		ocm_blk = kzalloc(sizeof(struct ocm_block *), GFP_KERNEL);
+		ocm_blk = kzalloc(sizeof(struct ocm_block), GFP_KERNEL);
 		if (!ocm_blk) {
 			printk(KERN_ERR "PPC4XX OCM: could not allocate ocm block");
 			rh_free(ocm_reg-&gt;rh, offset);</pre><hr><pre>commit efffa9841cf42ae8350d421070cea962b063df8c
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Fri Nov 15 11:26:43 2013 -0500

    drm/nv10/plane: some chipsets don't support NV12
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Signed-off-by: Ben Skeggs &lt;bskeggs@redhat.com&gt;

diff --git a/drivers/gpu/drm/nouveau/dispnv04/overlay.c b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
index c14afb794147..32e7064b819b 100644
--- a/drivers/gpu/drm/nouveau/dispnv04/overlay.c
+++ b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
@@ -58,8 +58,8 @@ struct nouveau_plane {
 };
 
 static uint32_t formats[] = {
-	DRM_FORMAT_NV12,
 	DRM_FORMAT_UYVY,
+	DRM_FORMAT_NV12,
 };
 
 /* Sine can be approximated with
@@ -254,14 +254,25 @@ nv10_overlay_init(struct drm_device *device)
 {
 	struct nouveau_device *dev = nouveau_dev(device);
 	struct nouveau_plane *plane = kzalloc(sizeof(struct nouveau_plane), GFP_KERNEL);
+	int num_formats = ARRAY_SIZE(formats);
 	int ret;
 
 	if (!plane)
 		return;
 
+	switch (dev-&gt;chipset) {
+	case 0x10:
+	case 0x11:
+	case 0x15:
+	case 0x1a:
+	case 0x20:
+		num_formats = 1;
+		break;
+	}
+
 	ret = drm_plane_init(device, &amp;plane-&gt;base, 3 /* both crtc's */,
 			     &amp;nv10_plane_funcs,
-			     formats, ARRAY_SIZE(formats), false);
+			     formats, num_formats, false);
 	if (ret)
 		goto err;
 </pre><hr><pre>commit 050828e9563d03cbaab950c16ae4aebaa02ff0de
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Fri Nov 15 11:26:42 2013 -0500

    drm/nv10/plane: add downscaling restrictions
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Signed-off-by: Ben Skeggs &lt;bskeggs@redhat.com&gt;

diff --git a/drivers/gpu/drm/nouveau/dispnv04/overlay.c b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
index 514a3055903c..c14afb794147 100644
--- a/drivers/gpu/drm/nouveau/dispnv04/overlay.c
+++ b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
@@ -112,7 +112,15 @@ nv10_update_plane(struct drm_plane *plane, struct drm_crtc *crtc,
 	format = ALIGN(src_w * 4, 0x100);
 
 	if (format &gt; 0xffff)
-		return -EINVAL;
+		return -ERANGE;
+
+	if (dev-&gt;chipset &gt;= 0x30) {
+		if (crtc_w &lt; (src_w &gt;&gt; 1) || crtc_h &lt; (src_h &gt;&gt; 1))
+			return -ERANGE;
+	} else {
+		if (crtc_w &lt; (src_w &gt;&gt; 3) || crtc_h &lt; (src_h &gt;&gt; 3))
+			return -ERANGE;
+	}
 
 	ret = nouveau_bo_pin(nv_fb-&gt;nvbo, TTM_PL_FLAG_VRAM);
 	if (ret)</pre><hr><pre>commit 92e5b0a2b121c29eac31e6d8106ceefa31de46a9
Author: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
Date:   Fri Nov 15 11:26:41 2013 -0500

    drm/nv10/plane: fix format computation
    
    Otherwise none of the format checks pass, since the width was still in
    16.16 encoding.
    
    Signed-off-by: Ilia Mirkin &lt;imirkin@alum.mit.edu&gt;
    Signed-off-by: Ben Skeggs &lt;bskeggs@redhat.com&gt;

diff --git a/drivers/gpu/drm/nouveau/dispnv04/overlay.c b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
index 3618ac6b6316..514a3055903c 100644
--- a/drivers/gpu/drm/nouveau/dispnv04/overlay.c
+++ b/drivers/gpu/drm/nouveau/dispnv04/overlay.c
@@ -99,10 +99,17 @@ nv10_update_plane(struct drm_plane *plane, struct drm_crtc *crtc,
 	struct nouveau_crtc *nv_crtc = nouveau_crtc(crtc);
 	struct nouveau_bo *cur = nv_plane-&gt;cur;
 	bool flip = nv_plane-&gt;flip;
-	int format = ALIGN(src_w * 4, 0x100);
 	int soff = NV_PCRTC0_SIZE * nv_crtc-&gt;index;
 	int soff2 = NV_PCRTC0_SIZE * !nv_crtc-&gt;index;
-	int ret;
+	int format, ret;
+
+	/* Source parameters given in 16.16 fixed point, ignore fractional. */
+	src_x &gt;&gt;= 16;
+	src_y &gt;&gt;= 16;
+	src_w &gt;&gt;= 16;
+	src_h &gt;&gt;= 16;
+
+	format = ALIGN(src_w * 4, 0x100);
 
 	if (format &gt; 0xffff)
 		return -EINVAL;
@@ -113,12 +120,6 @@ nv10_update_plane(struct drm_plane *plane, struct drm_crtc *crtc,
 
 	nv_plane-&gt;cur = nv_fb-&gt;nvbo;
 
-	/* Source parameters given in 16.16 fixed point, ignore fractional. */
-	src_x = src_x &gt;&gt; 16;
-	src_y = src_y &gt;&gt; 16;
-	src_w = src_w &gt;&gt; 16;
-	src_h = src_h &gt;&gt; 16;
-
 	nv_mask(dev, NV_PCRTC_ENGINE_CTRL + soff, NV_CRTC_FSEL_OVERLAY, NV_CRTC_FSEL_OVERLAY);
 	nv_mask(dev, NV_PCRTC_ENGINE_CTRL + soff2, NV_CRTC_FSEL_OVERLAY, 0);
 </pre>
    <div class="pagination">
        <a href='1_143.html'>&lt;&lt;Prev</a><a href='1.html'>1</a><a href='1_2.html'>2</a><a href='1_3.html'>3</a><a href='1_4.html'>4</a><a href='1_5.html'>5</a><a href='1_6.html'>6</a><a href='1_7.html'>7</a><a href='1_8.html'>8</a><a href='1_9.html'>9</a><a href='1_10.html'>10</a><a href='1_11.html'>11</a><a href='1_12.html'>12</a><a href='1_13.html'>13</a><a href='1_14.html'>14</a><a href='1_15.html'>15</a><a href='1_16.html'>16</a><a href='1_17.html'>17</a><a href='1_18.html'>18</a><a href='1_19.html'>19</a><a href='1_20.html'>20</a><a href='1_21.html'>21</a><a href='1_22.html'>22</a><a href='1_23.html'>23</a><a href='1_24.html'>24</a><a href='1_25.html'>25</a><a href='1_26.html'>26</a><a href='1_27.html'>27</a><a href='1_28.html'>28</a><a href='1_29.html'>29</a><a href='1_30.html'>30</a><a href='1_31.html'>31</a><a href='1_32.html'>32</a><a href='1_33.html'>33</a><a href='1_34.html'>34</a><a href='1_35.html'>35</a><a href='1_36.html'>36</a><a href='1_37.html'>37</a><a href='1_38.html'>38</a><a href='1_39.html'>39</a><a href='1_40.html'>40</a><a href='1_41.html'>41</a><a href='1_42.html'>42</a><a href='1_43.html'>43</a><a href='1_44.html'>44</a><a href='1_45.html'>45</a><a href='1_46.html'>46</a><a href='1_47.html'>47</a><a href='1_48.html'>48</a><a href='1_49.html'>49</a><a href='1_50.html'>50</a><a href='1_51.html'>51</a><a href='1_52.html'>52</a><a href='1_53.html'>53</a><a href='1_54.html'>54</a><a href='1_55.html'>55</a><a href='1_56.html'>56</a><a href='1_57.html'>57</a><a href='1_58.html'>58</a><a href='1_59.html'>59</a><a href='1_60.html'>60</a><a href='1_61.html'>61</a><a href='1_62.html'>62</a><a href='1_63.html'>63</a><a href='1_64.html'>64</a><a href='1_65.html'>65</a><a href='1_66.html'>66</a><a href='1_67.html'>67</a><a href='1_68.html'>68</a><a href='1_69.html'>69</a><a href='1_70.html'>70</a><a href='1_71.html'>71</a><a href='1_72.html'>72</a><a href='1_73.html'>73</a><a href='1_74.html'>74</a><a href='1_75.html'>75</a><a href='1_76.html'>76</a><a href='1_77.html'>77</a><a href='1_78.html'>78</a><a href='1_79.html'>79</a><a href='1_80.html'>80</a><a href='1_81.html'>81</a><a href='1_82.html'>82</a><a href='1_83.html'>83</a><a href='1_84.html'>84</a><a href='1_85.html'>85</a><a href='1_86.html'>86</a><a href='1_87.html'>87</a><a href='1_88.html'>88</a><a href='1_89.html'>89</a><a href='1_90.html'>90</a><a href='1_91.html'>91</a><a href='1_92.html'>92</a><a href='1_93.html'>93</a><a href='1_94.html'>94</a><a href='1_95.html'>95</a><a href='1_96.html'>96</a><a href='1_97.html'>97</a><a href='1_98.html'>98</a><a href='1_99.html'>99</a><a href='1_100.html'>100</a><a href='1_101.html'>101</a><a href='1_102.html'>102</a><a href='1_103.html'>103</a><a href='1_104.html'>104</a><a href='1_105.html'>105</a><a href='1_106.html'>106</a><a href='1_107.html'>107</a><a href='1_108.html'>108</a><a href='1_109.html'>109</a><a href='1_110.html'>110</a><a href='1_111.html'>111</a><a href='1_112.html'>112</a><a href='1_113.html'>113</a><a href='1_114.html'>114</a><a href='1_115.html'>115</a><a href='1_116.html'>116</a><a href='1_117.html'>117</a><a href='1_118.html'>118</a><a href='1_119.html'>119</a><a href='1_120.html'>120</a><a href='1_121.html'>121</a><a href='1_122.html'>122</a><a href='1_123.html'>123</a><a href='1_124.html'>124</a><a href='1_125.html'>125</a><a href='1_126.html'>126</a><a href='1_127.html'>127</a><a href='1_128.html'>128</a><a href='1_129.html'>129</a><a href='1_130.html'>130</a><a href='1_131.html'>131</a><a href='1_132.html'>132</a><a href='1_133.html'>133</a><a href='1_134.html'>134</a><a href='1_135.html'>135</a><a href='1_136.html'>136</a><a href='1_137.html'>137</a><a href='1_138.html'>138</a><a href='1_139.html'>139</a><a href='1_140.html'>140</a><a href='1_141.html'>141</a><a href='1_142.html'>142</a><a href='1_143.html'>143</a><span>[144]</span><a href='1_145.html'>145</a><a href='1_146.html'>146</a><a href='1_147.html'>147</a><a href='1_148.html'>148</a><a href='1_149.html'>149</a><a href='1_150.html'>150</a><a href='1_151.html'>151</a><a href='1_152.html'>152</a><a href='1_153.html'>153</a><a href='1_154.html'>154</a><a href='1_145.html'>Next&gt;&gt;</a>
    <div>
</body>
